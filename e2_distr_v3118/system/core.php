<?php $stopwatch=microtime(); define('IGNORE_VERSION_MISMATCH',false); define('E2_VERSION',3118); define('E2_RELEASE','2.6'); define('E2_UA_STRING','E2 (v'. E2_VERSION .'; Aegea)'); define('E2_MINIMUM_PHP','5.3.9'); header('X-Powered-By: E2 Aegea v'. E2_VERSION); if(version_compare(PHP_VERSION,E2_MINIMUM_PHP) < 0){ die ('PHP version must be '. E2_MINIMUM_PHP .' or later, you are running '. PHP_VERSION); } define('OUTPUT_CHARSET','UTF-8'); setlocale(LC_CTYPE,'ru_RU.UTF'); mb_internal_encoding('UTF-8'); define('HSC_ENC','UTF-8'); if(function_exists('date_default_timezone_set'))date_default_timezone_set('GMT'); error_reporting(E_ALL); define('RUN_ID',chr(rand(65,90))); define('DEV_TRACK_TIME',false); define('DEV_HOST','e2'); define('SECONDS_IN_A_MINUTE',60); define('SECONDS_IN_AN_HOUR',3600); define('SECONDS_IN_A_DAY',86400); define('SECONDS_IN_A_MONTH',2592000); define('SECONDS_IN_A_YEAR',31536000); define('YEAR_DISPLAY_THRESH',7884000); define('KILO_THRESH',768); define('BYTES_DECIMALS',1); define('FILE_READ_BUFFER',64*1024); define('KEYWORDS_MANY_THRESH',50); if(defined('JSON_PRETTY_PRINT')) { define('E2_JSON_STYLE',JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE); } else { define('E2_JSON_STYLE',0); } define('SCALE_FACTOR_THRESH',0.75); define('NEW_FILES_RIGHTS',0777); if(is_file('multiuser')) { define('USER_MODE','multi'); } else { define('USER_MODE','single'); } if(is_file('superconfig.php')) { include 'superconfig.php'; } $_protocol=( !empty ($_SERVER['HTTPS']) && $_SERVER['HTTPS']!=='off' or $_SERVER['SERVER_PORT']==443 or isset ($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO']=='https' or isset ($_SERVER['HTTP_X_HTTPS']) && ($_SERVER['HTTP_X_HTTPS']) ) ? 'https':'http'; if(is_file('force-https')) { $_protocol='https'; } $aa57c1=substr( $_SERVER['PHP_SELF'],0,strpos($_SERVER['PHP_SELF'],'/index.php') ); list ($r57de2, ) = explode(':',$_SERVER['HTTP_HOST']); $full_blog_url=$_protocol. '://'. $r57de2.$aa57c1; $_user_folder_name=str_replace('/','--',$r57de2.$aa57c1); if(substr($_user_folder_name,0,4)=='www.'){ $_user_folder_name=substr($_user_folder_name,4); } if(USER_MODE=='multi'){ if(array_key_exists($_user_folder_name,$_superconfig['rewrites'])) { $_user_folder_name=$_superconfig['rewrites'][$_user_folder_name]; } define('USER_FOLDER','users/'. $_user_folder_name .'/'); } else { define('USER_FOLDER', @$__E2_FOLDER_PREFIX__.'user/'); } define('EXTRAS_FOLDER',USER_FOLDER.'extras/'); define('BACKUP_FOLDER',USER_FOLDER.'backup/'); define('CACHES_FOLDER',USER_FOLDER.'caches/'); define('USER_LIBRARY_FOLDER',USER_FOLDER.'library/'); define('LOG_FILE',USER_FOLDER.'log.txt'); define('TEMPLATES_FOLDER','themes/'); define('PICTURES_FOLDER','pictures/'); define('AUDIO_FOLDER','audio/'); define('THUMBNAILS_FOLDER','pictures/thumbs/'); define('SYSTEM_FOLDER','system/'); define('SCRIPTS_FOLDER','system/js/'); define('SYSTEM_LIBRARY_FOLDER','system/library/'); define('SYSTEM_TEMPLATE_FOLDER','system/theme/'); define('DEFAULT_USERPIC_FILENAME','system/theme/images/userpic.svg'); define('DEFAULT_USERPIC_PLACEHOLDER_FILENAME','system/theme/images/userpic-placeholder.svg'); define('AUDIO_ICON_IMAGE','system/theme/images/audio.svg'); define('AUDIO_ICON_WIDTH',64); define('AUDIO_ICON_HEIGHT',64); define('LANGUAGES_FOLDER','system/languages/'); define('DEFAULTS_FOLDER','system/default/'); define('MTMPL_FOLDER','system/default/mail/'); define('DEFAULT_TEMPLATE','plain'); if(substr(@$_SERVER['HTTP_ACCEPT_LANGUAGE'],0,2)=='ru'){ define('DEFAULT_LANGUAGE','ru'); } else { define('DEFAULT_LANGUAGE','en'); } @include DEFAULTS_FOLDER. 'config.php'; $_default_config=$_config; @include USER_FOLDER. 'config.php'; $_config=array_merge($_default_config,$_config); if( $_config['write_log'] and ($_config['write_log_create'] or is_file(LOG_FILE)) )define('__LOG',1); else define('__LOG',0); if(@$_config['write_log_limit'] and is_file(LOG_FILE)) { $tbc7b3=@stat(LOG_FILE); $tbc7b3=$tbc7b3['size']; if ($tbc7b3 > $_config['write_log_limit']) { @rename(LOG_FILE,LOG_FILE .'.bak'); @chmod(LOG_FILE .'.bak',NEW_FILES_RIGHTS); @file_put_contents(LOG_FILE,''); } } define('CACHE',true); define('CACHE_NOTES',CACHE and true); define('CACHE_NOTES_COMMENTS',CACHE and true); define('CACHE_POPULAR',CACHE and true); define('CACHE_HOT',CACHE and true); define('CACHE_FAVS',CACHE and true); define('CACHE_TAGS',CACHE and true); define('CACHE_FAVTAGS',CACHE and true); define('CACHE_NOTES_COUNTS',CACHE and true); define('CACHE_EDGE_TIMEINFO',CACHE and true); define('CACHE_FRONTPAGE',CACHE and true); define('CACHE_FRONTPAGE_RSS',CACHE and true); define('CACHE_FULLLIST',CACHE and true); define('CACHE_DRAFTS',CACHE and true); define('CACHE_DRAFTS_ALIAS_USE_COUNTS',CACHE and true); define('CACHE_LASTMODIFIEDS',CACHE and true); define('CACHE_FILENAMES_NOTES',CACHES_FOLDER.'note-*.ctree.psa'); define('CACHE_FILENAMES_NOTES_COMMENTS', CACHES_FOLDER.'note-*-comments.ctree.psa' ); define('CACHE_FILENAMES_NOTES_COUNTS',CACHES_FOLDER.'notes-count-*.txt'); define('CACHE_FILENAMES_EDGE_TIMEINFO',CACHES_FOLDER.'*.e2time.psa'); define('CACHE_FILENAME_POPULAR',CACHES_FOLDER.'popular.ctree.psa'); define('CACHE_FILENAME_POPULAR_EXPIRES',CACHES_FOLDER.'popular-expires.txt'); define('CACHE_FILENAME_HOT',CACHES_FOLDER.'hot.ctree.psa'); define('CACHE_FILENAME_HOT_EXPIRES',CACHES_FOLDER.'hot-expires.txt'); define('CACHE_FILENAME_FAVS',CACHES_FOLDER.'favourites.ctree.psa'); define('CACHE_FILENAME_TAGS',CACHES_FOLDER.'tags.ctree.psa'); define('CACHE_FILENAME_TAGS_AUTHOR',CACHES_FOLDER.'tags-author.ctree.psa'); define('CACHE_FILENAME_FAVTAGS',CACHES_FOLDER.'favtags.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE',CACHES_FOLDER.'frontpage.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_AUTHOR',CACHES_FOLDER.'frontpage-author.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_RSS',CACHES_FOLDER.'frontpage-rss.psa'); define('CACHE_FILENAME_FULLLIST',CACHES_FOLDER.'notes-list.ctree.psa'); define('CACHE_FILENAME_DRAFTS',CACHES_FOLDER.'drafts.psa'); define('CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS',CACHES_FOLDER.'drafts-auc.psa'); define('CACHE_FILENAME_LASTMODIFIEDS',CACHES_FOLDER.'last-modifieds-by-id.psa'); define('E2E_STRANGE_ERROR',10); define('E2E_USER_ERROR',20); define('E2E_PERMISSIONS_ERROR',30); define('E2E_DATABASE_ERROR',40); define('E2E_MESSAGE',100); define('E2E_DIAGNOSTICS_MESSAGE',110); define('IMPORT_DB_SETTINGS',true); define('DB_PASSWORD_RECOVER_AND_SHOW',false); define('DEFAULT_ITEMS_PER_PAGE',10); define('MAX_ITEMS_PER_PAGE',100); define('DB_OK',0); define('DB_CANNOT_FIND', -1); define('DB_CANNOT_CONNECT', -2); define('DB_DB_QUERY_ERROR', -3); define('FP_NO_ID_OR_NEW', -1); define('FP_INSERT_ERROR', -10); define('FP_UPDATE_ERROR', -11); define('FP_EMPTY_FIELD', -20); define('FP_TITLE_OR_TEXT_EMPTY', -21); define('FP_NOT_COMMENTABLE', -30); define('FP_COMMENT_DOUBLE_POST', -101); define('FP_COMMENT_TOO_LONG', -102); define('FP_COMMENT_SPAM_SUSPECT', -103); define('NOTE_COMMENTABLE_NOW', -1); define('NOTE_COMMENTABLE_NOW_CONDITIONALLY', -2); define('ENTITY_TYPE_UNSPECIFIED',''); define('ENTITY_TYPE_NOTE','n'); define('ENTITY_TYPE_TAG','t'); define('THUMB_WIDTH',200); define('THUMB_HEIGHT',160); define('THUMB_JPG_QUALITY',90); define('SCALED_IMAGE_JPG_QUALITY',80); define('USERPIC_WIDTH',80); define('USERPIC_HEIGHT',80); define('USERPIC_JPG_QUALITY',90); define('RESOURCES_ALL',0); define('RESOURCES_LOCAL',1); $f5269f=@$_SERVER['HTTP_USER_AGENT'] or $f5269f=''; $_ios=strstr($f5269f,'iPhone') || strstr($f5269f,'iPad'); $_macintosh=strstr($f5269f,'Macintosh'); error_reporting(E_ALL); $_db_error=false; $_fp_error=false; $t589b3=true; if(strstr(__FILE__,'all.php'))$t589b3=false; function __log($j1cb25,$lc9e9a=0){ global$stopwatch,$_log_depth; if ($j1cb25===null){ if(function_exists('file_put_contents')) { @file_put_contents(LOG_FILE,''); @chmod(LOG_FILE,NEW_FILES_RIGHTS); } return; } $m605ac=''; $xaf240=str_pad(round(u7f78()-$stopwatch,5),10,' ',STR_PAD_RIGHT); if ($j1cb25[0]=='}'){ -- $_log_depth; if($_log_depth < 0)$_log_depth=0; } $c8e13f=( RUN_ID .' '. $m605ac .''. $xaf240 .' '. str_repeat(' ',$_log_depth*2). $j1cb25."\n" ); if ($j1cb25[strlen($j1cb25)-1]=='{'){ ++ $_log_depth; } $t15d61=FILE_APPEND; if(function_exists('file_put_contents')) { @file_put_contents(LOG_FILE,$c8e13f,$t15d61); @chmod(LOG_FILE,NEW_FILES_RIGHTS); } } function e2_go_to($k56790=''){ global$_protocol,$errors,$r57de2,$aa57c1; @session_start(); $_SESSION['errors']=$errors; if(substr($k56790,0,strlen($_protocol)+3)!=$_protocol .'://'){ header('Location: '. $_protocol .'://'. $r57de2.$aa57c1 .'/'. $k56790); } else { header('Location: '. $k56790); } flush(); return true; } function d4930(){ $r469bb=$_SERVER['HTTP_REFERER']; return e2_go_to($r469bb); } function b4924($k56790){ if($_SERVER['HTTP_REFERER'])$k56790=$_SERVER['HTTP_REFERER']; return e2_go_to($k56790); } function c8c3b($tb2145=''){ $l9dd4e=substr_count($_SERVER['HTTP_HOST'],'.'); $a2cb9d=@str_repeat('_',$l9dd4e).$tb2145; return $a2cb9d; } function uc64a($tb2145,$n2063c='',$eb0b70=true){ $icd91e=$eb0b70? (time()+3600*24*365) : (0); $pad5f8=$_SERVER['HTTP_HOST']; $ie9c6c=substr_count($pad5f8,'.'); if ($ie9c6c < 3)$pad5f8=str_repeat('.',3-$ie9c6c).$pad5f8; $l9dd4e=setcookie(c8c3b($tb2145),$n2063c,$icd91e,'/'); } function t163d($m183d6,$vb45cf,$bcadc8=''){ if(trim($vb45cf)!=''){ $vb45cf=explode($m183d6,$vb45cf); foreach ($vb45cf as $y865c0 => $d8ce4b)$vb45cf[$y865c0]=trim($d8ce4b); foreach ($vb45cf as $y865c0 => $d8ce4b) if ($d8ce4b=='') unset ($vb45cf[$y865c0]); $h7b774=array_unique($vb45cf); if ('sort'==$bcadc8)sort($h7b774); return $h7b774; } else return array (); } function le1e7($tcdaee,$action,$g4a202){ if (!is_array($tcdaee))$tcdaee=array(); if($action=='add'){ $tcdaee=array_unique(array_merge($tcdaee,$g4a202)); } if($action=='remove'){ unset ($tcdaee[array_search($g4a202,$tcdaee)]); } return $tcdaee; } function hbb8d($vb45cf){ global$_macintosh,$_ios; if($_ios) return ''; if ($vb45cf=='submit'){ if($_macintosh){ return '&#x2303; &#x21a9;'; } else { return 'Ctrl + Enter'; } } if ($vb45cf=='livesave'){ if($_macintosh){ return '&#x2318; S'; } else { return 'Ctrl + S'; } } if ($vb45cf=='navigation'){ if($_macintosh){ return '&#x2325;'; } else { return 'Ctrl'; } } if ($vb45cf=='navigation-later'){ if($_macintosh){ return '&#x2325; &uarr;'; } else { return 'Ctrl + &uarr;'; } } if ($vb45cf=='navigation-earlier'){ if($_macintosh){ return '&#x2325; &darr;'; } else { return 'Ctrl + &darr;'; } } } function g7b91($j1cb25){ $j1cb25=str_replace('<','&lt;',$j1cb25); $j1cb25=str_replace('>','&gt;',$j1cb25); return $j1cb25; } function gc4b6($j1cb25){ $j1cb25=str_replace('"','&quot;',$j1cb25); return $j1cb25; } function wd056($n2063c,$u5d6db){ return str_replace('.',',',round($n2063c,$u5d6db)); } function e2_stripslashes_array($ff1f71){ return is_array($ff1f71)?array_map('e2_stripslashes_array',$ff1f71):stripslashes($ff1f71); } function r269a(){ if(get_magic_quotes_runtime()) { set_magic_quotes_runtime(0); } if(get_magic_quotes_gpc()) { $_GET=e2_stripslashes_array($_GET); $_POST=e2_stripslashes_array($_POST); $_COOKIE=e2_stripslashes_array($_COOKIE); $_REQUEST=e2_stripslashes_array($_REQUEST); } } function u0786($s957b5){ return sprintf('%u',ip2long($s957b5)); } function s7c85($tb1bc2){ return long2ip(sprintf('%d',$tb1bc2)); } function e2_decline_for_number($j1cb25,$tb1bc2=null){ $w2f713=$j1cb25; if ($tb1bc2===null){ $tb1bc2=substr($j1cb25,0,strpos($j1cb25,' ')); $w2f713=substr($j1cb25,strpos($j1cb25,' ')+1); } $zf07c9=strpos($w2f713,'('); $m46901=strpos($w2f713,')'); if ($m46901 > $zf07c9)$o22b9f=substr($w2f713,$zf07c9,$m46901-$zf07c9+1); $p93da6=explode(',',trim(@$o22b9f,'()')); if(count($p93da6)==2)array_unshift($p93da6,''); $ac78bd=array (2,0,1,1,1,2,2,2,2,2); if ($tb1bc2%100 > 10 and $tb1bc2%100 < 20)$gcd14c=2; else $gcd14c=$ac78bd[$tb1bc2%10]; $jef3e3=$p93da6[$gcd14c]; $j1cb25=str_replace($o22b9f,$jef3e3,$j1cb25); if(strstr($j1cb25,'(') and strstr($j1cb25,')')) { return e2_decline_for_number($j1cb25,$tb1bc2); } else { return $j1cb25; } } function bc5a6($ff2ce1){ $e87e9e=glob($ff2ce1,GLOB_NOSORT); if(is_array($e87e9e)) { foreach ($e87e9e as $v435ed){ @unlink($v435ed); } } } function l74dc($t73600){ $e87e9e=glob($t73600 .'*',GLOB_NOSORT); if(is_array($e87e9e)) { foreach ($e87e9e as $v435ed){ if(basename($v435ed)!='.' and basename($v435ed)!='..'){ if(is_dir($v435ed)) { if (l74dc($v435ed .'/')) { if (!rmdir($v435ed)) { return false; } } else { return false; } } else { @unlink($v435ed); } } } return true; } else { return false; } } function naf42($ad6fe1){ $ad6fe1=trim($ad6fe1,'/'); $ad6fe1=explode('/',$ad6fe1); $t73600=''; foreach ($ad6fe1 as $o83878){ $t73600=$t73600.$o83878; if (!is_dir($t73600)) { if (@mkdir($t73600)) { @chmod($t73600,NEW_FILES_RIGHTS); } else { return false; } } $t73600=$t73600.'/'; } return true; } function h4d36($ad6fe1){ return preg_replace('/\/([^\/]+?)\/\.\./','',$ad6fe1); } function ece9b($vb45cf){ $ncee6f=get_html_translation_table(HTML_ENTITIES); $ncee6f=array_flip($ncee6f); return strtr($vb45cf,$ncee6f); } function u7f78($q32c11=NULL){ if(NULL==$q32c11)$q32c11=microtime(); list ($b6021b,$g74459)=explode(' ',$q32c11); return ((float)$b6021b + (float)$g74459); } define('HEL_SPECIAL_CHAR',"\x1"); define('HEL_SPECIAL_SEQUENCE_LENGTH',6); function z4e85($o6a992){ return str_pad($o6a992,HEL_SPECIAL_SEQUENCE_LENGTH,'0',STR_PAD_LEFT); } function hel_savetag($de4d23){ global $b16234; $o6a992=count($b16234); $b16234[$o6a992]=$de4d23[0]; return HEL_SPECIAL_CHAR.z4e85($o6a992).HEL_SPECIAL_CHAR; } function sdae3($j1cb25){ global $b16234; if ($b16234){ foreach ($b16234 as $o6a992 => $n2063c){ $j1cb25=str_replace(HEL_SPECIAL_CHAR. z4e85($o6a992).HEL_SPECIAL_CHAR,$n2063c,$j1cb25); } } return $j1cb25; } $stopwatch=u7f78($stopwatch); function p3aa5($l9dd4e){ global$_e2utf8__unformat_htmlentity_neasden; if($_e2utf8__unformat_htmlentity_neasden){ return $l9dd4e; } else { return '((html '. $l9dd4e .'))'; } } function sedd9($ve98a6,$i98df3=false){ $b80a41=''; $hf5a8e=strlen($ve98a6); for ($y865c0=0; $y865c0 < 256; ++ $y865c0){ $uf3d13[$y865c0]=0; $c0fc3c=$y865c0; while ($c0fc3c & 0x00000080){ $c0fc3c <<= 1; ++ $uf3d13[$y865c0]; } } for ($y865c0=0xd090; $y865c0 <= 0xd0bf; $y865c0++)$h84a26[$y865c0]=chr(($y865c0 & 0x000000ff)+48); for ($y865c0=0xd180; $y865c0 <= 0xd18f; $y865c0++)$h84a26[$y865c0]=chr(($y865c0 & 0x000000ff)+112); $h84a26[0xd081]="\xa8"; $h84a26[0xd191]="\xb8"; $h84a26[0xc299]="\x99"; $h84a26[0xc2a9]="\xa9"; $h84a26[0xc2ae]="\xae"; $h84a26[0xc2ab]="\xab"; $h84a26[0xc2bb]="\xbb"; $h84a26[0xc2a0]="\xa0"; $y865c0=0; while ($y865c0 < $hf5a8e){ $cac558=$ve98a6{$y865c0}; $sc267c=ord($cac558); if ($uf3d13[$sc267c]==0){ $b80a41.=$cac558; ++ $y865c0; } elseif ($uf3d13[$sc267c]==2){ $w06214=$h84a26[($sc267c << 8) | ord($ve98a6{$y865c0+1})]; $b80a41 .= ($w06214!=null)? $w06214 : ( $i98df3? (p3aa5( uebe5(substr($ve98a6,$y865c0,2)) )) : '?' ); $y865c0+=2; } else { $ddfbc9=substr($ve98a6,$y865c0,$uf3d13[$sc267c]); if ($ddfbc9=="\xe2\x84\x96")$b80a41.="\xb9"; elseif ($ddfbc9=="\xe2\x80\x93")$b80a41.="\x96"; elseif ($ddfbc9=="\xe2\x80\x94")$b80a41.="\x97"; elseif ($ddfbc9=="\xe2\x80\x98")$b80a41.="\x91"; elseif ($ddfbc9=="\xe2\x80\x99")$b80a41.="\x92"; elseif ($ddfbc9=="\xe2\x80\x9a")$b80a41.="\x82"; elseif ($ddfbc9=="\xe2\x80\x9c")$b80a41.="\x93"; elseif ($ddfbc9=="\xe2\x80\x9d")$b80a41.="\x94"; elseif ($ddfbc9=="\xe2\x80\x9e")$b80a41.="\x84"; elseif ($ddfbc9=="\xe2\x80\xa6")$b80a41.="\x85"; elseif ($ddfbc9=="\xe2\x80\xb9")$b80a41.="\x8b"; elseif ($ddfbc9=="\xe2\x80\xba")$b80a41.="\x9b"; elseif ($ddfbc9=="\xe2\x82\xac")$b80a41.="\x88"; elseif ($ddfbc9=="\xe2\x84\xa2")$b80a41.="\x99"; else $b80a41.=$i98df3? (p3aa5( uebe5($ddfbc9) )) : '?'; $y865c0+=$uf3d13[$sc267c]; } } return $b80a41; } function uebe5($k4a8a0){ $ycc411=''; $hf5a8e=strlen($k4a8a0); for ($y865c0=0; $y865c0 < $hf5a8e; ++ $y865c0){ $ycc411.=preg_replace('/^1*0/','',decbin(ord($k4a8a0{$y865c0}))); } return '&#'. bindec($ycc411) .';'; } function afd97($i341be) { $a2cb9d=$i341be; $a2cb9d=preg_replace_callback('/([\x80-\xFF])/','e2_utf_from_windows_1251_char',$a2cb9d); return $a2cb9d; } function e2_utf_from_windows_1251_char($k4a8a0){ list (, $k4a8a0)=$k4a8a0; if ($k4a8a0=="\xa8") return "\xd0\x81"; if ($k4a8a0=="\xb8") return "\xd1\x91"; if ($k4a8a0 >= "\xc0" && $k4a8a0 <= "\xef") return "\xd0".chr(ord($k4a8a0)-48); if ($k4a8a0 >= "\xf0") return "\xd1".chr(ord($k4a8a0)-112); if ($k4a8a0=="\x85") return "\xe2\x80\xa6"; if ($k4a8a0=="\x96") return "\xe2\x80\x93"; if ($k4a8a0=="\x97") return "\xe2\x80\x94"; if ($k4a8a0=="\xab") return "\xc2\xab"; if ($k4a8a0=="\xbb") return "\xc2\xbb"; if ($k4a8a0=="\x91") return "\xe2\x80\x98"; if ($k4a8a0=="\x92") return "\xe2\x80\x99"; if ($k4a8a0=="\x93") return "\xe2\x80\x9c"; if ($k4a8a0=="\x94") return "\xe2\x80\x9d"; if ($k4a8a0=="\x84") return "\xe2\x80\x9e"; if ($k4a8a0=="\x99") return "\xe2\x84\xa2"; if ($k4a8a0=="\xb9") return "\xe2\x84\x96"; if ($k4a8a0=="\xa0") return "\xc2\xa0"; return '?'; }; function e2_utf8_version_of_array_($ff1f71){ foreach ($ff1f71 as $d8ce4b => $w9e366){ if (!array_key_exists($d8ce4b.'.u?',$ff1f71)) { if(is_string($ff1f71[$d8ce4b])) { $ff1f71[$d8ce4b]=afd97($ff1f71[$d8ce4b]); } elseif(is_array($ff1f71[$d8ce4b])) { $ff1f71[$d8ce4b]=e2_utf8_version_of_array_($ff1f71[$d8ce4b]); } } } return $ff1f71; } function vff7c($i341be){ return preg_replace('/[\x{10000}-\x{fffff}]/u','?',$i341be); } $_folders_written=array ( '.', USER_FOLDER, CACHES_FOLDER, BACKUP_FOLDER, PICTURES_FOLDER, THUMBNAILS_FOLDER, PICTURES_FOLDER .'remote/', THUMBNAILS_FOLDER .'remote/', AUDIO_FOLDER, ); $_files_written=array ( USER_FOLDER.'password-hash.psa', USER_FOLDER.'password-wait.psa', USER_FOLDER.'last-comment.psa', USER_FOLDER.'new-uploads.psa', USER_FOLDER.'settings.json', USER_FOLDER.'indexing.psa', USER_FOLDER.'auth.psa', USER_FOLDER.'log.txt', ); define('CROP_NONE',0); define('CROP_SQUARE',1); define('PROVIDE_DATA_SPAWN',10); define('PROVIDE_DATA_NOW',20); function xea70(){ global$_folders_written,$_files_written; clearstatcache(); $y10ae9=array(); foreach($_folders_written as $c8fa14){ if(is_dir($c8fa14) and !is_writable($c8fa14)) { $y10ae9[] = $c8fa14; } } foreach($_files_written as $c8fa14){ if(is_file($c8fa14) and !is_writable($c8fa14)) { $y10ae9[] = $c8fa14; } } return $y10ae9; } function d6e52($j8c7dd,$vb45cf){ if (!@file_put_contents($j8c7dd,$vb45cf,LOCK_EX)) { return false; } @chmod($j8c7dd,NEW_FILES_RIGHTS); return true; } function v25cb($v435ed,$n3dbb8){ if ($n3dbb8){ $x80127=explode('/',$v435ed); $m954eb=array_pop($x80127); $l35b88=explode('.',$m954eb); if(count($l35b88) < 2)$l35b88[] = ''; $tabf77=array_pop($l35b88); $l35b88[] = $n3dbb8; if ($tabf77)$l35b88[] = $tabf77; $m954eb=implode('.',$l35b88); $x80127[] = $m954eb; $v435ed=implode('/',$x80127); } return $v435ed; } function p291d($v435ed,$q6890f=false){ $jd1789=array ( 'w' => THUMB_WIDTH, 'h' => THUMB_HEIGHT, 'q' => THUMB_JPG_QUALITY ); if(preg_match('/^https?\:\/\//iu',$v435ed)) { $xaf721=$v435ed; $x6efa1=$v435ed; $x6efa1=preg_replace('/^https?\:\/\//iu','',$x6efa1); $x6efa1=str_replace('/','--',$x6efa1); $x6efa1=THUMBNAILS_FOLDER.$x6efa1; } else { $xaf721=PICTURES_FOLDER.$v435ed; $x6efa1=THUMBNAILS_FOLDER.$v435ed; } $x6efa1=v25cb($x6efa1,'thumb@2x'); return g8611( $xaf721, $x6efa1, $jd1789, CROP_NONE, $q6890f ); } function q30f2($xaf721){ $f8743c=pathinfo($xaf721); $tabf77=$f8743c['extension']; return (in_array(strtolower($tabf77), array ('jpg','jpeg','gif','png','svg'))); } function xb6c5($xaf721){ $f8743c=pathinfo($xaf721); $tabf77=$f8743c['extension']; return (in_array(strtolower($tabf77), array ('jpg','jpeg','gif','png'))); } function lef67($xaf721){ $f8743c=pathinfo($xaf721); $tabf77=$f8743c['extension']; if ($tabf77=='png') return IMAGETYPE_PNG; if ($tabf77=='gif') return IMAGETYPE_GIF; if ($tabf77=='jpg' or $tabf77=='jpeg') return IMAGETYPE_JPEG; } function l19a4($v435ed){ if (xb6c5($v435ed)) { list ($meaae2,$ab435e)=getimagesize($v435ed); } else { $pe2da9=simplexml_load_string(file_get_contents($v435ed)); if ($pe2da9){ $jd0a5e=$pe2da9->attributes(); list ($meaae2,$ab435e) = array ((string)$jd0a5e -> width, (string)$jd0a5e -> height); } else { return false; } } if(substr($v435ed,strrpos($v435ed,'.')-3,3)=='@2x'){ $meaae2=(int)floor($meaae2/2); $ab435e=(int)floor($ab435e/2); } return array ($meaae2,$ab435e); } function e2s_retrieve($parameters){ $y36cd3=urldecode(base64_decode($parameters['source'])); if(__LOG)__log('Retrieve: '. $y36cd3); h1066($y36cd3,PROVIDE_DATA_NOW); } function hbcd0($y447b7){ global$full_blog_url; $z78f08=parse_url($y447b7); if (isset ($z78f08['scheme'])) { if (q30f2($z78f08['path'])) { return array ( 'type' => 'remote-image', 'is-local?' => false, ); } elseif ($z78f08['host']=='www.youtube.com'){ $cb80bb=basename($z78f08['path']); $e15ba8='remote/youtube-'. $cb80bb .'-cover.jpg'; return array ( 'type' => 'online-video', 'is-local?' => false, 'video-service' => 'youtube', 'video-id' => $cb80bb, 'local-cover-name' => $e15ba8, 'local-cover-href' => $full_blog_url .'/'. PICTURES_FOLDER.$e15ba8, 'local-full-filename' => PICTURES_FOLDER.$e15ba8, 'local-full-failname' => PICTURES_FOLDER.$e15ba8.'.failed', ); } elseif ($z78f08['host']=='player.vimeo.com'){ $cb80bb=basename($z78f08['path']); $e15ba8='remote/vimeo-'. $cb80bb .'-cover.jpg'; return array ( 'type' => 'online-video', 'is-local?' => false, 'video-service' => 'vimeo', 'video-id' => $cb80bb, 'local-cover-name' => $e15ba8, 'local-cover-href' => $full_blog_url .'/'. PICTURES_FOLDER.$e15ba8, 'local-full-filename' => PICTURES_FOLDER.$e15ba8, 'local-full-failname' => PICTURES_FOLDER.$e15ba8.'.failed', ); } } else { if (q30f2($z78f08['path'])) { return array ( 'type' => 'local-image', 'is-local?' => true, 'local-href' => $full_blog_url .'/'. PICTURES_FOLDER.$z78f08['path'], 'local-full-filename' => PICTURES_FOLDER.$z78f08['path'] ); } else { return array ( 'type' => 'local-non-image', 'is-local?' => true, ); } } } function h1066($y447b7,$ldb88a){ $c1c149=hbcd0($y447b7); if ($c1c149['type']=='remote-image'){ } elseif ($c1c149['type']=='online-video'){ if(is_file($c1c149['local-full-filename'])) { if(__LOG)__log('Already exists: '. $c1c149['local-full-filename']); } elseif(is_file($c1c149['local-full-failname'])) { if(__LOG)__log('Already tried and failed: '. $c1c149['local-full-filename']); } else { if(__LOG)__log($y447b7.' is missing a cover, retrieving'); if ($ldb88a==PROVIDE_DATA_SPAWN){ ecc38(e83c8('e2s_retrieve', array ( 'source' => urlencode(base64_encode($y447b7)), ))); } if ($ldb88a==PROVIDE_DATA_NOW){ if ($c1c149['video-service']=='youtube') { $w5f89d=array ( 'maxresdefault','hqdefault','mqdefault','sddefault','default' ); foreach ($w5f89d as $hd7d16){ $a572d4='http://img.youtube.com/vi/'. $c1c149['video-id'] .'/'. $hd7d16 .'.jpg'; if(__LOG)__log('Getting '.$a572d4 .' as '. $c1c149['local-full-filename']); $f6c43d=file_get_contents($a572d4); if ($f6c43d!==false) break; } } if ($c1c149['video-service']=='vimeo') { $qc4a72=unserialize( file_get_contents('http://vimeo.com/api/v2/video/'. $c1c149['video-id'] .'.php') ); if (isset ($qc4a72[0]['thumbnail_large'])) { $f6c43d=file_get_contents($qc4a72[0]['thumbnail_large']); } } if ($f6c43d!==false){ d6e52($c1c149['local-full-filename'],$f6c43d); } else { d6e52($c1c149['local-full-failname'],''); } } } if ($ldb88a==PROVIDE_DATA_NOW){ if(is_file($c1c149['local-full-filename'])) { p291d($c1c149['local-cover-name']); } } } elseif ($c1c149['type']=='local-image'){ if(__LOG)__log($y447b7.' is a local image'); p291d($y447b7); } elseif ($c1c149['type']=='local-non-image'){ if(__LOG)__log($y447b7.' is a local non-image'); } } function q6be4($y10ae9){ if (!is_array($y10ae9)) return; if(__LOG)__log('Provide data for resources {'); foreach ($y10ae9 as $y447b7){ h1066($y447b7,PROVIDE_DATA_SPAWN); } if(__LOG)__log('}'); } function df898($e89111,$vdffc4,$je449c){ $k5128f=tfb75($e89111,$vdffc4); $i55b55=array_merge($k5128f,$je449c); $i55b55=array_reverse($i55b55); $i55b55=array_unique($i55b55); $i55b55=array_reverse($i55b55); return v2e82($i55b55,RESOURCES_LOCAL); } function efc4d($gd430b,$l2bfe4){ $e84841=array(); if(is_array($l2bfe4['meta']['resources-detected'])) { $je449c=$l2bfe4['meta']['resources-detected']; $e84841=mdc5a($je449c); } $p16137=@unserialize( $gd430b['Uploads'] ) or $p16137=array(); $u08204=array_diff($e84841,$p16137); v4ae9('note',$gd430b['ID'],'add',$u08204); return $u08204; } function mdc5a($sd7f81){ $y10ae9=array(); foreach ($sd7f81 as $t1993e){ $c1c149=hbcd0($t1993e); if ($c1c149['is-local?'])$y10ae9[] = $t1993e; } return $y10ae9; } function v2e82($i55b55,$j8b7af=RESOURCES_ALL){ global$full_blog_url; $nef067=array(); $y59b51=array(); if (!is_array($i55b55)) return $y59b51; q6be4($i55b55); foreach ($i55b55 as $l96ab4){ $c1c149=hbcd0($l96ab4); if ($j8b7af==RESOURCES_LOCAL and !$c1c149['is-local?']) continue; if ($c1c149['type']=='remote-image'){ } elseif ($c1c149['type']=='online-video'){ if ($qf1210=p291d($c1c149['local-cover-name'])) { $size=l19a4($qf1210); list ($meaae2,$ab435e)=$size; if (!in_array($l96ab4,$nef067)) { $nef067[] = $l96ab4; $y59b51[] = array ( 'original-filename' => $l96ab4, 'href' => $full_blog_url .'/'. $qf1210, 'width' => $meaae2, 'height' => $ab435e, ); } } } elseif ($c1c149['type']=='local-image'){ if ($qf1210=p291d($l96ab4)) { $size=l19a4($qf1210); list ($meaae2,$ab435e)=$size; if (!in_array($l96ab4,$nef067)) { $nef067[] = $l96ab4; $y59b51[] = array ( 'original-filename' => $l96ab4, 'href' => $full_blog_url .'/'. $qf1210, 'width' => $meaae2, 'height' => $ab435e, ); } } } elseif ($c1c149['type']=='local-non-image'){ if(is_file(AUDIO_FOLDER.$l96ab4)) { if (!in_array($l96ab4,$nef067)) { $nef067[] = $l96ab4; $y59b51[] = array ( 'original-filename' => $l96ab4, 'href' => $full_blog_url .'/'. AUDIO_ICON_IMAGE, 'width' => AUDIO_ICON_WIDTH, 'height' => AUDIO_ICON_HEIGHT, ); } } } } return $y59b51; } function xdbcc($e89111,$vdffc4,$i55b55){ global$full_blog_url; $y10ae9=array(); if(is_array($i55b55)) { $y10ae9=e2files__list_og_images_for_resources_($i55b55); } $k5128f=tfb75($e89111,$vdffc4); if(is_array($k5128f)) { foreach ($k5128f as $d8ce4b => $w9e366){ if(is_file(PICTURES_FOLDER.$w9e366)) { $k5128f[$d8ce4b]=$full_blog_url .'/'. PICTURES_FOLDER.$w9e366; } else { unset ($k5128f[$d8ce4b]); } } $y10ae9=array_merge($k5128f,$y10ae9); } $y10ae9=array_reverse($y10ae9); $y10ae9=array_unique($y10ae9); $y10ae9=array_reverse($y10ae9); return $y10ae9; } function e2files__list_og_images_for_resources_($i55b55){ $y59b51=array(); q6be4($i55b55); foreach ($i55b55 as $l96ab4){ $c1c149=hbcd0($l96ab4); if ($c1c149['type']=='remote-image'){ } elseif ($c1c149['type']=='online-video'){ if(is_file($c1c149['local-full-filename'])) { $y59b51[] = $c1c149['local-cover-href']; } } elseif ($c1c149['type']=='local-image'){ if(is_file($c1c149['local-full-filename'])) { $y59b51[] = $c1c149['local-href']; } } elseif ($c1c149['type']=='local-non-image'){ } } return $y59b51; } function g8611($xaf721,$x6efa1,$z93a57,$icff96,$q6890f){ global$_config; if(__LOG)__log('Scale image: <'. $xaf721 .'>'); if ($q6890f){ if(__LOG)__log('Scale image: recreate requested'); } $n7ae08=pathinfo($x6efa1); if(__LOG)__log('Scale image: source_name <'. $xaf721 .'>'); if(__LOG)__log('Scale image: dest_name <'. $x6efa1 .'>'); if(is_file($xaf721)) { if (xb6c5($xaf721)) { if ($z93a57['h'] == -1)$z93a57['h']=999999; if (!is_file($x6efa1) or $q6890f){ if (@naf42($n7ae08['dirname'])) { p6b7f( $xaf721, $z93a57['w'],$z93a57['h'],$z93a57['q'], $x6efa1, $icff96 ); if(is_file($x6efa1)) { if(__LOG)__log('Scale image: done'); chmod($x6efa1,$_config['uploaded_files_mode']); } else { if(__LOG)__log('Scale image: error'); return false; } } else { if(__LOG)__log('Scale image: couldn’t create directory <'. $n7ae08['dirname'] .'>'); } } else { if(__LOG)__log('Scale image: already exists'); } return $x6efa1; } else { if(__LOG)__log('Scale image: SVG, no need to make thumbnail'); return $xaf721; } } return false; } function h9c0a($db0689,$a12e09){ if(preg_match('//u',$db0689))$db0689=sedd9($db0689,false); if ($a12e09=='image'){ $t85114=PICTURES_FOLDER; } elseif ($a12e09=='audio'){ $t85114=AUDIO_FOLDER; } else { return false; } $p96704=''; for ($y865c0=0; $y865c0 < strlen($db0689); $y865c0++) { if ($db0689[$y865c0]=='?'){ $p96704.=''; } elseif ($db0689[$y865c0]==' '){ $p96704.='-'; } elseif(ord($db0689[$y865c0]) <= 127){ $p96704.=$db0689[$y865c0]; } } if ($p96704=='')$p96704=$a12e09; if ($p96704[0]=='.')$p96704=$a12e09.$p96704; return $p96704; } function nf0fb($j76ee3){ global$_config; if(__LOG)__log('Count refereces for upload <'. $j76ee3 .'>'); $g7cd94=$dbe270=$n6ae44=array(); if(is_file(USER_FOLDER.'new-uploads.psa')) { $g7cd94=@unserialize(file_get_contents(USER_FOLDER.'new-uploads.psa')); if (!is_array($g7cd94))$g7cd94=array(); } $k5a976='%'. str_replace('%','#%',$j76ee3) .'%'; if (l0738( "SELECT `ID`, `Text`, `FormatterID`, `Uploads` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `Text` LIKE '". $k5a976 ."' ESCAPE '#' ". "OR `Uploads` LIKE '". $k5a976 ."' ESCAPE '#'" )) { $result=i0d6b(); $dbe270=@unserialize($result[0]['Uploads']); if (!is_array($dbe270)) { foreach($result as $e39a37){ $l2bfe4=z154e( $e39a37['FormatterID'], @$e39a37['Text'],'full-rss' ); $dbe270=efc4d($e39a37,$l2bfe4); } } } if (l0738( "SELECT `ID`, `Description`, `Uploads` ". "FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `Description` LIKE '". $k5a976 ."' ESCAPE '#' ". "WHERE `Uploads` LIKE '". $k5a976 ."' ESCAPE '#'" )) { $result=i0d6b(); $n6ae44=@unserialize($result[0]['Uploads']); if (!is_array($n6ae44)) { foreach($result as $db19ad){ $l2bfe4=tb7f1( @$db19ad['Description'],'full-rss' ); $n6ae44=efc4d($db19ad,$l2bfe4); } } } $k5128f=array_merge($g7cd94,$dbe270,$n6ae44); if(__LOG)__log('References found in relevant entries: '. var_export($k5128f,true)); if(in_array($j76ee3,$k5128f)) { if(__LOG)__log('Still referenced, do not delete file'); return true; } return false; } function tfb75($ef5e63,$cb80bb){ global$_config; if ($ef5e63=='note' and $cb80bb=='new'){ if(is_file(USER_FOLDER.'new-uploads.psa')) { $k5128f=@unserialize(file_get_contents(USER_FOLDER.'new-uploads.psa')); } } elseif ($ef5e63=='note'){ if (l0738( "SELECT `Uploads` FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `ID`=". $cb80bb )) { $result=i0d6b(); $k5128f=@unserialize($result[0]['Uploads']); } } elseif ($ef5e63=='tag'){ if (l0738( "SELECT `Uploads` FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `ID`=". $cb80bb )) { $result=i0d6b(); $k5128f=@unserialize($result[0]['Uploads']); } } if (!is_array($k5128f))$k5128f=array(); return $k5128f; } function obc90($ef5e63,$cb80bb,$k5128f){ global$_config; if ($ef5e63=='note' and $cb80bb=='new'){ if (!@d6e52(USER_FOLDER.'new-uploads.psa',serialize($k5128f))) { s8a40('ERROR',E2E_PERMISSIONS_ERROR); } } elseif ($ef5e63=='note'){ l0738( "UPDATE `". $_config['db_table_prefix']."Notes` ". "SET `Uploads`='". serialize($k5128f) ."' ". "WHERE `ID`=". $cb80bb ); } elseif ($ef5e63=='tag'){ l0738( "UPDATE `". $_config['db_table_prefix']."Keywords` ". "SET `Uploads`='". serialize($k5128f) ."' ". "WHERE `ID`=". $cb80bb ); } else { return false; } if (!is_array($k5128f))$k5128f=array(); return $k5128f; } function v4ae9($ef5e63,$cb80bb,$action,$g4a202){ global$_config; $k5128f=array(); if(__LOG)__log('Register upload: <'. $ef5e63.', '. $cb80bb.', '. $action.', '. $g4a202 .'>'); $k5128f=tfb75($ef5e63,$cb80bb); $k5128f=le1e7($k5128f,$action,$g4a202); obc90($ef5e63,$cb80bb,$k5128f); } function e2j_file_upload($parameters=array ()) { global$_config,$full_blog_url; @naf42(PICTURES_FOLDER); @chmod(PICTURES_FOLDER,$_config['uploaded_files_mode']); @naf42(AUDIO_FOLDER); @chmod(AUDIO_FOLDER,$_config['uploaded_files_mode']); $vd1fc8=array(); $vd1fc8['success']=0; if(count($_FILES) > 0){ foreach($_FILES as $j8c7dd){ if (!$j8c7dd['error']) { if(__LOG)__log('Ajax file upload: <'. $j8c7dd['name'].'>'); $vd1fc8['file-kind']='image'; $t85114=PICTURES_FOLDER; if(substr($j8c7dd['name'],strrpos($j8c7dd['name'],'.')) == '.mp3'){ $vd1fc8['file-kind']='audio'; $t85114=AUDIO_FOLDER; } $c77dce=( array_key_exists('overwrite',$_GET) and is_file($t85114.$j8c7dd['name']) ); $r6f4b5=false; $vd1fc8['overwrite'] = (int)$c77dce; if(__LOG)__log('Ajax file upload: Overwrite is resolved to <'. (int)$c77dce.'>'); $p96704=h9c0a($j8c7dd['name'],$vd1fc8['file-kind']); if(__LOG)__log('Ajax file upload: Safe name is <'. $p96704.'>'); if(is_file($t85114.$p96704)) { if(file_get_contents($t85114.$p96704)==file_get_contents($j8c7dd['tmp_name'])) { if(__LOG)__log('Ajax file upload: Existing file is the same'); $r6f4b5=true; } else { if (!$c77dce){ $u5c917=substr($p96704,0,strrpos($p96704,'.')); $tabf77=substr($p96704,strrpos($p96704,'.')); $y865c0=0; while (is_file($t85114.$u5c917 .'_'. (++$y865c0).$tabf77)); $p96704=$u5c917 .'_'. $y865c0.$tabf77; } } } if (!$r6f4b5){ move_uploaded_file($j8c7dd['tmp_name'],$t85114.$p96704); @chmod($x9f57c,$_config['uploaded_files_mode']); } if(__LOG)__log('Ajax file upload: File kind is <'. $vd1fc8['file-kind'].'>'); if ($vd1fc8['file-kind']=='image'){ if ($qf1210=p291d($p96704,$c77dce)) { if(__LOG)__log('Ajax file upload: thumbnail, done'); list ($meaae2,$ab435e)=l19a4($qf1210); $vd1fc8['success']=1; $vd1fc8['new-name']=$p96704; $vd1fc8['thumb']=$full_blog_url .'/'. $qf1210; $vd1fc8['width']=$meaae2; $vd1fc8['height']=$ab435e; v4ae9($parameters['entity'],$parameters['entity-id'],'add', array ($p96704)); } else { if(__LOG)__log('Ajax file upload: couldn’t create thumbnail'); @unlink($t85114.$p96704); $vd1fc8['error']='could-not-create-thumbnail'; } } if ($vd1fc8['file-kind']=='audio'){ if(__LOG)__log('Ajax file upload: audio, done'); $vd1fc8['success']=1; $vd1fc8['new-name']=$p96704; $vd1fc8['thumb']=AUDIO_ICON_IMAGE; $vd1fc8['width']=AUDIO_ICON_WIDTH; $vd1fc8['height']=AUDIO_ICON_HEIGHT; } } elseif(4!=$j8c7dd['error']) { if ($j8c7dd['error']==1){ $vd1fc8['error']='too-big'; } elseif ($j8c7dd['error']==2){ $vd1fc8['error']='too-big'; } elseif ($j8c7dd['error']==3){ $vd1fc8['error']='partial'; } else { $vd1fc8['error']=$j8c7dd['error']; } } } } else { if(__LOG)__log('Ajax file upload error: no files'); $vd1fc8['error']='no-files'; } $vd1fc8=json_encode($vd1fc8); die ($vd1fc8); } function e2j_userpic_upload(){ global$_config; if(count($_FILES)==1){ $j8c7dd=array_pop($_FILES); if (!$j8c7dd['error']) { if(__LOG)__log('Ajax userpic upload: <'. $j8c7dd['name'].'>'); $ba93b8=pathinfo($j8c7dd['name']); $tabf77=strtolower($ba93b8['extension']); if ($tabf77!='png')$tabf77='jpg'; $v435ed='userpic.original.'. $tabf77; move_uploaded_file($j8c7dd['tmp_name'],USER_FOLDER.$v435ed); @chmod(USER_FOLDER.$v435ed,$_config['uploaded_files_mode']); $jd1789=array ( 'w' => USERPIC_WIDTH, 'h' => USERPIC_HEIGHT, 'q' => USERPIC_JPG_QUALITY ); @unlink(USER_FOLDER.'userpic@2x.png'); @unlink(USER_FOLDER.'userpic@2x.jpg'); $qf1210=g8611( USER_FOLDER.$v435ed, USER_FOLDER .'userpic@2x.jpg', $jd1789, CROP_SQUARE, true ); @unlink(USER_FOLDER.$v435ed); if ($qf1210){ if(__LOG)__log('Ajax userpic upload: userpic, done'); die ('image|'. $qf1210); } else { die ('image|'.DEFAULT_USERPIC_FILENAME); } } elseif(4!=$j8c7dd['error']) { if ($j8c7dd['error']==1){ die ('error|too-big'); } elseif ($j8c7dd['error']==2){ die ('error|too-big'); } elseif ($j8c7dd['error']==3){ die ('error|partial'); } else { die ('error|'. $j8c7dd['error']); } } } else { if(__LOG)__log('Ajax userpic upload error: no or too many files'); die ('error|no-or-too-many-files'); } die ('error|uncatched-error'); } function e2j_file_remove($parameters){ $j8c7dd=$qf1210=''; if(array_key_exists('file',$_POST))$j8c7dd=$_POST['file']; v4ae9($parameters['entity'],$parameters['entity-id'],'remove',$j8c7dd); if (nf0fb($j8c7dd)) { die ('nothing'); } else { if(substr($j8c7dd,strrpos($j8c7dd,'.')) == '.mp3'){ @unlink(AUDIO_FOLDER.$j8c7dd); die ('nothing'); } else { $qf1210=v25cb($j8c7dd,'thumb@2x'); $kd911a=v25cb($j8c7dd,'scaled'); if ($j8c7dd){ $df6347=@unlink(PICTURES_FOLDER.$j8c7dd); $d8f458=@unlink(THUMBNAILS_FOLDER.$qf1210); die ('nothing'); } } } die ('error|no-filename-passed'); } function p6b7f($efce75,$vc69cd,$hd35fb,$pd6663,$o1c925,$icff96){ if (!extension_loaded('gd')) { if (!dl('gd.so')) { header('Content-type: image/gif'); return false; } } $kcaf9b=@getimagesize($efce75); if (!$kcaf9b or $kcaf9b[2] > 3) return; $m599dc=$kcaf9b[2]; $w73beb=null; if ($m599dc==IMAGETYPE_GIF and function_exists('imagecreatefromgif')) { $w73beb=imagecreatefromgif($efce75); } if ($m599dc==IMAGETYPE_JPEG and function_exists('imagecreatefromjpeg')) { $w73beb=imagecreatefromjpeg($efce75); } if ($m599dc==IMAGETYPE_PNG and function_exists('imagecreatefrompng')) { $w73beb=imagecreatefrompng($efce75); } if (!$w73beb){ if(__LOG)__log('Could not create image object'); return false; } $meaae2=imagesx($w73beb); $ab435e=imagesy($w73beb); $t0cb47=min($vc69cd/$meaae2,$hd35fb/$ab435e); if ($t0cb47 < 1){ $vc69cd=round($meaae2*$t0cb47); $hd35fb=round($ab435e*$t0cb47); } else { $vc69cd=$meaae2; $hd35fb=$ab435e; } $s08c38=$u480e9=$bb710b=$aee920=0; if ($icff96==CROP_SQUARE){ if ($vc69cd > $hd35fb){ $bb710b=$meaae2-$ab435e; $s08c38=floor($bb710b/2); $hd35fb=$vc69cd; } else { $aee920=$ab435e-$meaae2; $u480e9=floor($bb710b/2); $vc69cd=$hd35fb; } if(__LOG)__log('Files: '.'$crop_l='. $i6c5abд .' '.'$crop_t='. $u480e9 .' '.'$crop_hor='. $bb710b .' '.'$crop_ver='. $aee920 .' '); } $u28e3d=imagecreatetruecolor($vc69cd,$hd35fb); if ($m599dc==IMAGETYPE_PNG){ imagefill($u28e3d,0,0,imagecolorallocate($u28e3d,255,255,255)); imagealphablending($u28e3d,true); } if (empty ($o1c925)) { $q19229=stat($efce75); $q19229=date('r',$q19229['mtime']); header('Last-Modified: '.$q19229); } imagecopyresampled( $u28e3d, $w73beb, 0,0, 0+$s08c38,0+$u480e9, $vc69cd,$hd35fb, $meaae2-$bb710b,$ab435e-$aee920 ); imageinterlace($u28e3d,1); imagejpeg($u28e3d,$o1c925,$pd6663); return true; } function e74e0(){ global$settings; if (!isset ($settings))$settings=array(); $rfa816=array(); if(is_file(USER_FOLDER.'settings.json')) { $rfa816=json_decode(file_get_contents(USER_FOLDER.'settings.json'),true); $n098f6=13; } elseif(is_file(USER_FOLDER.'settings.psa')) { $rfa816=unserialize(file_get_contents(USER_FOLDER.'settings.psa')); } if (!is_array($rfa816))$rfa816=array(); $settings=array_merge($settings,$rfa816); if ( !is_numeric(@$settings['appearance']['notes_per_page']) or @$settings['appearance']['notes_per_page'] < 1 ){ $settings['appearance']['notes_per_page']=DEFAULT_ITEMS_PER_PAGE; } if ( @$settings['appearance']['notes_per_page'] > MAX_ITEMS_PER_PAGE ){ $settings['appearance']['notes_per_page']=MAX_ITEMS_PER_PAGE; } if ( !array_key_exists('comments',$settings) or !array_key_exists('default_on', @$settings['comments']) ) { $settings['comments']['default_on']=false; } return true; } function e2m_settings(){ global$settings,$_template,$_strings; $lf3e33=array(); $a5e107=@$settings['language']? $settings['language']:DEFAULT_LANGUAGE; foreach(glob(LANGUAGES_FOLDER. '*.php') as $v435ed){ $t5b54c=substr(basename($v435ed),0,2); $y98bf7=file_get_contents($v435ed); if(preg_match( '/^ *\/\/ *display_name *\= *(.*?) *$/ismu',$y98bf7,$u9c28d )) { $ic2657=$u9c28d[1]; } else { $ic2657=$t5b54c; } $lf3e33[$t5b54c] = array ( 'selected?' => (bool) ($a5e107==$t5b54c), 'display-name' => $ic2657, ); } $a2cb9d['title']=$_strings['pt--settings']; $a2cb9d['heading']=$_strings['pt--settings']; $a2cb9d['form']='form-preferences'; $a2cb9d['form-preferences'] = array ( 'blog-title-default' => htmlspecialchars($_strings['e2--default-blog-title'],ENT_COMPAT,HSC_ENC), 'blog-title' => htmlspecialchars(p6f51(),ENT_COMPAT,HSC_ENC), 'blog-description' => htmlspecialchars(@$settings['description'],ENT_COMPAT,HSC_ENC), 'blog-author-default' => htmlspecialchars($_strings['e2--default-blog-author'],ENT_COMPAT,HSC_ENC), 'blog-author' => htmlspecialchars(@$settings['author'],ENT_COMPAT,HSC_ENC), 'languages' => $lf3e33, 'language' => $a5e107, 'form-action' => e83c8('e2s_settings_save'), 'notes-per-page' => $settings['appearance']['notes_per_page'], 'email-notify?' => (bool) @$settings['notifications']['new_comments'], 'email' => htmlspecialchars(@$settings['user']['email'],ENT_NOQUOTES,HSC_ENC), 'comments-default-on?' => (bool) @$settings['comments']['default_on'], 'comments-fresh-only?' => (bool) @$settings['comments']['fresh_only'], 'show-sharing-buttons?' => (bool)$settings['appearance']['show_sharing_buttons'], 'includes-google-analytics?' => false, 'includes-yandex-metrika?' => false, 'template-name' => $_template['name'], 'templates' => l94dd(), 'submit-text' => $_strings['fb--save-changes'], ); return $a2cb9d; } function e2s_settings_save(){ global$settings,$_strings; $s05df2=$f67daf=''; $s05df2=$f67daf=''; if(array_key_exists('blog-title',$_POST)) { $s05df2=trim($_POST['blog-title']); } if(array_key_exists('blog-description',$_POST)) { $f67daf=trim($_POST['blog-description']); } if(array_key_exists('blog-author',$_POST)) { $i02bd9=trim($_POST['blog-author']); } if(array_key_exists('language',$_POST)) $p8512a=$_POST['language']; if(array_key_exists('email',$_POST)) $v0c83f=trim($_POST['email']); if(array_key_exists('template',$_POST)) $v66f61=trim($_POST['template']); $z0c2bd=(int)$_POST['notes-per-page']; $settings['site_title']=$s05df2; $settings['site_title']=p6f51(); $settings['description']=$f67daf; $settings['author']=$i02bd9; $settings['user']['email']=$v0c83f; $settings['notifications']['new_comments'] = isset ($_POST['email-notify']); $settings['template']=$v66f61; $settings['comments']['default_on'] = isset ($_POST['comments-default-on']); if ( $settings['language']!=$p8512a or $settings['appearance']['notes_per_page']!=$z0c2bd or $settings['appearance']['show_sharing_buttons'] != isset ($_POST['show-sharing-buttons']) or $settings['comments']['fresh_only'] != isset ($_POST['comments-fresh-only']) ) { @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); $settings['language']=$p8512a; $settings['appearance']['notes_per_page']=$z0c2bd; $settings['appearance']['show_sharing_buttons'] = isset ($_POST['show-sharing-buttons']); $settings['comments']['fresh_only'] = isset ($_POST['comments-fresh-only']); } if(E2_EDITION){ if(array_key_exists('google-analytics',$_POST)) { $settings['embed']['google-analytics']=trim($_POST['google-analytics']); } if(array_key_exists('yandex-metrika',$_POST)) { $settings['embed']['yandex-metrika']=trim($_POST['yandex-metrika']); } } bc5a6(CACHE_FILENAMES_NOTES_COMMENTS); if (!@d6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { s8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(e83c8('e2m_settings')); die; } e2_go_to(e83c8('e2m_frontpage', array ('page' => 1))); die; } function e2m_database(){ global$settings,$_strings,$_superconfig; if (@$_superconfig['disallow_db_config']) { die ('DB Configuration not allowed'); } $a2cb9d['title']=$_strings['pt--database']; $a2cb9d['heading']=$_strings['pt--database']; $a2cb9d['form']='form-database'; $a2cb9d['form-database'] = array ( 'form-action' => e83c8('e2s_database_save'), 'db-server' => htmlspecialchars(@$settings['db']['server']? $settings['db']['server']:'localhost'), 'db-user' => htmlspecialchars(@$settings['db']['user_name']? $settings['db']['user_name']:'root'), 'db-password' => htmlspecialchars(qee85(@$settings['db']['passw'])), 'db-database' => htmlspecialchars(@$settings['db']['name']), 'submit-text' => $_strings['fb--connect-to-this-db'], ); return $a2cb9d; } function e2s_database_save(){ global$settings,$_db,$_superconfig,$_strings,$_config; if (@$_superconfig['disallow_db_config']) { die ('DB Configuration not allowed'); } $w0ba44=x55fd(); if ($w0ba44=='bingo-data-exists'){ $settings['db']['server'] = @$_POST['db-server']; $settings['db']['user_name'] = @$_POST['db-user']; $settings['db']['passw']=v1305(@$_POST['db-password']); $settings['db']['name'] = @$_POST['db-database']; if (!@d6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { s8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(e83c8('e2m_database')); die; } e2_drop_all_kinds_of_cache(); bbb8d(); if (!$_config['retain_search_indexes_on_db_switch']) { $dddece=d476c(); $dddece -> erase(); c198f(); } ecc38(e83c8('e2s_bsi_step')); e2_go_to(e83c8('e2m_settings')); } else { s8a40($_strings['er--double-check-db-params']); e2_go_to(e83c8('e2m_database')); } die; } e74e0(); function s8a40($f67daf,$m599dc=E2E_STRANGE_ERROR){ global$errors,$settings, $_config, $_strings, $_diagnose; $l1897a=(!he852()+1 <= (int)$_config['show_call_stack']); if ($f67daf){ if ($f67daf[0]!='<')$f67daf='<p>'.$f67daf .'</p>'; $zcd1dd=array ( 'description' => $f67daf, 'type' => $m599dc, ); if ( $m599dc==E2E_STRANGE_ERROR and $l1897a and function_exists('debug_backtrace') ) { $zcd1dd['backtrace']=debug_backtrace(); } $errors[] = $zcd1dd; } if ($m599dc==E2E_PERMISSIONS_ERROR){ $_diagnose['need?']=true; uc64a('diagnose','1'); } if ($m599dc==E2E_DATABASE_ERROR){ } return true; } function m8739(){ global$errors,$a1c0b7,$_strings,$_diagnose; $o7287a=xea70(); if(count($o7287a)==0){ uc64a('diagnose',''); unset($_COOKIE['diagnose']); $_diagnose['need?']=false; $_diagnose['ok?']=true; return true; } else { $v6e2ba=''; $v6e2ba.='<p>'. $_strings['gs--enable-write-permissions-for-the-following'] .'</p>'; $v6e2ba.='<ul>'; foreach ($o7287a as $c8fa14){ if ($c8fa14=='.')$c8fa14=''; $v6e2ba.='<li><tt>.../'. $c8fa14 .'</tt></li>'; if(__LOG)__log('Diagnostics: cannot write <'. $c8fa14 .'>'); } $v6e2ba.='</ul>'; $zcd1dd=array ( 'title' => $_strings['et--fix-permissions-on-server'], 'description' => $v6e2ba, 'type' => E2E_DIAGNOSTICS_MESSAGE, 'class' => 'serious', ); $errors[] = $zcd1dd; $_diagnose['ok?']=false; return false; } } function pe1c4($ac1336,$f67daf,$p1407f,$lc2d4b,$w4f62c){ global$errors; if(0==error_reporting() or ($ac1336 & 8)) return; $p1407f=str_replace(__DIR__,'',$p1407f); s8a40($p1407f .', line '. $lc2d4b .'<br />Error '. $ac1336 .': '. $f67daf); $errors[count($errors)-1]['phpcode']=$ac1336; } function jec07(){ global$errors,$settings,$_config; @session_start(); if(is_array(@$_SESSION['errors'])) { $se1671=array_merge(@$_SESSION['errors'],$errors); } else { $se1671=$errors; } $l1897a=(!he852()+1 <= (int)$_config['show_call_stack']); if (@$_config['store_backtrace'] and $l1897a and $se1671!=NULL){ @d6e52('backtrace.psa',serialize($se1671)); } else { @unlink('backtrace.psa'); } if (isset ($_SESSION['errors'])) unset($_SESSION['errors']); $a2cb9d=array(); $ub8735=false; if(count($se1671) > 0){ foreach ($se1671 as $y865c0 => $l08a44){ if ($l08a44['type']==E2E_STRANGE_ERROR){ $l08a44['class']='serious'; $ub8735=true; if ($l1897a){ $l08a44['backtrace']=t2616($l08a44['backtrace']); } } if ($l08a44['type']==E2E_MESSAGE){ $l08a44['class']='info'; } $se1671[$y865c0]=$l08a44; } $a2cb9d['each']=$se1671; if ( $ub8735 and @$_config['store_backtrace'] and $l1897a and is_file('debug.php') ) { $a2cb9d['debug-link']='debug.php'; } } return $a2cb9d; } function z4006(){ $errors=jec07(); foreach($errors['each'] as $rcb5e1){ echo '<p>'. $rcb5e1['description'] .'</p>'; } die; } function t2616($t69206){ global $aa57c1; if (!is_array($t69206)) return 'No backtrace info'; $t69206=array_reverse($t69206); $t69206=array_splice($t69206,0,count($t69206)-1); $se1671='<p style="background: #fea; padding: .25em .5em; line-height: 1em; overflow: hidden">'; foreach ($t69206 as $y865c0 => $ze358e){ $j195df=@$ze358e['args'] or $j195df=array(); $la956a=array(); foreach ($j195df as $s5919c){ $la956a[] = var_export($s5919c,true); } $j8c7dd=@$ze358e['file']; $j8c7dd=str_replace($_SERVER['DOCUMENT_ROOT'],'',$j8c7dd); $x6438c=(@$ze358e['line']? (' #'. $ze358e['line']) : '?'); $se1671.='<div style="margin: .25em 0 .5em '. $y865c0*3 .'em">'; $se1671.='<span style="float: right; color: #666"> '. $j8c7dd.$x6438c .'</span>'; $se1671.='<tt><b>'. @$ze358e['function'] .' (</b>'; if(count($la956a)) { $eeb84a=str_replace("array (\n)",'array ()',$la956a); $eeb84a=implode(', ',$eeb84a); if(0){ $eeb84a=highlight_string('<?'. $eeb84a .'?'.'>',true); $eeb84a=substr($eeb84a,77, -28); } $eeb84a=str_replace('&nbsp;',' ',$eeb84a); $eeb84a=nl2br($eeb84a); $se1671.='<div style="margin: 0 0 0 1.12em">'. $eeb84a .'</div>'; } $se1671.='<b>)</b> &rarr;</tt></div>'; } $se1671.='</p>'; return $se1671; } set_error_handler('pe1c4'); function e2_error404_mode(){ global$_config,$_strings; if($_config['try_redirect_to_all']) { $j4a7dc='all/'. urldecode($_GET['go']); jb7e9($j4a7dc); } header('HTTP/1.1 404 Not found'); $ge70c4['heading']=$_strings['pt--page-not-found']; $ge70c4['title']=$_strings['pt--page-not-found']; return $ge70c4; } include_once 'neasden/neasden.php'; function m6f10($j1cb25){ $Nn=new Neasden; $Nn->profile_name='kavychki'; return$Nn->format($j1cb25); } function rc0c4($wf2ffc,$j1cb25,$z5c18e){ if ($j1cb25==='') return array (); if ($wf2ffc=='calliope'){ preg_match_all('/\(\(([^ ]*)( |\)\))/',$j1cb25,$u9c28d); return $u9c28d[1]; } elseif ($wf2ffc=='neasden'){ $Nn=new Neasden; $Nn->profile_name=$z5c18e; $Nn->format($j1cb25); return$Nn->resources_detected; } else { return array (); } } function z154e($wf2ffc,$j1cb25,$z5c18e){ if(__LOG)__log('Format: format with formatter "'. $wf2ffc .'" in context "'. $z5c18e.'"'); if ($wf2ffc=='calliope'){ $j1cb25=sedd9($j1cb25); $j1cb25=j5599($j1cb25,$z5c18e); $meta=array(); $j1cb25=afd97($j1cb25); $j1cb25='<div class="e2-text-calliope-formatted">'. m6f10($j1cb25) .'</div>'; } elseif ($wf2ffc=='neasden'){ $Nn=new Neasden; $Nn->profile_name=$z5c18e; $j1cb25=$Nn->format($j1cb25); $meta=array ( 'links-required' => $Nn->links_required, 'resources-detected' => $Nn->resources_detected ); } return array ( 'text-final' => $j1cb25, 'meta' => $meta, ); } function tb7f1($j1cb25,$z5c18e){ global$_config; return z154e($_config['default_formatter'],$j1cb25,$z5c18e); } function j5599($j1cb25,$z5c18e){ global$_config,$settings,$full_blog_url,$_template; @ (list ($z5c18e,$ee8fab)=explode('|',$z5c18e)); require_once 'calliope/WikiFormatter.php'; if ('full'==$z5c18e)$iad910=WF_FULL_MODE; elseif ('simple'==$z5c18e)$iad910=WF_SIMPLE_MODE; else return $j1cb25; $w0a1d3=new WikiFormatter(); $w0a1d3 -> replace=array ( '/' => 'i', '+' => 'small', '-' => 's', '*' => 'b', '^' => 'sup', 'v' => 'sub', '#' => 'tt', '!' => 'blockquote', ); $w0a1d3 -> settings=array ( 'hrefSize' => 100, 'localImgDir' => $full_blog_url .'/'. PICTURES_FOLDER, 'maxImgWidth' => $_template['max_image_width'], 'mode' => $iad910, 'enableShrinkLongHref' => 1, 'enableHr' => 0, 'enableBr' => 1, 'enableHeaders' => 1, 'headersStartWith' => 1, 'enableTables' => 1, 'simpleTableCSSClass' => 'e2-text-table', 'enableAutoAcronymEngine' => 0, 'enableAcronym' => 0, 'acronymBase' => '', 'enableList' => 1, 'mailSafe' => "<a href=\"\" onmouseover=\"this.href='mailto:'+{email}\">{icon}<script language=\"JavaScript\">document.write({name});</script></a>", 'ljUserTag' => '<a href="http://livejournal.com/users/{name}/">{name}</a>', 'fullVersionURL' => $ee8fab, 'enableTagIcons' => 0, 'outerUrlInNewWindow' => 0, 'lineBreak' => "\n", 'extLinkHrefPrefix' => '', ); $j1cb25=$w0a1d3 -> Wiki2HTML($j1cb25); return $j1cb25; } function q7c64($a572d4){ global$_config,$_protocol,$r57de2,$aa57c1; $a572d4=str_replace($_protocol. '://'. $r57de2,'',$a572d4); $i67b3d=$_SERVER['HTTP_HOST']; $q90155=80; if(__LOG)__log('Spawn '. $i67b3d .':'. $q90155.$a572d4 .'...'); $n0666f=fsockopen($i67b3d,$q90155,$t70106,$o809b1,1); if(__LOG)__log('Spawn fsockopen returns '. print_r($n0666f,true) .', (errno='. $t70106 .', errstr='. $o809b1 .')...'); if ($n0666f){ @socket_set_timeout($n0666f,1); $n8d777=( 'GET '. $a572d4 ." HTTP/1.0\r\n". 'Host: '. $r57de2 ."\r\n". 'User-Agent: '. E2_UA_STRING ."\r\n". jff2e() ); $b5e369=@fwrite($n0666f,$n8d777 ."\r\n"); if(__LOG)__log('Spawn fwrite returns ['. $b5e369 .']'); if($_config['fgets_spawn']) { $b5e369=''; while (!feof($n0666f))$b5e369.=fgets($n0666f,128); if(__LOG)__log('Spawn fgets returns ['. $b5e369 .']'); } $b5e369=@fclose($n0666f); if(__LOG)__log('Spawn fclose returns ['. $b5e369 .']'); return true; } else { if(__LOG)__log('Spawn didn’t work'); return false; } } function j79aa($a572d4){ if(__LOG)__log('Curl '. $a572d4 .'...'); $rf6e57=curl_init(); curl_setopt_array($rf6e57, array ( CURLOPT_URL => $a572d4, CURLOPT_CONNECTTIMEOUT => 300, CURLOPT_TIMEOUT => 1, CURLOPT_MAXREDIRS => 1, CURLOPT_COOKIE => cc3fb(), CURLOPT_SSL_VERIFYPEER => false, CURLOPT_FOLLOWLOCATION => true, CURLOPT_RETURNTRANSFER => true, CURLOPT_AUTOREFERER => true, CURLOPT_USERAGENT => E2_UA_STRING, )); $content=curl_exec($rf6e57); $t70106=curl_errno($rf6e57); $o809b1=curl_error($rf6e57); $l099fb=curl_getinfo($rf6e57); curl_close($rf6e57); if(__LOG)__log('Curl returns: ['. print_r($l099fb,true) .'] ['. $content .'], (errno='. $t70106 .', errstr='. $o809b1 .')...'); } function ecc38($a572d4){ if(__LOG)__log('Spawn: using e2_spawn_curl ()'); return j79aa($a572d4); } function p5b68($rea59a){ global$_config; if (@$_config['broadcast_url']) { if(__LOG)__log('Broadcast-async note: '. $rea59a['Title']); ecc38(e83c8('e2m_note_broadcast', array ('*note' => $rea59a))); } } function e2m_note_broadcast($parameters=array ()) { global$_config; if (@$_config['broadcast_url']) { $bcdf92=parse_url($_config['broadcast_url']); $waad65=$parameters['*note']; $scffbb=e83c8('e2m_note_json',$parameters); $g2b617=$bcdf92['host']; $a070cb=80; $xfbeba=$bcdf92['path']; $xfbeba.='?src='. urlencode($scffbb); if(__LOG)__log('Broadcast '. $g2b617.' — '.$xfbeba .'...'); $n0666f=@fsockopen($g2b617,$a070cb,$t70106,$o809b1,1); if(__LOG)__log('Broadcast fsockopen returns '. $n0666f .', (errno='. $t70106 .', errstr='. $o809b1 .')...'); if ($n0666f){ @socket_set_timeout($n0666f,1); $n8d777=( 'GET '. $xfbeba ." HTTP/1.0\r\n". 'Host: '. $g2b617 ."\r\n". 'User-Agent: '. E2_UA_STRING ."\r\n" ); $b5e369=@fwrite($n0666f,$n8d777 ."\r\n"); if($_config['fgets_broadcast']) { while (!feof($n0666f))fgets($n0666f,128); } $b5e369=@fclose($n0666f); die ('Broadcasted.'); } else { die ('Could not broadcast.'); } } return e2_error404_mode(); } function e2m_note_json($parameters=array ()) { $waad65=$parameters['*note']; if ($waad65==false){ return e2_error404_mode(); } $waad65['_']['_id']=$waad65['ID']; $q8e4cd=m6791($waad65); $i466de=array ( 'engine' => array ( 'title' => 'E2', 'version' => 'v'. E2_VERSION, ), 'blog' => array ( 'author' => c2640(), 'title' => p6f51(), 'href' => e83c8('e2m_frontpage', array ('page' => 1)), 'rss-href' => e83c8('e2m_frontpage_rss'), 'userpic-href' => j2461(), ), 'note' => array ( 'id' => $waad65['ID'], 'alias' => e2_active_alias_for_page_(ENTITY_TYPE_NOTE,$waad65['ID']), 'title' => $q8e4cd['title'], 'text' => $q8e4cd['text'], 'resources-detected' => $q8e4cd['format-info']['resources-detected'], 'links-required' => $q8e4cd['format-info']['links-required'], 'tags' => $q8e4cd['tags'], 'favourite?' => $q8e4cd['favourite?'], 'og-images' => $q8e4cd['og-images'], 'time' => $q8e4cd['time'], 'last-modified' => $q8e4cd['last-modified'], 'comments-count' => $q8e4cd['comments-count'], 'href' => $q8e4cd['href'], 'href-original' => $q8e4cd['href-original'], 'alias' => $parameters['alias'], ), ); $i466de=json_encode($i466de,E2_JSON_STYLE); header('Content-Type: application/json'); echo $i466de; die; } function e2m_timezone(){ global$_strings,$settings; $ude2fd=array ( 'form-action' => e83c8('e2s_select_timezone'), 'submit-text' => $_strings['fb--select'], 'timezone-selector' => y9fe5($settings['timezone']['offset'],1), 'dst?' => $settings['timezone']['is_dst'], ); return array ( 'title' => $_strings['pt--default-timezone'], 'heading' => $_strings['pt--default-timezone'], 'form' => 'form-timezone', 'form-timezone' => $ude2fd, ); } function h4c37(){ global$_strings; $n5cacd=array ( -720 => '', -660 => '', -600 => '', -540 => '', -480 => $_strings['tt--zone-pt'], -420 => $_strings['tt--zone-mt'], -360 => $_strings['tt--zone-ct'], -300 => $_strings['tt--zone-et'], -240 => '', -210 => '', -180 => '', -120 => '', -60 => '', 0 => $_strings['tt--zone-gmt'], 60 => $_strings['tt--zone-cet'], 120 => $_strings['tt--zone-eet'], 180 => '', 210 => '', 240 => $_strings['tt--zone-msk'], 270 => '', 300 => '', 330 => '', 345 => '', 360 => $_strings['tt--zone-ekt'], 390 => '', 420 => '', 480 => '', 540 => '', 570 => '', 600 => '', 660 => '', 720 => '', 780 => '', 840 => '', ); return $n5cacd; } function g82a3($o7a86c){ $n5cacd=h4c37(); return @$n5cacd[(int)$o7a86c/SECONDS_IN_A_MINUTE]; } function c9515($o7a86c){ $r04b29='+'; if ($o7a86c < 0)$r04b29='&ndash;'; $o73cdd=str_pad((int) (abs($o7a86c)/3600),2,'0',STR_PAD_LEFT); $f640fd=str_pad(abs($o7a86c)/60 % 60,2,'0',STR_PAD_LEFT); return 'GMT'. $r04b29.$o73cdd .':'. $f640fd; } function y9fe5($j0743a,$r5784d=''){ global$_strings; $n5cacd=h4c37(); $a2cb9d=''; if (!$r5784d)$r5784d=count($n5cacd); $a2cb9d.='<select name="offset" size="'. $r5784d .'">'; foreach ($n5cacd as $o7a86c => $h83bce){ $jc03a8=''; if ($o7a86c*SECONDS_IN_A_MINUTE==$j0743a)$jc03a8=' selected="selected"'; $a2cb9d.='<option'. $jc03a8 .' value="'.$o7a86c.'">'; $r04b29=''; if ($o7a86c < 0)$r04b29='−'; if ($o7a86c > 0)$r04b29='+'; $o73cdd=(int) (abs($o7a86c*SECONDS_IN_A_MINUTE)/3600); $f640fd=(int) (abs($o7a86c*SECONDS_IN_A_MINUTE)/60 % 60); if ($o73cdd){ $a2cb9d .= ( $r04b29 .' '. $o73cdd .' '. $_strings['gs--timezone-offset-hours'] .' '. ($f640fd? ($f640fd .' '. $_strings['gs--timezone-offset-minutes']) : '') ); if ($h83bce){ $a2cb9d .= ' ('. $h83bce. ')'; } } else { $a2cb9d .= $h83bce; } $a2cb9d.='</option>'; } $a2cb9d.='</select>'; return $a2cb9d; } function e2s_select_timezone(){ global$settings,$_strings; if (@$_POST['offset'] >= -720 and @$_POST['offset'] <= 780){ $settings['timezone']['offset'] = @$_POST['offset']*SECONDS_IN_A_MINUTE; $settings['timezone']['is_dst'] = isset ($_POST['is_dst']); } if (!@d6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { s8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(e83c8('e2m_timezone')); die; } e2_go_to(e83c8('e2m_settings')) and die (); } function h0923($waad65){ return array ( 'offset' => (int)$waad65['Offset'], 'is_dst' => (bool)$waad65['IsDST'], ); } function j3211(){ return array ( 'offset' => 0, 'is_dst' => false, ); } function z5c05(){ global$settings; return$settings['timezone']; } function y7770($xb2c6c,$edf491){ if (@$xb2c6c['is_dst']) { $l30481=(int)date('I',$edf491); $q6b7ea=date('Z',$edf491)-$l30481*SECONDS_IN_AN_HOUR; $l3e61a=$xb2c6c['offset']; $y178ae=$l3e61a-$q6b7ea; $o75b02=date('I',$edf491+$y178ae); return $o75b02; } else { return 0; } } function ib2bf($xb2c6c,$edf491){ global$settings; if ($xb2c6c and is_array($xb2c6c)) { return ( $xb2c6c['offset'] + y7770($xb2c6c,$edf491)*SECONDS_IN_AN_HOUR ); } } function v8afe($edf491){ return ib2bf(z5c05(),$edf491); } function g5a2f($i1ddcb,$g4a202,$xb2c6c){ return gmdate($i1ddcb,$g4a202+ib2bf($xb2c6c,$g4a202)); } function ma846($i1ddcb,$g4a202){ return g5a2f($i1ddcb,$g4a202,z5c05()); } function a66cd($z41529,$h6f8f5=false,$c8277e=false){ if(is_numeric($c8277e)) { $nea2b2=gmmktime(0,0,0,$h6f8f5,$c8277e,$z41529); $k7f021=gmmktime(0,0,0,$h6f8f5,$c8277e+1,$z41529)-1; } elseif(is_numeric($h6f8f5)) { $nea2b2=gmmktime(0,0,0,$h6f8f5,1,$z41529); $k7f021=gmmktime(0,0,0,$h6f8f5+1,1,$z41529)-1; } else { $nea2b2=gmmktime(0,0,0,1,1,$z41529); $k7f021=gmmktime(0,0,0,1,1,$z41529+1)-1; } return array ($nea2b2,$k7f021); } function l2143($xb2c6c,$z41529,$h6f8f5=false,$c8277e=false){ list ($nea2b2,$k7f021)=a66cd($z41529,$h6f8f5,$c8277e); $nea2b2 -= ib2bf($xb2c6c,$nea2b2); $k7f021 -= ib2bf($xb2c6c,$k7f021); return array ($nea2b2,$k7f021); } function pac5b($z41529,$h6f8f5=false,$c8277e=false){ return l2143(z5c05(),$z41529,$h6f8f5,$c8277e); } function n5273($z41529,$h6f8f5=false,$c8277e=false){ $k32038=13; $cda4f0=-12; $k32038+=1; $cda4f0 -= 1; list ($nea2b2,$k7f021)=a66cd($z41529,$h6f8f5,$c8277e); $nea2b2 -= $k32038*3600; $k7f021 -= $cda4f0*3600; return array ($nea2b2,$k7f021); } function ed17a($o7a86c){ if ((int) @$o7a86c > 0) return (string)'+'.abs(@$o7a86c); elseif ((int) @$o7a86c < 0) return (string)'-'.abs(@$o7a86c); else return ''; } function ad536($edf491){ $d2ab64=v8afe($edf491); $r04b29=($d2ab64 >= 0)?'+':'-'; $d2ab64=abs($d2ab64); $d03c7c=$d2ab64 % 60; $d2ab64 -= $d03c7c; $h6f8f5=$d2ab64 % 3600/60; $d2ab64 -= $h6f8f5*60; $e2510c=$d2ab64/3600; if ($e2510c < 10)$e2510c='0'.$e2510c; if ($h6f8f5 < 10)$h6f8f5='0'.$h6f8f5; return $r04b29.$e2510c.$h6f8f5; } function ta618($qaa759){ global$settings; if(is_numeric($qaa759)) { $result['offset']=SECONDS_IN_A_MINUTE*$qaa759; $result['is_dst']=false; $sd8935=SECONDS_IN_A_MINUTE*$qaa759-SECONDS_IN_AN_HOUR; $za6cfc=array ('offset' => $sd8935,'is_dst' => true); $za6cfc=(int)ib2bf($za6cfc,time()); if($result['offset']==$za6cfc){ $result['offset']=$sd8935; $result['is_dst']=true; } } else { if(array_key_exists('timezone',$settings)) { $result=$settings['timezone']; } else { $result['offset']=0; $result['is_dst']=false; } } return$result; } function a692f($o96b8c){ $e2510c=ma846('H',$o96b8c); if ($e2510c <= 4) return 4; elseif ($e2510c <= 10) return 1; elseif ($e2510c <= 16) return 2; elseif ($e2510c <= 22) return 3; else return 4; } function t7a0b($w0e524,$mb65f7=null){ global$_strings; if ($mb65f7===null)$mb65f7=z5c05(); $hdb42a=g5a2f('d.m.Y',$g97bc5,$mb65f7); $w33284=g5a2f('d.m.Y',$w0e524,$mb65f7); $aed79a=SECONDS_IN_A_MINUTE; $q77cbc=SECONDS_IN_AN_HOUR; $g97bc5=time(); $v0b375=a692f($g97bc5); $g3dfda=a692f($w0e524); $g74459=$g97bc5-$w0e524; if ($g74459 < 0) return$_strings['tt--from-the-future']; if ($g74459 >= 0 and $g74459 < 54) return$_strings['tt--just-now']; if ($g74459 >= 54 and $g74459 < 108) return$_strings['tt--one-minute-ago']; $v7eccb=$g74459+12; $i7828e=floor($v7eccb/$aed79a); if ($g74459 >= 108 and $g74459 < 54*$aed79a) return e2l_get_string( 'tt--minutes-ago', array ('minutes' => $i7828e) ); if ($g74459 >= 54*$aed79a and $g74459 < 108*$aed79a) return$_strings['tt--one-hour-ago']; $v7eccb=$g74459+12*$aed79a; $j6b497=floor($v7eccb/$q77cbc); if ($g74459 >= 108*$aed79a and $g74459 < 4*$q77cbc) return e2l_get_string( 'tt--hours-ago', array ('hours' => $j6b497) ); $b07cc6=g5a2f('G:i',$w0e524,$mb65f7); if ($g74459 >= 4*$q77cbc and $v0b375 > $g3dfda and $hdb42a==$w33284){ return$_strings['tt--today']; } if ((($g97bc5-$w0e524) <= YEAR_DISPLAY_THRESH)) { return e2l_get_string( 'tt--date', array ( 'day' => g5a2f('j',$w0e524,$mb65f7), 'month' => g5a2f('m',$w0e524,$mb65f7), ) ); } return g5a2f('Y',$w0e524,$mb65f7); } $_model_contractions=array ( 'key' => "INT UNSIGNED AUTO_INCREMENT PRIMARY KEY", 'pkey' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'int' => "INT DEFAULT '0' NOT NULL", 'uint' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'time' => "INT UNSIGNED DEFAULT '0' NOT NULL", '0' => "TINYINT(1) DEFAULT '0' NOT NULL", '1' => "TINYINT(1) DEFAULT '1' NOT NULL", 'v1' => "VARCHAR(1) DEFAULT '' NOT NULL", 'v8' => "VARCHAR(8) DEFAULT '' NOT NULL", 'v15' => "VARCHAR(15) DEFAULT '' NOT NULL", 'v32' => "VARCHAR(32) DEFAULT '' NOT NULL", 'v64' => "VARCHAR(64) DEFAULT '' NOT NULL", 'fid' => "VARCHAR(32) DEFAULT '". $_config['default_formatter'] ."' NOT NULL", 'v255' => "VARCHAR(255) DEFAULT '' NOT NULL", 'text' => "TEXT", ); $_model=array ( 'Actions' => array ( array ('ID', 'key'), array ('EntityID', 'pkey'), array ('Stamp', 'time'), array ('HitCount', 'int'), ), 'Aliases' => array ( array ('ID', 'key'), array ('EntityType', 'v1'), array ('EntityID', 'pkey'), array ('Alias', 'v64'), array ('Stamp', 'time'), ), 'Comments' => array ( array ('ID', 'key'), array ('NoteID', 'pkey'), array ('AuthorName', 'v255'), array ('AuthorEmail', 'v255'), array ('Text', 'text'), array ('Reply', 'text'), array ('IsVisible', '1'), array ('IsFavourite', '0'), array ('IsReplyVisible', '0'), array ('IsReplyFavourite', '0'), array ('IsAnswerAware', '1'), array ('IsSubscriber', '0'), array ('IsSpamSuspect', '0'), array ('IsNew', '0'), array ('Stamp', 'time'), array ('LastModified', 'time'), array ('ReplyStamp', 'time'), array ('ReplyLastModified','time'), array ('IP', 'v15'), ), 'Keywords' => array ( array ('ID', 'key'), array ('ParentKeywordID', 'pkey'), array ('Keyword', 'v255'), array ('OriginalAlias', 'v64'), array ('Description', 'text'), array ('Uploads', 'text'), array ('IsFavourite', '0'), ), 'Notes' => array ( array ('ID', 'key'), array ('Title', 'v255'), array ('Text', 'text'), array ('FormatterID', 'fid'), array ('OriginalAlias', 'v64'), array ('Uploads', 'text'), array ('IsPublished', '0'), array ('IsIssue', '0'), array ('IsCommentable', '0'), array ('IsVisible', '1'), array ('IsFavourite', '0'), array ('Stamp', 'time'), array ('LastModified', 'time'), array ('Offset', 'int'), array ('IsDST', '0'), array ('IsIndexed', '0'), ), 'NotesKeywords' => array ( array ('ID', 'key'), array ('NoteID', 'pkey'), array ('KeywordID', 'pkey'), ), ); $_model_indexes=array ( 'Actions' => array ( "UNIQUE INDEX (`EntityID`, `Stamp`)", ), 'Aliases' => array ( "INDEX (`Alias`)", "INDEX (`EntityID`)", ), 'Comments' => array ( "INDEX (`NoteID`)", ), 'Keywords' => array (), 'Notes' => array ( "FULLTEXT (`Title`, `Text`)", "INDEX (`Stamp`)", ), 'NotesKeywords' => array ( "INDEX (`NoteID`)", ), ); $_model_minimal_table_list=array ( 'Comments', 'Keywords', 'Notes', 'NotesKeywords', ); function e2_model_data_check($k2a304,$y11e0e){ global$_model,$_model_minimal_table_list,$_config; $w08cfc=false; $e35f9b=array(); $yac5c7='SHOW TABLES FROM `'. mysqli_real_escape_string($k2a304,$y11e0e). '`'; $result=mysqli_query($k2a304,$yac5c7); if($result){ while ($ff1965=mysqli_fetch_row($result)) { foreach(array_keys($_model) as $vd2ffa){ if(strcasecmp($ff1965[0],$_config['db_table_prefix'].$vd2ffa)===0){ $w08cfc=true; $e35f9b[] = $vd2ffa; } } } } $wd9a22=true; foreach(array_keys($_model) as $vd2ffa){ if (!in_array($vd2ffa,$e35f9b)) { $wd9a22=false; } } $l7ec6f=true; foreach($_model_minimal_table_list as $vd2ffa){ if (!in_array($vd2ffa,$e35f9b)) { $l7ec6f=false; } } return array ( 'occupied' => $w08cfc, 'complete' => $wd9a22, 'migrateable' => $l7ec6f, ); } function bb154($jcf1e8,$zee11c,$h5f4dc){ $o32e95=array(); if (($k2a304=mysqli_connect($jcf1e8,$zee11c,$h5f4dc)) !== false){ $result=mysqli_query($k2a304,"SHOW DATABASES"); while ($ff1965=mysqli_fetch_row($result)) { if ( mysqli_select_db($k2a304,$ff1965[0]) and !in_array($ff1965[0], array ('information_schema','mysql')) ) { $o32e95[] = $ff1965[0]; } } } return $o32e95; } function x55fd(){ global$_model,$_config; $jcf1e8=$zee11c=$h5f4dc=$y11e0e=''; if(array_key_exists('db-server',$_POST)) $jcf1e8= $_POST['db-server']; if(array_key_exists('db-user',$_POST)) $zee11c= $_POST['db-user']; if(array_key_exists('db-password',$_POST))$h5f4dc=$_POST['db-password']; if(array_key_exists('db-database',$_POST))$y11e0e=$_POST['db-database']; if (($k2a304=mysqli_connect($jcf1e8,$zee11c,$h5f4dc)) === false){ if(mysqli_connect_errno()==1045){ return 'server-responding'; } else { return 'no-connect'; } } else { if (!$y11e0e){ $o32e95=bb154($jcf1e8,$zee11c,$h5f4dc); $y11e0e=$o32e95[0]; } if(mysqli_select_db($k2a304,$y11e0e)===false){ return 'server-lets-in'; } else { $paae42=e2_model_data_check($k2a304,$y11e0e); if ($paae42['occupied'] and $paae42['migrateable']) { return 'bingo-data-exists'; } elseif ($paae42['occupied']) { return 'data-incomplete'; } else { return 'bingo'; } } } } function ka0f9($gaab9e){ global$_config; $a7694f=( "SHOW TABLES LIKE '". $_config['db_table_prefix'].$gaab9e . "'" ); l0738($a7694f); $e9b207=i0d6b(); return count($e9b207) > 0; } function gf1ac($gaab9e){ global$_model,$_model_contractions,$_model_indexes,$_config; if (ka0f9($gaab9e)) { return true; } $g851f5=$_config['db_table_prefix']; if(array_key_exists($gaab9e,$_model)) { $p54ca8=array(); foreach($_model[$gaab9e] as $g1afd3){ list ($db0689,$m599dc)=$g1afd3; $p54ca8[] = "`". $db0689 ."` ". $_model_contractions[$m599dc]; } $y1b1cc=( "CREATE TABLE `". $g851f5.$gaab9e ."` ". "(". implode(" ,",$p54ca8) .") ". "ENGINE=MyISAM DEFAULT CHARSET=utf8" ); $m260ca=l0738($y1b1cc); foreach($_model_indexes[$gaab9e] as $o6a992){ $y1b1cc=( "ALTER TABLE `". $g851f5.$gaab9e ."` ". "ADD ". $o6a992 ); l0738($y1b1cc); } if ($m260ca) return true; } } function n9943($gaab9e,$sde17f,$mb512d='INSERT',$g07ccf=''){ global$_config,$_db; $id05b6="`". implode("`, `",array_keys($sde17f)). "`"; $gf09cc="'". implode("', '",array_values($sde17f)). "'"; $y1b1cc=( $mb512d ." INTO `". $_config['db_table_prefix'].$gaab9e ."` ". "(".$id05b6 .") VALUES (". $gf09cc .")". ($g07ccf? (' '. $g07ccf):'') ); if (l0738($y1b1cc)) { $sde17f['ID']=mysqli_insert_id($_db['link']); return $sde17f; } } function waa79($gaab9e,$sde17f,$a7692d=false,$o0f543=false){ global$_config; if(__LOG)__log('Model: update record, table <'. $gaab9e .'>'); $k6a7f2=array(); foreach(e2model__soft_fields_for_table_($gaab9e) as $g06e3d){ if(array_key_exists($g06e3d,$sde17f)) { $u10249=e7928($sde17f[$g06e3d]); if ($u10249[0]=='`'){ $lbcf11=$u10249; } else { $lbcf11="'". $u10249 ."'"; } $k6a7f2[] = '`'. $g06e3d .'`'."=". $lbcf11 .""; } } $yb5b39=array(); if(is_array($a7692d)) { foreach(e2model__soft_fields_for_table_($gaab9e) as $g06e3d){ if(array_key_exists($g06e3d,$a7692d)) { $yb5b39[] = '`'. $g06e3d .'`'."='". e7928($a7692d[$g06e3d]) ."'"; } } } if(count($yb5b39)) { $k56790=implode(" AND ",$yb5b39); } else { if (!array_key_exists('ID',$sde17f) or !is_numeric($sde17f['ID'])) { die ('API MISUSE: e2_update_record must be called with an ID field in $record when updating single row'); } $k56790="`ID`=". $sde17f['ID']; } if(count($k6a7f2) > 0){ $j91179=$o0f543? 'LOW_PRIORITY ':''; $y1b1cc=( "UPDATE ". $j91179 ."`". $_config['db_table_prefix'].$gaab9e ."` ". "SET ". implode(', ',$k6a7f2) ." WHERE ". $k56790 ); if (l0738($y1b1cc)) return true; } } function e2model__soft_fields_for_table_($gaab9e){ global$_model; $a2cb9d=array(); if(array_key_exists($gaab9e,$_model)) { foreach($_model[$gaab9e] as $g06e3d){ if (!in_array($g06e3d[1], array ('key'))) { $a2cb9d[] = $g06e3d[0]; } } } return $a2cb9d; } function e2m_install(){ global$_strings,$_superconfig,$_files_written,$_folders_written,$_diagnose; $a2cb9d=array(); if(e2_is_installed()) { e2_go_to(''); } else { if($_superconfig['disallow_installer']) { die ('Installer disabled by superconfig'); } if(__LOG)__log('Installer: not installed, present user with form'); $a2cb9d['title']=$_strings['pt--install']; $a2cb9d['heading']=$_strings['pt--install']; $zc50d0=$_strings['fb--begin']; $hd77d5['server'] = @$_COOKIE[c8c3b('install_db_server')]; $hd77d5['user_name'] = @$_COOKIE[c8c3b('install_db_user_name')]; $hd77d5['passw']=qee85(@$_COOKIE[c8c3b('install_db_passw')]); $hd77d5['name'] = @$_COOKIE[c8c3b('install_db_name')]; $a2cb9d['form-install'] = array ( 'form-action' => e83c8('e2s_install'), 'form-check-db-config-action' => e83c8('e2j_check_db_config'), 'form-list-databases-action' => e83c8('e2j_list_databases'), 'submit-text' => $zc50d0, 'retry-text' => $_strings['fb--retry'], 'db-server' => htmlspecialchars(@$hd77d5['server']? $hd77d5['server']:'localhost'), 'db-user' => htmlspecialchars(@$hd77d5['user_name']? $hd77d5['user_name']:'root'), 'db-password' => htmlspecialchars(DB_PASSWORD_RECOVER_AND_SHOW? (@$hd77d5['passw']) : ''), 'db-database' => htmlspecialchars(@$hd77d5['name']), ); $a2cb9d['form-install']['installation-possible?']=true; if(__LOG)__log('Installer: force directories'); foreach($_folders_written as $x45684){ @naf42($x45684); } if (!@isset ($_diagnose['ok?']))m8739(); if($_diagnose['ok?']) { if(__LOG)__log('Installer: everything is fine'); } else { if(__LOG)__log('Installer: problems, tell user'); $a2cb9d['form-install']['installation-possible?']=false; } } if(__LOG)__log('Installer: return'); return $a2cb9d; } function e2_instantiate($n2af72){ global$_instance; $_instance['version']=$n2af72; if (d6e52(USER_FOLDER. '/instance.psa',serialize($_instance))) { return true; } else { die ('Cannot instantiate v'. $n2af72 .': probably permission denied'); } } function e2s_instantiate($parameters){ global$_strings; if(e2_is_installed()) { die ('Remove the file "'. USER_FOLDER .'instance.psa" first'); } else { if(is_numeric($parameters['version'])) { if(e2_instantiate($parameters['version'])) { s8a40($_strings['gs--instantiated-version'] .' v'. $parameters['version'],E2E_MESSAGE); e2_go_to(e83c8('e2m_frontpage', array ('page' => 1))); die; } } } die ('Could not create instance of engine'); } function e2s_install(){ global$settings,$_strings,$_instance,$_config,$ffd6b1; if(e2_is_installed()) { e2_go_to(e83c8('e2m_install')); die; } else { e2_drop_all_kinds_of_cache(); $hd77d5['server'] = @$_POST['db-server']; $hd77d5['user_name'] = @$_POST['db-user']; $hd77d5['passw'] = v1305(@$_POST['db-password']); $hd77d5['name'] = @$_POST['db-database']; if ( ($k2a304=mysqli_connect( $hd77d5['server'],$hd77d5['user_name'],$_POST['db-password'] )) === false ){ s8a40($_strings['er--cannot-connect-to-db'],E2E_DATABASE_ERROR); e2_go_to(e83c8('e2m_install')); die; } $paae42=e2_model_data_check($k2a304,$hd77d5['name']); $k0e88b=false; if ($paae42['occupied'] and $paae42['migrateable']) { if(__LOG)__log('Installer: DB data exists and migrateable'); $k0e88b=true; } elseif ($paae42['occupied']) { if(__LOG)__log('Installer: DB data exists, but incomplete'); s8a40($_strings['er--db-data-incomplete'],E2E_DATABASE_ERROR); e2_go_to(e83c8('e2m_install')); die; } $xb2c6c=ta618(@$_POST['gmt-offset']); foreach ($hd77d5 as $d8ce4b => $w9e366){ uc64a('install_db_' .$d8ce4b,$w9e366); } @session_start(); if (!array_key_exists('password',$_POST) or trim($_POST['password']) == ''){ s8a40($_strings['er--no-password-entered'],E2E_USER_ERROR); e2_go_to(e83c8('e2m_install')); die; } $p88162=trim($_POST['password']); $a2d6d8['sessions'] = array (array ( 'stamp' => time(), 'remote_ip' => $_SERVER['REMOTE_ADDR'], 'key_hash' => be8ed(true), 'ua' => $_SERVER['HTTP_USER_AGENT'], )); $d444bc=true; if (!g1d21($a2d6d8)) { s8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); $d444bc=false; } if (!@d6e52(USER_FOLDER.'password-hash.psa',serialize(c4c49($p88162)))) { s8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); $d444bc=false; } if (!$k0e88b){ $settings=array(); } $settings['db']=$hd77d5; $settings['timezone']=$xb2c6c; $settings['template']=DEFAULT_TEMPLATE; $settings['language']=DEFAULT_LANGUAGE; if (!@d6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { s8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); $d444bc=false; } if ($d444bc){ if ($k0e88b){ if(__LOG)__log('Installer: No need to create DB'); $wba46b=v0f7c(); if ($wba46b){ if(__LOG)__log('Installer: Migrate'); bbb8d(); } else { if(__LOG)__log('Installer: DB not OK'); s8a40($_strings['er--double-check-db-params']); } } else { if(__LOG)__log('Installer: Creating DB...'); $wba46b=( gf1ac('Notes') and gf1ac('Comments') and gf1ac('Keywords') and gf1ac('NotesKeywords') and gf1ac('Aliases') and gf1ac('Actions') ); if (!$wba46b){ if(__LOG)__log('Installer: DB not OK'); s8a40($_strings['er--double-check-db-params']); } } if ($wba46b){ if(__LOG)__log('Installer: Search index...'); $dddece=d476c(); $dddece -> erase(); c198f(); if(__LOG)__log('Installer: DB OK, instantiating...'); e2_instantiate(E2_VERSION); if(__LOG)__log('Installer: Done'); if(__LOG)__log('Installer: Complete'); } ecc38(e83c8('e2s_bsi_step', array ())); e2_go_to(); die; } else { e2_go_to(e83c8('e2m_install')); die; } } } function e2_is_installed(){ global$_instance; return (bool)$_instance; } function e2_make_sure_that_installed(){ global $r57de2,$aa57c1,$_instance,$_superconfig; if(e2_is_installed()) { if(E2_VERSION < $_instance ['version']) { if(IGNORE_VERSION_MISMATCH) return; if(__LOG)__log('Installer: cannot downdate'); header('HTTP/1.1 503 Service Unavailable'); die ('E2 does not support automatic downgrade.'); } elseif(E2_VERSION > $_instance ['version']) { if(__LOG)__log('Installer: need to update'); header('Location: http://'. $r57de2.$aa57c1 .'/perform_update/'); header('Location: '. e83c8('e2s_update_perform')); die; } else { if(__LOG)__log('Installer: no job for me'); return; } } if(__LOG)__log('Installer: not installed {'); if ((strpos($_SERVER['SERVER_SOFTWARE'],'Apache')===0)) { if(__LOG)__log('Installer: running on Apache'); $befe79=DEFAULTS_FOLDER.'default.htaccess'; $md5c54=false; if (!is_file($befe79)) { echo 'File not found: '.$befe79. '. Please use the full E2 installation package.'; die; } if(is_file('.htaccess')) { if(__LOG)__log('Installer: there is a .htaccess file in the installation directory'); $we6f97=file_get_contents($befe79); $rc6680=file_get_contents('.htaccess'); if ($rc6680!=$we6f97){ $md5c54=true; $j6a9d4=$ad1813='.htaccess.old'; $h3c549=1; while (is_file($ad1813)) { $ad1813=$j6a9d4 .'.'. $h3c549 ++; } if(__LOG)__log('Installer: existing .htaccess wrong, backing up as <'. $ad1813 .'>'); if (!@rename('.htaccess',$ad1813)) { if(__LOG)__log('Installer: fuck'); echo 'Looks like you are using Apache and have put an incorrect ".htaccess" file in the installation directory. Additionally, the installer was not able to back up your existing ".htaccess" file in order to replace it with the correct one. Please use the full E2 installation package and grant write access on the installation target directory, all the files and subdirectories.'; die; } } } else { $md5c54=true; } if ($md5c54){ if(__LOG)__log('Installer: writing a correct .htaccess file'); if (!@copy($befe79,'.htaccess')) { if(__LOG)__log('Installer: fuck'); echo 'The installer was not able to create a correct ".htaccess" file. Please grant write access on the installation target directory.'; die; } } } if($_superconfig['disallow_installer']) { die ('Not installed'); } else { $u601f0=e83c8('e2m_install'); if(__LOG)__log('Installer: will need to install, going to '. $u601f0); if(__LOG)__log('}'); e2_go_to($u601f0); die; } } function e2j_check_db_config(){ echo x55fd(); die; } function e2j_list_databases(){ $jcf1e8=$zee11c=$h5f4dc=''; if(array_key_exists('db-server',$_POST)) $jcf1e8= $_POST['db-server']; if(array_key_exists('db-user',$_POST)) $zee11c= $_POST['db-user']; if(array_key_exists('db-password',$_POST))$h5f4dc=$_POST['db-password']; $o32e95=bb154($jcf1e8,$zee11c,$h5f4dc); if ($o32e95) die (implode('|',$o32e95)); die; } function bbb8d(){ global$_db,$_db_error,$_config,$_model; $g851f5=$_config['db_table_prefix']; if(__LOG)__log('Migrate: start'); uc1ed($g851f5); l0738('SET sql_quote_show_create=1'); foreach(array_keys($_model) as $gaab9e){ gf1ac($gaab9e); $a7694f="SHOW CREATE TABLE `". $g851f5.$gaab9e ."`"; if(__LOG)__log('Migrate: '. $a7694f); if (l0738($a7694f)) { $h4fded[$gaab9e]=i0d6b(); $h4fded[$gaab9e]=$h4fded[$gaab9e][0]['Create Table']; } else { die ('Database table "'. $g851f5 .$gaab9e .'" not accessible during migration. Check your database availability'); } if(__LOG)__log('Migrate: '. print_r($h4fded,true)); } if (!strstr($h4fded['Notes'],'`FormatterID`')) { l0738( "ALTER TABLE `". $g851f5."Notes` ". "ADD `FormatterID` VARCHAR( 32 ) DEFAULT 'calliope' NOT NULL AFTER `Text`" ); } if (!strstr($h4fded['Notes'],'`OriginalAlias`')) { l0738( "ALTER TABLE `". $g851f5."Notes` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `FormatterID`" ); } if (!strstr($h4fded['Notes'],'KEY `Stamp` (`Stamp`)')) { l0738( "ALTER TABLE `". $g851f5."Notes` ". "ADD INDEX (`Stamp`);" ); } if(strstr($h4fded['Notes'],'`IP`')) { l0738( "ALTER TABLE `". $g851f5."Notes` ". "DROP `IP`" ); } l0738( "ALTER TABLE `". $g851f5."Notes` ". "CHANGE `Text` `Text` TEXT" ); if (!strstr($h4fded['Notes'],'`IsIndexed`')) { l0738( "ALTER TABLE `". $g851f5."Notes` ". "ADD `IsIndexed` TINYINT( 1 ) DEFAULT '0' NOT NULL" ); } if (!strstr($h4fded['Notes'],'`Uploads`')) { l0738( "ALTER TABLE `". $g851f5."Notes` ". "ADD `Uploads` TEXT AFTER `OriginalAlias`" ); } if (!strstr($h4fded['Comments'],'KEY `NoteID` (`NoteID`)')) { l0738( "ALTER TABLE `". $g851f5."Comments` ". "ADD INDEX (`NoteID`);" ); } l0738( "ALTER TABLE `". $g851f5."Comments` ". "CHANGE `Text` `Text` TEXT" ); l0738( "ALTER TABLE `". $g851f5."Comments` ". "CHANGE `Reply` `Reply` TEXT" ); if (!strstr($h4fded['Keywords'],'`OriginalAlias`')) { l0738( "ALTER TABLE `". $g851f5."Keywords` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `Keyword`" ); } l0738( "ALTER TABLE `". $g851f5."Keywords` ". "CHANGE `Description` `Description` TEXT" ); if (!strstr($h4fded['Keywords'],'`Uploads`')) { l0738( "ALTER TABLE `". $g851f5."Keywords` ". "ADD `Uploads` TEXT AFTER `Description`" ); } if (!strstr($h4fded['Aliases'],'KEY `Alias` (`Alias`)')) { l0738( "ALTER TABLE `". $g851f5."Aliases` ". "ADD INDEX (`Alias`);" ); } if (!strstr($h4fded['Aliases'],'KEY `EntityID` (`EntityID`)')) { l0738( "ALTER TABLE `". $g851f5."Aliases` ". "ADD INDEX (`EntityID`);" ); } if (!strstr($h4fded['Aliases'],'`EntityType`')) { l0738( "ALTER TABLE `". $g851f5."Aliases` ". "ADD `EntityType` VARCHAR( 1 ) DEFAULT '' NOT NULL AFTER `ID`" ); } l0738( "UPDATE `". $g851f5."Aliases` ". "SET `EntityType` = 'n' ". "WHERE `EntityType` = ''" ); return true; } function uc1ed($g851f5){ global$_model; foreach(array_keys($_model) as $vd2ffa){ l0738( "SHOW TABLE STATUS LIKE '". $g851f5.$vd2ffa ."' " ); $k4b43b=i0d6b(); if(count($k4b43b) > 0){ $fd89e2=$k4b43b[0]['Collation']; if ($fd89e2!='utf8_general_ci'){ if(__LOG)__log('Migrate: Convert table '. $vd2ffa. ' to UTF8'); l0738( "ALTER TABLE `". $g851f5.$vd2ffa ."` ". "CONVERT TO CHARACTER SET utf8 COLLATE utf8_general_ci" ); } } } } function e2s_migrate(){ bbb8d(); die ('Database migration finished.'); } function e2s_update_perform(){ global$_instance,$_model,$settings,$_config,$_diagnose; $md98a0=max((int) ($_instance['version']), 2285); if($_instance['version']==E2_VERSION){ d4930(); die; } if ($md98a0 < 2587){ bc5a6('caches/*'); rmdir('caches'); } if ($md98a0 < 2691){ $settings=e2_utf8_version_of_array_($settings); if (!@d6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { s8a40($_strings['er--cannot-save-data'],E2E_PERMISSIONS_ERROR); z4006(); } } if ($md98a0 < 2921){ $settings['template']='plain'; } @unlink(USER_FOLDER. 'last-update.psa'); @unlink(CACHES_FOLDER.'index.xml'); @naf42(CACHES_FOLDER); @naf42(BACKUP_FOLDER); @naf42(PICTURES_FOLDER .'remote/'); @naf42(THUMBNAILS_FOLDER .'remote/'); if (@$settings['template']=='')$settings['template']=DEFAULT_TEMPLATE; if (isset ($settings['appearance']['hot_frontpage'])) { unset($settings['appearance']['hot_frontpage']); } if (isset ($settings['db']['table_prefix'])) { if($settings['db']['table_prefix'] != @$_config['db_table_prefix']) { die ('You’ve been using a database with a table prefix “'. $settings['db']['table_prefix'] .'”. Now this should be set in the configuration. Please add the following line to the file user/config.php:<br /><br />$_config[\'db_table_prefix\'] = \''. $settings['db']['table_prefix'] .'\';<br /><br />Then refresh this page.'); } else { unset($settings['db']['table_prefix']); } } if (isset ($settings['comments']['on'])) { if (!$settings['comments']['on']) { @l0738( "UPDATE LOW_PRIORITY `". $_config['db_table_prefix']."Notes` ". "SET `IsCommentable`=0" ); } $settings['comments']['default_on'] = (bool)$settings['comments']['on']; unset($settings['comments']['on']); } if ( is_file(USER_FOLDER.'settings.json') and is_file(USER_FOLDER.'settings.psa') ) { @unlink(USER_FOLDER.'settings.psa'); } if (!@d6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { s8a40($_strings['er--cannot-save-data'],E2E_PERMISSIONS_ERROR); } e2_drop_all_kinds_of_cache(); bbb8d(); if ($md98a0 < 3095){ if (za521()) { $dddece=d476c(); $dddece -> erase(); } c198f(); } $_diagnose['need?']=true; uc64a('diagnose','1'); e2_instantiate(E2_VERSION); if (he852()) { s8a40(e2l_get_string('gs--updated-successfully', array ( 'from' => 'v'. $md98a0, 'to' => 'v'. $_instance['version'], )), E2E_MESSAGE); } e2_go_to(); die; } function v0f7c(){ global$settings,$_db,$_db_error; if (@$_db['connected']!==true){ $gd7909=$settings['db']['passw']; if ( ( $x3d801=@mysqli_connect( $settings['db']['server'], $settings['db']['user_name'], $gd7909 ) ) !== false ){ mysqli_close($x3d801); if(__LOG)__log('DB: storing password in a new way'); $gd7909=v1305($gd7909); $settings['db']['passw']=$gd7909; @d6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE)); } $gd7909=qee85($gd7909); if ( ( $_db['link'] = @mysqli_connect( $settings['db']['server'], $settings['db']['user_name'], $gd7909 ) ) !== false ){ if(mysqli_select_db($_db['link'],$settings['db']['name'])) { $_db_error=DB_OK; $_db['connected']=true; return true; } else { $_db_error=DB_CANNOT_FIND; return false; } } else { $_db_error=DB_CANNOT_CONNECT; return false; } } else { $_db_error=DB_OK; return true; } } function l0738($a7694f){ global $n11755,$_db,$_db_error,$_strings; if(__LOG)__log('DB: query <'. $a7694f .'>'); $k9b54f=u7f78(); @$n11755 ++; if (v0f7c()) { $v8e815='utf8'; if ( version_compare(mysqli_get_server_info($_db['link']), '4.1','>=') and @$_db['latest_setnames']!=$v8e815 ){ mysqli_query($_db['link'],"SET NAMES ". $v8e815); $_db['latest_setnames']=$v8e815; } if($_db['result']=mysqli_query($_db['link'],$a7694f)) { if(__LOG)__log('DB: done in '. round(u7f78()-$k9b54f,3)); $_db_error=DB_OK; return true; } else { s8a40($_strings['er--error-in-query']. ': <br /><code>'.nl2br($a7694f).'</code><br />'. mysqli_error($_db['link']), E2E_DATABASE_ERROR); $_db_error=DB_QUERY_ERROR; return false; } } else { if($_db_error==DB_CANNOT_FIND){ if(__LOG)__log('DB: cannot find db'); s8a40($_strings['er--cannot-find-db'],E2E_DATABASE_ERROR); } elseif($_db_error==DB_CANNOT_CONNECT){ if(__LOG)__log('DB: cannot connect to db'); s8a40($_strings['er--cannot-connect-to-db'],E2E_DATABASE_ERROR); } else { if(__LOG)__log('DB: db error '. $_db_error); s8a40($_strings['er--error-occurred'].' ('. $_db_error .')',E2E_DATABASE_ERROR); } return false; } } function i0d6b($m599dc=MYSQLI_ASSOC){ global$_db; $a2cb9d=array(); while ($c0cc17=@mysqli_fetch_array($_db['result'],$m599dc)) { foreach ($c0cc17 as $y865c0 => $w4921c){ if(is_string($w4921c)) { $c0cc17[$y865c0]=$w4921c; } } $a2cb9d[] = $c0cc17; } return $a2cb9d; } function e7928($vb45cf){ global$_db; v0f7c(); return mysqli_real_escape_string($_db['link'],$vb45cf); } function eb488(){ echo '<pre>'; echo 'Sifting backups...<br>'; $y10ae9=array(); foreach(glob(BACKUP_FOLDER. '*.sql') as $j8c7dd){ if(preg_match('/^backup\-(\d+)\-(\d+)\-(\d+)\-at\-(\d+)\-(\d+)\-(\d+)\.sql$/is',basename($j8c7dd),$u9c28d)) { list (, $z41529,$h6f8f5,$c8277e,$e2510c,$y865c0,$d03c7c)=$u9c28d; $o96b8c=gmmktime($e2510c,$y865c0,$d03c7c,$h6f8f5,$c8277e,$z41529); $y10ae9[$o96b8c]=$j8c7dd; } } if(count($y10ae9) > 3){ echo 'More than 3 backups, time to sift...<br>'; $h536a1=-1; $xf46c9=array (SECONDS_IN_A_MINUTE,SECONDS_IN_AN_HOUR,SECONDS_IN_A_DAY, -1); $y865c0=0; foreach(array_reverse($y10ae9,true) as $o96b8c => $j8c7dd){ echo '-> '. $j8c7dd .' ('. gmdate('r',$o96b8c) .')<br>'; if ($h536a1 == -1){ echo '   latest, leave<br>'; $h536a1=$o96b8c; } elseif ($xf46c9[$y865c0] == -1){ echo '   too old, remove<br>'; unlink($j8c7dd); } else { if ($h536a1-$o96b8c < $xf46c9[$y865c0]) { echo '   no need (not long ago), remove<br>'; unlink($j8c7dd); } else { $y865c0 ++; echo '   ok, leave, set interval to '. $xf46c9[$y865c0] .'<br>'; $h536a1=$o96b8c; } } } } else { echo 'No need to sift<br>'; } echo '</pre>'; return; } function e2s_dump(){ global$_model,$_db,$_config; if (v0f7c()) { if($_db['link']) { $y68720=time() - (SECONDS_IN_A_DAY); l0738( "DELETE FROM `". $_config['db_table_prefix']."Actions` ". "WHERE (`Stamp` < ". (time() - (SECONDS_IN_A_DAY*7)) ." AND `HitCount` <= 1) ". "OR (`Stamp` < ". (time() - (SECONDS_IN_A_MONTH)) ." AND `HitCount` <= 5)". "OR (`Stamp` < ". (time() - (SECONDS_IN_A_YEAR)) ." AND `HitCount` <= 10)" ); $u9ab2e=array(); foreach(array_keys($_model) as $gaab9e){ $u9ab2e[] = $_config['db_table_prefix'].$gaab9e; } e2_backup( $_db['link'], $u9ab2e, BACKUP_FOLDER .'backup-'.gmdate('Y-m-d-\a\t-H-i-s').'.sql' ); eb488(); die ('Backed up.'); } } die ('Could not backup.'); } define('ALIAS_MAX_LENGTH',64); function e2ali__alias_from_title_($y36cd3){ global$_config; $a3e891=$y36cd3; if(array_key_exists('autoreplace_for_aliases',$_config)) { $a3e891=strtr( $a3e891, $_config['autoreplace_for_aliases'] ); } $a3e891=e2l_transliterate($a3e891); $a3e891=str_replace('\'','',$a3e891); $a3e891=str_replace('’','',$a3e891); $a3e891=str_replace(chr(146),'',$a3e891); $k17901=''; for ($y865c0=0; $y865c0 < strlen($a3e891); ++ $y865c0){ if ( (ord($a3e891[$y865c0]) >= 48 and ord($a3e891[$y865c0]) <= 57) or (ord($a3e891[$y865c0]) >= 65 and ord($a3e891[$y865c0]) <= 90) or (ord($a3e891[$y865c0]) >= 97 and ord($a3e891[$y865c0]) <= 122) or 0 ){ $k17901.=$a3e891[$y865c0]; } else { $k17901.='-'; } } $k17901=preg_replace('/\-+/','-',$k17901); $k17901=trim($k17901,'-'); $k17901=strtolower($k17901); if ($k17901=='-')$k17901=''; $k17901=substr($k17901,0,ALIAS_MAX_LENGTH); return $k17901; } function e2_aliasrec_of_alias_($q72487){ global$_config; if (!$q72487) return false; if (l0738( "SELECT * FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `Alias` = '" .$q72487. "' ". "ORDER BY Stamp LIMIT 1" )) { $result=i0d6b(); if(count($result)==1){ return$result[0]; } } } function e2_active_alias_for_page_($e89111,$vdffc4){ global$_config,$_e2_active_aliases; if ($vdffc4){ if ( is_array($_e2_active_aliases) and array_key_exists($e89111.$vdffc4,$_e2_active_aliases) ) { return @$_e2_active_aliases[$e89111.$vdffc4]; } else { if (l0738( "SELECT `Alias` ". "FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `EntityType` = '". $e89111 ."' ". "AND `EntityID` = ". $vdffc4 ." ". "ORDER BY `Stamp` DESC LIMIT 1" )) { $result=i0d6b(); $q72487=$result[0]['Alias']; } if (!$q72487 and $e89111==ENTITY_TYPE_TAG){ if (l0738( "SELECT OriginalAlias FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE ID = '". ((int)$vdffc4)."'") ) { $result=i0d6b(); $q72487=$result[0]['OriginalAlias']; } } $_e2_active_aliases[$e89111.$vdffc4]=$q72487; } return @$_e2_active_aliases[$e89111.$vdffc4]; } } function xd712($t15d61,$e89111,$vdffc4,$y36cd3,$wfb873=1){ if ($t15d61=='set' and (!$e89111 or !$vdffc4)) return false; $k17901=e2ali__alias_from_title_($y36cd3); if ($wfb873 > 1){ $e9f626='-'. $wfb873; $k17901=substr($k17901,0,ALIAS_MAX_LENGTH-strlen($e9f626)) . $e9f626; } if ( $k17901!='' and $hc45dd=e2_aliasrec_of_alias_($k17901) ) { $x6bae4=$hc45dd['EntityType']; $y1123c=$hc45dd['EntityID']; if ( (($vdffc4 and $y1123c==$vdffc4) and ($e89111 and $x6bae4==$e89111)) or $k17901!=e2_active_alias_for_page_($x6bae4,$y1123c) ) { if ($t15d61=='find'){ return $k17901; } if ($t15d61=='set'){ if (waa79('Aliases', array ( 'ID' => $hc45dd['ID'], 'EntityType' => $e89111, 'EntityID' => $vdffc4, 'Alias' => $k17901, 'Stamp' => time(), ))) { return $k17901; } } } else { return xd712($t15d61,$e89111,$vdffc4,$y36cd3,$wfb873+1); } } else { if ($e89111 and $vdffc4 and $k17901==''){ if(e2_active_alias_for_page_($e89111,$vdffc4)==''){ return ''; } } if ( $e89111==ENTITY_TYPE_TAG and $jd62e3=g8770($k17901) ) { if ($jd62e3['ID']!=$vdffc4){ return xd712($t15d61,$e89111,$vdffc4,$y36cd3,$wfb873+1); } } if ($t15d61=='find'){ return $k17901; } if ($t15d61=='set'){ if (n9943('Aliases', array ( 'EntityType' => $e89111, 'EntityID' => $vdffc4, 'Alias' => $k17901, 'Stamp' => time(), ))) { return $k17901; } } } return ''; } function e2m_note($parameters=array ()) { global$settings,$r57de2,$_config,$_strings; if(__LOG)__log('Note {'); $waad65=$parameters['*note']; if($_config['note_url_slidedown']) { $v229c3=$parameters['day-number']; $e80791=-1; if(__LOG)__log('Slidedown {'); while (1){ if ( $waad65==false or !($waad65['IsVisible'] or he852()) ) { if ($e80791 == -1){ $e80791=zf9fb( $parameters['year'],$parameters['month'],$parameters['day'] ); } if ($v229c3 > 1){ -- $v229c3; $waad65=@$e80791[$v229c3-1]; continue; } return e2_error404_mode(); } else { break; } } if(__LOG)__log('redirect if necessary'); if ($v229c3!=$parameters['day-number']) { $parameters['day-number']=$v229c3; e2_go_to(e83c8('e2m_note',$parameters)); } if(__LOG)__log('} // Slidedown'); } if ($waad65==false){ return e2_error404_mode(); } $jd58c0=e83c8('e2m_note',$parameters); d3010( $_strings['nf--comments-on-this-post'], e83c8('e2m_note_comments_rss',$parameters) ); if(__LOG)__log('Navigation {'); $tfcb08=ycca7($waad65,'prev'); $nd0cab=ycca7($waad65,'next'); if ($tfcb08){ $db3b32['prev-href']=e83c8('e2m_note', array ('*note' => $tfcb08)); $db3b32['prev-title']=m6f10(htmlspecialchars(zea9c($tfcb08),ENT_NOQUOTES,HSC_ENC)); } if ($nd0cab){ $db3b32['next-href']=e83c8('e2m_note', array ('*note' => $nd0cab)); $db3b32['next-title']=m6f10(htmlspecialchars(zea9c($nd0cab),ENT_NOQUOTES,HSC_ENC)); } $db3b32['title']=$_strings['nm--posts']; $db3b32['timeline?']=false; $db3b32['this-title']=m6f10(htmlspecialchars(zea9c($waad65),ENT_NOQUOTES,HSC_ENC)); if(__LOG)__log('}'); if(__LOG)__log('packaging...'); $waad65['_']['_id']=$waad65['ID']; $waad65['_']['_ord']=0; $waad65['_']['_ord_max']=0; $q8e4cd=m6791($waad65); if(__LOG)__log('update read count...'); $dff089=time(); $dff089=$dff089 - ($dff089 % SECONDS_IN_AN_HOUR); n9943( 'Actions', array ( 'EntityID' => $waad65['ID'], 'Stamp' => $dff089, 'HitCount' => 1, ), 'INSERT LOW_PRIORITY', 'ON DUPLICATE KEY UPDATE `HitCount` = `HitCount` + 1' ); $je35b1=''; $w01a5b=''; $u33ff2=false; $b905f7=false; $w7bae4=array(); $nd09b4=''; if (he852()) { $t83625=e2_note_cache_filename_with_id_($waad65['_']['_id'] .'-comments-author'); } else { $t83625=e2_note_cache_filename_with_id_($waad65['_']['_id'] .'-comments'); } $b1e8cc=null; if(CACHE_NOTES_COMMENTS and is_file($t83625)) { $b1e8cc=@unserialize(file_get_contents($t83625)); } if(__LOG)__log('Comments {'); if(is_array($b1e8cc)) { if(__LOG)__log('retrieve cached ctree'); $je35b1=$b1e8cc; } else { if(__LOG)__log('assemble ctree...'); $fc1fdc=l1baf($waad65['ID'],"ORDER BY `Stamp`"); $ga5d49=array(); $s04c25=true; foreach ($fc1fdc as $d8ce4b => $o4032b){ if ($o4032b['IsVisible']) { $o4032b['_']['_id']=$o4032b['ID']; $o4032b['_']['_ord']=$d8ce4b; $o4032b['_']['_ord_max']=count($fc1fdc)-1; $g06d4c=i86f8( $waad65, $o4032b, $d8ce4b+1 ); if ($g06d4c['new?'] and $s04c25){ $g06d4c['first-new?']=true; $s04c25=false; } $ga5d49[] = $g06d4c; } } $je35b1=$ga5d49; if(CACHE_NOTES_COMMENTS)d6e52($t83625,serialize($je35b1)); } if(__LOG)__log('} // Comments'); $w01a5b=e83c8('e2m_note_comments_rss', array ('*note' => $waad65)); if ($q8e4cd['commentable-now?']) { $f80f02=h66aa($waad65); } if (he852() and ob387($waad65,NOTE_COMMENTABLE_NOW_CONDITIONALLY)) { if ($waad65['IsCommentable']) { $w7bae4['href']=e83c8('e2m_note_flag', array ( '*note' => $waad65, 'flag' => 'IsCommentable', 'value' => 0, )); $w7bae4['text']=$_strings['bt--close-comments-to-post']; } else { $w7bae4['href']=e83c8('e2m_note_flag', array ( '*note' => $waad65, 'flag' => 'IsCommentable', 'value' => 1, )); $w7bae4['text']=$_strings['bt--open-comments-to-post']; } } if ( he852() and array_key_exists('new-comments-count',$q8e4cd) and $q8e4cd['new-comments-count'] ) { if(__LOG)__log('mark comments as not new'); e2_drop_caches_for_note_($v21158); waa79('Comments', array ('IsNew' => 0), array ('NoteID' => $waad65['_']['_id'])); } if(__LOG)__log('more work...'); $ge70c4['class']='note'; $ge70c4['title']=zea9c($waad65); $ge70c4['pages']=$db3b32; $ge70c4['summary']=$q8e4cd['summary']; $ge70c4['notes'] = array ('only' => $q8e4cd); if ($je35b1) $ge70c4['comments']=$je35b1; if ($w01a5b) $ge70c4['comments-rss-href']=$w01a5b; if ($w7bae4) $ge70c4['comments-toggle']=$w7bae4; if ($f80f02) $ge70c4['form-comment']=$f80f02; if(__LOG)__log('} // Note'); return $ge70c4; } function e2m_note_hitinfo($parameters=array ()) { global$_config; $waad65=$parameters['*note']; echo '<table>'; echo '<tr valign="top">'; foreach ( array ('day','week','month','year','ever') as $na0acf ){ echo '<td>'; echo '<h2>'. $na0acf.' hits</h2>'; echo '<p>'; $z632a2=time()-v35c3($na0acf); if (l0738( "SELECT SUM(`HitCount`) HitCount FROM `". $_config['db_table_prefix']."Actions` ". "WHERE `EntityID` = ". $waad65['ID'] ." ". "AND `Stamp` > ". $z632a2 ." ". "GROUP BY `EntityID`" )) { $e9b207=i0d6b(); echo $e9b207[0]['HitCount']; } echo '</p>'; if (l0738( "SELECT n.`ID`, n.`Title`, n.`IsFavourite`, a.`EntityID`, SUM(a.`HitCount`) HitCount ". "FROM `". $_config['db_table_prefix']."Actions` a, ". "`". $_config['db_table_prefix']."Notes` n  ". "WHERE a.`Stamp` > ". $z632a2 ." ". "AND a.`EntityID` = n.`ID` ". "GROUP BY a.`EntityID` ". "ORDER BY `IsFavourite` DESC, HitCount DESC ". "LIMIT 10" )) { echo mysqli_error(); $e9b207=i0d6b(); echo '<h3>Popular</h3>'; foreach ($e9b207 as $k4b43b){ echo '<p><a href="'. $k4b43b['ID']. '">'. $k4b43b['Title'] .'</a> ('. $k4b43b['HitCount'] .')</p>'; } } } die; } function e2m_note_withdraw($parameters=array ()) { global$_strings; $rea59a=$parameters['*note']; if (!$rea59a) return e2_error404_mode(); $rea59a['IsPublished']=0; $rea59a['IsCommentable']=0; $rea59a['IsVisible']=1; $rea59a['Stamp']=time(); $rea59a['IP']=$_SERVER['REMOTE_ADDR']; if($parameters['alias']) { $rea59a['OriginalAlias']=$parameters['alias']; } else { $rea59a['OriginalAlias']=xd712( 'find',ENTITY_TYPE_NOTE,$rea59a['ID'],$rea59a['Title'] ); } e2_drop_caches_for_note_($rea59a['ID']); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); if ($rea59a['IsFavourite']) { @unlink(CACHE_FILENAME_FAVS); } if (waa79('Notes',$rea59a)) { a10fe($rea59a['ID']); p5b68($rea59a); xd712('set',ENTITY_TYPE_NOTE,$rea59a['ID'],''); e2_go_to(e83c8('e2m_draft', array ( 'draft' => $v21158, 'oalias' => $rea59a['OriginalAlias'], ))); } else { d4930(); } } function e2m_note_delete($parameters=array()) { global$_strings; $rea59a=$parameters['*note']; if (!$rea59a) return e2_error404_mode(); $pf91b2=!$rea59a['IsPublished']; if ($pf91b2){ $n72bd7=e2l_get_string('gs--draft-will-be-deleted', array ( 'draft' => htmlspecialchars($rea59a['Title'],ENT_NOQUOTES,HSC_ENC), )); } else { $n72bd7=e2l_get_string('gs--post-will-be-deleted', array ( 'post' => htmlspecialchars($rea59a['Title'],ENT_NOQUOTES,HSC_ENC), )); } $od5d3d=$pf91b2? $_strings['pt--draft-deletion']:$_strings['pt--post-deletion']; $t57529=array ( '.note-id' => $rea59a['ID'], '.is-draft' => (int)$pf91b2, 'note-title' => htmlspecialchars($rea59a['Title'],ENT_COMPAT,HSC_ENC), 'caution-text' => $n72bd7, 'form-action' => e83c8('e2s_note_delete'), 'submit-text' => $_strings['fb--delete'], 'draft?' => (int)$pf91b2, ); if ($rea59a['IsPublished']) { $t57529['withdraw-href']=e83c8( 'e2m_note_withdraw',$parameters ); } $a2cb9d=array ( 'title' => $od5d3d. ': '. htmlspecialchars($rea59a['Title'],ENT_NOQUOTES,HSC_ENC), 'heading' => $od5d3d, 'form' => 'form-note-delete', 'form-note-delete' => $t57529, ); return $a2cb9d; } function e2m_note_flag_favourite($parameters){ global$_config; $parameters['flag']='IsFavourite'; if (j7e6c($parameters)) { $r67142=$parameters; $r67142['value'] = !$parameters['value']; if($parameters['value']==1){ $z99859=e83c8('e2m_note_flag_favourite',$r67142); $v1fa03='on-rehref|'. $z99859; } else { $z99859=e83c8('e2m_note_flag_favourite',$r67142); $v1fa03='off-rehref|'. $z99859; } } else { $v1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($v1fa03); } else { e2_go_to(e83c8('e2m_note',$parameters)); die; } } function e2m_note_flag($parameters){ j7e6c($parameters); if(array_key_exists('draft',$parameters)) { e2_go_to(e83c8('e2m_draft',$parameters)); } else { e2_go_to(e83c8('e2m_note',$parameters)); } die; } function j7e6c($parameters){ $v21158=$parameters['*note']['ID']; if (!is_numeric($v21158)) { return e2_error404_mode(); } e2_drop_caches_for_note_($v21158); if($parameters['flag']=='IsFavourite'){ @unlink(CACHE_FILENAME_FAVS); } $result=waa79('Notes', array ( 'ID' => $v21158, $parameters['flag'] => (int) ($parameters['value']==1), )); return$result; } function e2m_note_use_formatter($parameters){ $v21158=$parameters['*note']['ID']; if (!is_numeric($v21158)) { return e2_error404_mode(); } e2_drop_caches_for_note_($v21158); if (!$parameters['*note']['IsPublished']) { @unlink(CACHE_FILENAME_DRAFTS); } if(in_array($parameters['formatter'], array ('calliope','raw','neasden'))) { $result=waa79('Notes', array ( 'ID' => $v21158, 'FormatterID' => $parameters['formatter'], )); echo 'formatter set to '. $parameters['formatter']; } else { echo 'unknown formatter'; } die; } function e2m_note_edit($parameters=array ()) { return n7dd3('edit',$parameters); } function n7dd3($l60cd8,$parameters=array ()) { global$full_blog_url,$_strings,$_config; $od5d3d=$_strings['pt--new-post']; $vf74f5=$_strings['pt--new-post']; $v21158='new'; $n9763c=$_config['default_formatter']; if ($l60cd8=='edit'){ $rea59a=$parameters['*note']; if (!$rea59a) return e2_error404_mode(); if ($rea59a){ if ($rea59a['IsPublished']) { $vf74f5=$_strings['pt--edit-post']; $l3aa13=''; $q72487=$parameters['alias']; } else { $vf74f5=$_strings['pt--edit-draft']; $l3aa13=xd712( 'find',ENTITY_TYPE_NOTE,$rea59a['ID'],$rea59a['Title'] ); if (@$rea59a['OriginalAlias']) { $q72487=$rea59a['OriginalAlias']; } else { $q72487=$l3aa13; } } } $v21158=$rea59a['ID']; $n9763c=$rea59a['FormatterID']; $od5d3d=zea9c($rea59a); } $l04868=j5d57(); $s77b75=array(); foreach ($l04868 as $ud7df5){ $s77b75[] = $ud7df5['tag']; } $id2e3e=array(); if ($l60cd8=='edit' and count($s77b75)) { $l04868=za463($rea59a['ID']); foreach ($l04868 as $ud7df5){ $id2e3e[] = htmlspecialchars($ud7df5['Keyword'],ENT_NOQUOTES,HSC_ENC); } } $xc93df=array(); foreach ($s77b75 as $ud7df5){ $ffd2ef['name']=$ud7df5; $ffd2ef['selected?']=in_array($ud7df5,$id2e3e); $xc93df[] = $ffd2ef; } $v9dbb8=''; $id2e3e=implode(', ',$id2e3e); if ($id2e3e)$v9dbb8=$id2e3e; if ($l60cd8=='write'){ $zc50d0=$_strings['fb--save-and-preview']; } if ($l60cd8=='edit'){ if(array_key_exists('draft',$parameters)) { $zc50d0=$_strings['fb--save-and-preview']; } else { $zc50d0=$_strings['fb--save-changes']; } } $je449c=rc0c4( $rea59a['FormatterID'],$rea59a['Text'],'full' ); $z75e1b=df898( 'note',$v21158,$je449c ); $e84841=serialize(mdc5a($je449c)); $o96b8c=min($rea59a['Stamp'],time()); $a2cb9d['title']=$od5d3d; $a2cb9d['heading']=$vf74f5; $a2cb9d['form']='form-note'; $a2cb9d['form-note'] = array ( '.note-id' => $v21158, '.formatter-id' => $n9763c, '.from' => substr($_SERVER['HTTP_REFERER'],strlen($full_blog_url)+1), '.old-tags-hash' => md5($v9dbb8), '.preserved-uploads' => htmlspecialchars($e84841,ENT_COMPAT,HSC_ENC), '.instant-publish' => 'no', '.action' => $l60cd8, 'form-action' => e83c8('e2s_note_process'), 'form-note-livesave-action' => e83c8('e2j_note_livesave'), 'form-file-upload-action' => e83c8('e2j_file_upload', array ('entity' => 'note','entity-id' => $v21158)), 'form-file-remove-action' => e83c8('e2j_file_remove', array ('entity' => 'note','entity-id' => $v21158)), 'create:edit?' => (bool) ($l60cd8=='write'), 'title' => htmlspecialchars($rea59a['Title'],ENT_COMPAT,HSC_ENC), 'tags' => $v9dbb8, 'tags-info' => $xc93df, 'text' => htmlspecialchars($rea59a['Text'],ENT_NOQUOTES,HSC_ENC), 'uploads' => $z75e1b, 'all-tags' => $s77b75, 'stamp-formatted' => g5a2f('d.m.Y H:i:s',$o96b8c,h0923($rea59a)), 'time' => $rea59a['IsPublished']? array ((int)$o96b8c,h0923($rea59a)) : false, 'alias-autogenerated' => $l3aa13, 'alias' => $q72487, 'submit-text' => $zc50d0, ); if ($l60cd8=='edit'){ $a2cb9d['related-delete-href']=e83c8( 'e2m_note_delete', array ('*note' => $rea59a) ); if (!array_key_exists('draft',$parameters)) { $rea59a['_']['_id']=$rea59a['ID']; $rea59a['_']['_ord']=0; $rea59a['_']['_ord_max']=0; $a2cb9d['form-note']['note']=m6791($rea59a); } } return $a2cb9d; } function e2m_write(){ return n7dd3('write'); } function e2s_note_process(){ global$_fp_error,$_strings; $v21158=va21e(); if (!$v21158){ if($_fp_error==FP_TITLE_OR_TEXT_EMPTY){ s8a40($_strings['er--post-must-have-title-and-text'],E2E_USER_ERROR); } elseif($_fp_error==FP_NO_ID_OR_NEW){ } else { s8a40($_strings['er--error-occurred']); } e2_go_to(e83c8('e2m_write')); die; } $waad65=c4627($v21158); if ($waad65['IsPublished']) { e2_go_to(e83c8('e2m_note', array ('*note' => $waad65))); } else { e2_go_to(e83c8('e2m_draft', array ('*note' => $waad65))); } die; } function e2s_note_publish(){ global$_strings,$_config,$settings; $v21158=false; if(array_key_exists('note-id',$_POST)) { $v21158=$_POST['note-id']; $rea59a=c4627($v21158); $x82b30=$rea59a['OriginalAlias']; $rea59a=array ( 'ID' => $v21158, 'IsPublished' => 1, 'IsCommentable' => (int)$settings['comments']['default_on'], 'IsFavourite' => 0, 'Stamp' => time(), 'IP' => $_SERVER['REMOTE_ADDR'], ); hd2e1($rea59a); $xb2c6c=ta618(@$_POST['gmt-offset']); if ($xb2c6c){ $rea59a['Offset'] = (int)$xb2c6c['offset']; $rea59a['IsDST'] = (int)$xb2c6c['is_dst']; } e2_drop_caches_for_note_($v21158); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); if (waa79('Notes',$rea59a)) { p5b68($rea59a); $q72487=''; if ($x82b30){ $q72487=xd712('set',ENTITY_TYPE_NOTE,$v21158,$x82b30); $rea59a['OriginalAlias']=$q72487; } if ($q72487!=$x82b30){ waa79('Notes',$rea59a); } e2_go_to(e83c8('e2m_note', array ('*note' => $rea59a))); die; } else { d4930(); die; } } e2_go_to(); die; } function e2s_note_delete(){ global$_strings,$_config; $v21158=$_POST['note-id']; $pf91b2=(bool)$_POST['is-draft']; e2_drop_caches_for_note_($v21158); if ($pf91b2){ @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } else { @unlink(CACHE_FILENAME_FAVS); } if (l0738( "DELETE FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `ID` = '".((int)$v21158)."'" )) { a10fe($v21158); p5b68($rea59a); l0738( "DELETE FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `EntityID`=". ((int)$v21158) ); l0738( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `NoteID`=". ((int)$v21158) ); if ($pf91b2){ e2_go_to(e83c8('e2m_drafts')); } else { e2_go_to(); } die; } else { e2_go_to(); die; } } function e2j_note_livesave(){ die (va21e('ajaxresult')); } function m6791($waad65,$y8698e=false){ global $settings, $_config, $_candy, $_current_tag, $r57de2, $ce5564, $xe9bf8, $full_blog_url; if (!is_numeric($waad65['_']['_id'])) return false; $xda497=e2_note_cache_filename_with_id_($waad65['_']['_id']); $qe244c=null; if(CACHE_NOTES and is_file($xda497)) { $qe244c=@unserialize(file_get_contents($xda497)); } if(__LOG)__log('Notes: package note <'. $waad65['_']['_id'] .'>...'); $qe919a=u7f78(); if(CACHE_NOTES and is_array($qe244c)) { if(__LOG)__log('Notes: retrieve cached ctree'); $lc6827=$qe244c; } else { if(__LOG)__log('Notes: assemle cacheable ctree...'); if(__LOG)__log('Notes: formatter ID = '. $waad65['FormatterID']); $l2bfe4=z154e($waad65['FormatterID'], @$waad65['Text'],'full'); $lc6827['title'] = m6f10(htmlspecialchars(zea9c($waad65),ENT_NOQUOTES,HSC_ENC)); $lc6827['text'] = $l2bfe4['text-final']; $lc6827['summary'] = r5421($lc6827['text']); $lc6827['format-info'] = $l2bfe4['meta']; $lc6827['time'] = array ((int)min($waad65['Stamp'],time()), h0923($waad65)); $lc6827['last-modified'] = array ((int)min($waad65['LastModified'],time()), h0923($waad65)); $lc6827['last-ip'] = $waad65['IP']; $lc6827['published?'] = (bool)$waad65['IsPublished']; $lc6827['commentable?'] = (bool) ($waad65['IsCommentable'] && $waad65['IsPublished']); $lc6827['favourite?'] = (bool) ($waad65['IsFavourite'] && $waad65['IsPublished']); $lc6827['visible?'] = (bool) ($waad65['IsVisible'] || !$waad65['IsPublished']); if(is_array($l2bfe4['meta']['resources-detected'])) { q6be4($l2bfe4['meta']['resources-detected']); } if (!$lc6827['published?'])$lc6827['time']=$lc6827['last-modified']; $w0dff3=ece23($waad65['ID']); $md57ac=array(); foreach ($w0dff3 as $y865c0 => $db19ad){ $de4d23['name']=htmlspecialchars($db19ad['Keyword'],ENT_NOQUOTES,HSC_ENC); $de4d23['href']=e83c8('e2m_tag', array ('*tag' => $db19ad)); $md57ac[] = $de4d23; } $lc6827['tags']=$md57ac; if (@in_array(SYSTEM_LIBRARY_FOLDER. 'jouele/jouele.js',$l2bfe4['meta']['links-required'])) { $lc6827['playlist?']=true; } $b905f7=z254f($waad65['ID']); if ($lc6827['published?']) { $lc6827['comments-count']=$b905f7; $lc6827['your-comment-href'] = ( e83c8('e2m_note_comment', array ('*note' => $waad65)) ); } $qe244c=$lc6827; if(CACHE_NOTES) @d6e52($xda497,serialize($qe244c)); } if ($y8698e){ if(__LOG)__log('Notes: short-track package for caching only'); if(__LOG)__log('Notes: package note done in '. round(u7f78()-$qe919a,3)); return $lc6827; } if(__LOG)__log('Notes: continue with the uncacheable, '. round(u7f78()-$qe919a,3) .' so far...'); $lc6827['commentable-now?']=ob387($waad65); if(array_key_exists('comments-count',$lc6827)) { $lc6827['comments-count-text']=e2l_get_string('gs--n-comments', array ( 'number' => $lc6827['comments-count'] )); } foreach ($lc6827['tags'] as $d8ce4b => $w9e366){ $lc6827['tags'][$d8ce4b]['current?'] = (bool) ($lc6827['tags'][$d8ce4b]['name']==$_current_tag); } $m2e88c=$waad65['IsPublished']?'e2m_note':'e2m_draft'; $lc6827['href']=e83c8($m2e88c, array ('*note' => $waad65)); if ($waad65['IsPublished']) { if ($waad65['OriginalAlias']) { $lc6827['href-original']=e83c8('e2m_note', array ('alias' => $waad65['OriginalAlias'])); } else { $e010d9=$waad65; $e010d9['__noalias!']=true; $lc6827['href-original']=e83c8('e2m_note', array ('*note' => $e010d9)); } } $lc6827['comments-link?'] = (bool) ( $waad65['IsPublished'] && (ob387($waad65) or ($lc6827['comments-count'] > 0)) && ('e2m_note'!=$_candy) ); if (he852()) { $ofe9e2=z254f($waad65['ID'],'new'); $lc6827['new-comments-count']=$ofe9e2; $lc6827['new-comments-count-text']=e2l_get_string('gs--comments-n-new', array ( 'number' => $ofe9e2 )); if ($waad65['IsPublished']) { if ($waad65['IsFavourite']) { $lc6827['favourite-toggle-href']=e83c8( 'e2m_note_flag_favourite', array ('*note' => $waad65,'value' => 0) ); } else { $lc6827['favourite-toggle-href']=e83c8( 'e2m_note_flag_favourite', array ('*note' => $waad65,'value' => 1) ); } } $lc6827['edit-href']=e83c8( 'e2m_note_edit', array ('*note' => $waad65) ); $d9920c=$lc6827['edit-href']; } $lc6827['og-images']=xdbcc( 'note',$waad65['_']['_id'], $lc6827['format-info']['resources-detected'] ); if($settings['appearance']['show_sharing_buttons']) { $reb769=$_config['share_to']; $v21bdd='|twitter|facebook|gplus|vkontakte|telegram|linkedin|'; if (@$_config['share_to_twitter_via']) { $n8d777['twitter']['via']=$_config['share_to_twitter_via']; } if(count($lc6827['og-images']) > 0){ $w62933=$lc6827['og-images'][0]; $v21bdd.='pinterest|'; $n8d777['pinterest']['media']=$w62933; } $lc6827['shareable?']=false; foreach(explode(',',$reb769) as $k5a9d3){ $k5a9d3=trim($k5a9d3); if(strstr($v21bdd,'|'. $k5a9d3. '|')) { $lc6827['shareable?']=true; $lc6827['share-to'][$k5a9d3]['share?']=true; if ($n8d777[$k5a9d3]) { $lc6827['share-to'][$k5a9d3]['data']=$n8d777[$k5a9d3]; } } } } if(array_key_exists('_',$waad65))$lc6827['_']=$waad65['_']; if(__LOG)__log('Notes: package note done in '. round(u7f78()-$qe919a,3)); return $lc6827; } function c4627($cb80bb){ global$_strings,$_config; if (l0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `ID` = '".$cb80bb."'" )) { $rfa816=i0d6b(); if(count($rfa816) > 0){ return $rfa816[0]; } else { return false; } } else { s8a40($_strings['er--cannot-get-post-from-db'],E2E_DATABASE_ERROR); d4930(); die; } } function ycca7($waad65,$eb4ca4,$d8f888=1){ global$_strings,$_config; $q7ffc4=($eb4ca4=='next')?'>':'<'; $m1dee8=($eb4ca4=='next')?'':'DESC '; if (!he852()) { $l91d12=' AND `IsVisible`=1'; } if (l0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=". $d8f888 ." AND `Stamp` ".$q7ffc4." '".$waad65['Stamp']."'".@$l91d12." ". "ORDER BY STAMP ".$m1dee8. "LIMIT 1" )) { $rfa816=i0d6b(); if(count($rfa816) > 0) return $rfa816[0]; else return FALSE; } else { s8a40($_strings['er--cannot-get-post-from-db'],E2E_DATABASE_ERROR); d4930(); die; } } function zea9c($waad65){ if ($waad65['Title']) { return $waad65['Title']; } else { return '#'. $waad65['ID']; } } function c50d7($xd5566,$g71860=1){ global$settings,$_config; $kb01a5=$xd5566; $j8b7af='all'; if ('rss'==$xd5566 or !he852()) { $k25715="AND `IsVisible`=1 "; $j8b7af='visible'; } if ('web'==$xd5566)$kb01a5.='_'.$j8b7af; if ('web'==$xd5566){ $m19ee4=($g71860-1)*$settings['appearance']['notes_per_page']; $jaa9f7=$m19ee4 .', '. $settings['appearance']['notes_per_page']; } if ('rss'==$xd5566){ $jaa9f7=$_config['rss_items']; } if (l0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 " .@$k25715. "ORDER BY `Stamp` DESC ". "LIMIT ". $jaa9f7 )) { $result=i0d6b(); return$result; } else { return false; } } function r82dc($z41529,$h6f8f5){ global$_config; list ($efc6b2,$v10df4)=n5273($z41529,$h6f8f5); if (!he852())$kf79b1="`IsVisible`=1 AND "; if (l0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND " .@$kf79b1. "`Stamp` BETWEEN '". $efc6b2 ."' AND '". $v10df4 ."'" )) { $result=i0d6b(); $x44fde=array(); foreach($result as $v65afd){ if ( ((int)$z41529) .'/'. ((int)$h6f8f5) == g5a2f('Y/n',$v65afd['Stamp'],h0923($v65afd)) ) { $x44fde[] = (int)g5a2f('j',$v65afd['Stamp'],h0923($v65afd)); } } $x44fde=@array_unique($x44fde); sort($x44fde); return $x44fde; } else { return false; } } function ra2d8($fddf82){ global$_config; if(__LOG)__log('Lastmodifieds for Local Copier'); if(CACHE_LASTMODIFIEDS and is_file(CACHE_FILENAME_LASTMODIFIEDS)) { $z84636=@unserialize(file_get_contents(CACHE_FILENAME_LASTMODIFIEDS)); if ($z84636['ids_csv']==$fddf82){ if(__LOG)__log('Returned from cache'); return $z84636['lastmodifieds_json']; } } $k56790='WHERE `ID`='. str_replace(',',' OR `ID`=',$fddf82); $ab7d96=array(); if (l0738( "SELECT `ID`, `LastModified` ". "FROM `". $_config['db_table_prefix']."Notes` ". $k56790 )) { if(__LOG)__log('Requested from DB'); $result=i0d6b(); foreach($result as $d8ce4b => $w9e366){ $ab7d96[(int)$w9e366['ID']] = (int)$w9e366['LastModified']; } } $w08bb9=json_encode($ab7d96); if ($w08bb9=='[]')$w08bb9='{}'; $z84636=array ( 'ids_csv' => $fddf82, 'lastmodifieds_json' => $w08bb9, ); if(CACHE_LASTMODIFIEDS){ d6e52(CACHE_FILENAME_LASTMODIFIEDS,serialize($z84636)); } return $w08bb9; } function db92c($z41529){ global$_config; list ($k5a603,$oc2b31)=n5273($z41529); if (!he852())$kf79b1="`IsVisible`=1 AND "; if (l0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND ". @$kf79b1. "`Stamp` BETWEEN '". $k5a603. "' AND '". $oc2b31 ."'" )) { $result=i0d6b(); $uda36c=array(); foreach($result as $v65afd){ if ( ((int)$z41529) == g5a2f('Y',$v65afd['Stamp'],h0923($v65afd)) ) { $uda36c[] = (int)g5a2f('n',$v65afd['Stamp'],h0923($v65afd)); } } $uda36c=@array_unique($uda36c); sort($uda36c); return $uda36c; } else { return false; } } function md864($n8d777){ global$settings,$g71860,$_strings; $a7694f=$n8d777['query']; if (isset ($n8d777['page']) and $n8d777['page'] < 1) return e2_error404_mode(); $wd7e5d=$settings['appearance']['notes_per_page']; $db3b32=array(); $ofbb44=false; if (isset ($n8d777['page'])) { $g71860=$n8d777['page']; $a7694f.=' LIMIT '.($n8d777['page']-1)*$wd7e5d.', '.$wd7e5d; $i61e23=str_replace('SELECT *','SELECT count(*)',$n8d777['query']); if (l0738($i61e23)) { $result=i0d6b(); $ofbb44=$result[0]['count(*)']; $pae0fe=ceil($ofbb44/$wd7e5d); if ($g71860 > $pae0fe and $g71860!=1){ return e2_error404_mode(); } $db3b32['count']=$pae0fe; $db3b32['this']=$g71860; $db3b32['timeline?']=true; $db3b32['earlier-title']=$_strings['gs--earlier']; $db3b32['later-title']=$_strings['gs--later']; $t920fa=$n8d777['parameters']; if ($g71860 < $pae0fe){ $t920fa['page']=$g71860+1; $db3b32['earlier-href']=e83c8($n8d777['candy'],$t920fa); } if ($g71860 > 1){ $t920fa['page']=$g71860-1; $db3b32['later-href']=e83c8($n8d777['candy'],$t920fa); } } else { return array (); } } $m4358b=array(); if (l0738($a7694f)) { $result=$ee5b87=i0d6b(); if (@$n8d777['query-returns-only-ids']) { $result=array(); foreach ($ee5b87 as $waad65){ $waad65=c4627($waad65['ID']); if ($waad65['IsPublished'] and ($waad65['IsVisible'] or he852())) { $result[] = $waad65; } } } foreach($result as $d8ce4b => $waad65){ $waad65['_']['_id']=$waad65['ID']; $waad65['_']['_ord']=$d8ce4b; $waad65['_']['_ord_max']=count($result)-1; $m4358b[] = m6791($waad65); } } else { return array (); } $o05a16=$m4358b; if (!isset ($n8d777['show-all-notes']) or @$n8d777['show-all-notes']!=true){ $o05a16=array_slice($m4358b,0,$wd7e5d); } if ($ofbb44===false)$ofbb44=count($o05a16); if (!count($m4358b) and array_key_exists('nothing',$n8d777)) { $a2cb9d['nothing']=$n8d777['nothing']; } $ycd0fd=array ( 'class', 'superheading', 'heading', 'title', 'search-related-tag', 'related-rss-href', ); foreach ($ycd0fd as $df97bf){ if(array_key_exists($df97bf,$n8d777)) { $a2cb9d[$df97bf]=$n8d777[$df97bf]; } } if ($ofbb44){ $r5cde2=e2l_get_string( 'pt--n-posts', array ('number' => $ofbb44) ); } else { $r5cde2=$_strings['pt--no-posts']; } if(array_key_exists('maximum-notes',$n8d777) and $ofbb44 >= $n8d777['maximum-notes']) { $r5cde2=$_strings['gs--many-posts']; } foreach (array ('title','heading','superheading') as $c4b24c){ if(strstr($n8d777[$c4b24c],'%total%')) { $a2cb9d[$c4b24c]=str_replace('%total%', $r5cde2,$n8d777[$c4b24c]); } } $a2cb9d['notes']=$o05a16; $a2cb9d['pages']=$db3b32; return $a2cb9d; } function zf9fb($z41529,$h6f8f5,$c8277e=false){ global$_config; list ($x7b314,$ca1f20)=n5273($z41529,$h6f8f5,$c8277e); if (l0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` AND (`Stamp` BETWEEN " .$x7b314. " AND " .$ca1f20. ")". "ORDER BY Stamp" )) { $result=i0d6b(); $tb1bc2=1; $a2cb9d=array(); foreach($result as $v65afd){ if(is_numeric($c8277e)) { $j3f917=((int)$z41529) .'/'. ((int)$h6f8f5) .'/'. ((int)$c8277e) == g5a2f('Y/n/j',$v65afd['Stamp'],h0923($v65afd)); } elseif(is_numeric($h6f8f5)) { $j3f917=((int)$z41529) .'/'. ((int)$h6f8f5) == g5a2f('Y/n',$v65afd['Stamp'],h0923($v65afd)); } else { $j3f917=((int)$z41529) == g5a2f('Y',$v65afd['Stamp'],h0923($v65afd)); } if ($j3f917){ if(is_numeric($c8277e)) { $v65afd['day_number']=$tb1bc2; } $a2cb9d[] = $v65afd; $tb1bc2 ++; } } return $a2cb9d; } else { return false; } } function e2_published_noterec_with_alias_($q72487){ if ($hc45dd=e2_aliasrec_of_alias_($q72487)) { $waad65=c4627($hc45dd['EntityID']); if ($waad65['IsPublished']) return $waad65; } } function e2_published_noterec_with_parameters_($parameters=array ()) { $e39a37=e2_noterec_with_parameters_($parameters); if ($e39a37['IsPublished']) return $e39a37; } function e2_noterec_with_parameters_($parameters=array ()) { global$_config; $waad65=false; $ib5445=false; if (@$parameters['oalias']) $ib5445=$parameters['oalias']; if ($ib5445){ if (l0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `OriginalAlias` = '". $ib5445 ."' ". "AND `IsPublished` = 0" )) { $waad65=i0d6b(); if(count($waad65)==1) { $waad65=@$waad65[0]; if ($waad65) return $waad65; } } } $g67e85=false; if (@$parameters['draft']) $g67e85=$parameters['draft']; if (@$parameters['draft2'])$g67e85=$parameters['draft2']; if ($g67e85){ $waad65=c4627($g67e85); return $waad65; } if (@$parameters['alias']) { if ($hc45dd=e2_aliasrec_of_alias_(@$parameters['alias'])) { if ($hc45dd['EntityType']==ENTITY_TYPE_NOTE){ $waad65=c4627($hc45dd['EntityID']); if ($waad65['IsPublished']) return $waad65; } } } $gc2d18=zf9fb($parameters['year'],$parameters['month'],$parameters['day']); if (@$gc2d18[$parameters['day-number']-1]) { return $gc2d18[$parameters['day-number']-1]; } } function ne56b($od5d3d,$j1cb25,$xb2c6c,$md19c2){ global$_config; ze2f1(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); $e39a37=array ( 'Title' => e7928($od5d3d), 'Text' => e7928($j1cb25), 'FormatterID' => $_config['default_formatter'], 'OriginalAlias' => xd712('find',ENTITY_TYPE_UNSPECIFIED,'',$od5d3d), 'Uploads' => $md19c2, 'Stamp' => (int)time(), 'LastModified' => (int)time(), ); if ($xb2c6c and is_array($xb2c6c)) { $e39a37['Offset'] = (int)$xb2c6c['offset']; $e39a37['IsDST'] = (int)$xb2c6c['is_dst']; } if (($e39a37=n9943('Notes',$e39a37)) !== false){ return $e39a37['ID']; } } function va21e($k98ea6=''){ global$_fp_error,$_config,$_e2utf8__unformat_htmlentity_neasden; $_fp_error=false; $v21158=$od5d3d=$md57ac=$j1cb25=$yb4960=''; if(array_key_exists('note-id',$_POST)) $v21158=$_POST['note-id']; if(array_key_exists('title',$_POST)) $od5d3d=trim($_POST['title']); if(array_key_exists('tags',$_POST)) $md57ac=$_POST['tags']; if(array_key_exists('text',$_POST)) $j1cb25=trim($_POST['text'],"\r\n"); if(array_key_exists('old-tags-hash',$_POST)) $yb4960=$_POST['old-tags-hash']; if(is_array($md57ac))$md57ac=implode(', ',$md57ac); $md57ac=trim($md57ac); if ($v21158=='new'){ $_e2utf8__unformat_htmlentity_neasden=($_config['default_formatter']=='neasden'); } else { $_e2utf8__unformat_htmlentity_neasden=($_POST['formatter-id']=='neasden'); } $od5d3d=vff7c($od5d3d); $md57ac=vff7c($md57ac); $j1cb25=vff7c($j1cb25); $rffa71=$j1cb25; $rffa71=str_replace("\n",'\n'."\n",$rffa71); $rffa71=str_replace("\r",'\r'."\r",$rffa71); if(__LOG)__log('e2fp_note: Text is ['. $rffa71 .'] ('. strlen($j1cb25) .'b)'); $xa6168=t163d(',',$md57ac,'sort'); $md57ac=implode(', ',$xa6168); $w65f31=md5($md57ac); if(array_key_exists('browser-offset',$_POST)) { $xb2c6c=ta618(@$_POST['browser-offset']); } else { $xb2c6c=false; } $rd17d3='/^ *(\d{1,2})\.(\d{1,2})\.(\d{2}|\d{4}) +(\d{1,2})\:(\d{1,2})\:(\d{1,2}) *$/'; $e02b37=@$_POST['old-stamp']; $daddfe=@$_POST['stamp']; $q72487=@$_POST['alias']; if ($v21158!='new'){ $f383b7=c4627($v21158); } else { $f383b7=array(); } if ($v21158){ if ($od5d3d!='' and $j1cb25!=''){ if ($v21158=='new'){ $md19c2=''; if(is_file(USER_FOLDER.'new-uploads.psa')) { $md19c2=@file_get_contents(USER_FOLDER.'new-uploads.psa'); } if ($v21158=ne56b($od5d3d,$j1cb25,$xb2c6c,$md19c2)) { @unlink(USER_FOLDER.'new-uploads.psa'); $s33dd5='e2m_draft'; $b5ce5d=array ( '*note' => c4627($v21158), ); $v1fa03='{'. '"status": "created", '. '"id": "'. $v21158 .'", '. '"note-url": "'. e83c8($s33dd5,$b5ce5d) .'", '. '"note-edit-url": "'. e83c8('e2m_note_edit',$b5ce5d) .'"'. '}'; $result=(int)$v21158; } else { $v1fa03='{"status": "error", "message": "Cannot create record"}'; $result=false; } } else { e2_drop_caches_for_note_($v21158); if (!$f383b7['IsPublished']) { @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } $f71671=$f383b7; $f71671['ID']=$v21158; $f71671['Title']=$od5d3d; $f71671['Text']=$j1cb25; $f71671['FormatterID']=$f383b7['FormatterID']; $f71671['LastModified']=time(); $f71671['IsIndexed']='1'; if ($e02b37!=$daddfe){ if(preg_match($rd17d3,$daddfe,$h6f8f5)) { $o96b8c=gmmktime($h6f8f5[4],$h6f8f5[5],$h6f8f5[6],$h6f8f5[2],$h6f8f5[1],$h6f8f5[3]); $o96b8c -= ib2bf($xb2c6c,$o96b8c); $o96b8c=min($o96b8c,time()); $f71671['Stamp']=$o96b8c; } else { unset ($o96b8c); } } $k17901=$q72487; if ($q72487){ $ea7ff0=$q72487; } elseif (!$f383b7['IsPublished']) { $ea7ff0=$od5d3d; } else { $ea7ff0=''; } if ($f383b7['IsPublished']) { $k17901=xd712( 'set',ENTITY_TYPE_NOTE,$v21158,$ea7ff0 ); $s33dd5='e2m_note'; $b5ce5d=array ( '*note' => $f71671, 'alias' => $k17901, ); } else { $h926c6=true; $k17901=xd712('find',ENTITY_TYPE_NOTE,$v21158,$ea7ff0); $f71671['OriginalAlias']=$k17901; $s33dd5='e2m_draft'; $b5ce5d=array ( '*note' => $f71671, 'alias' => $k17901, ); } $g26d2f=@unserialize($f383b7['Uploads']) or $g26d2f=array(); $e84841=@unserialize($_POST['preserved-uploads']) or $e84841=array(); $e0949f=le1e7($g26d2f,'add',$e84841); $f71671['Uploads']=serialize($e0949f); if (waa79('Notes',$f71671)) { if ($f71671['IsPublished']) { hd2e1($f71671); p5b68($f71671); } $v1fa03='{'. '"status": "saved", '. '"new-alias": "'. $k17901 .'", '. '"note-url": "'. e83c8($s33dd5,$b5ce5d) .'", '. '"note-edit-url": "'. e83c8('e2m_note_edit',$b5ce5d) .'"'. '}'; $result=(int)$v21158; } else { $v1fa03='{"status": "error", "message": "Cannot update record ('. mysqli_error(). ')"}'; $result=false; } } if ($w65f31!=$yb4960){ g53f1(array ('NoteID' => $v21158)); foreach ($xa6168 as $de4d23){ $e70b77=s0188($de4d23); if (!$e70b77){ $e70b77['ID']=a03de($de4d23); } l0738( "INSERT INTO `". $_config['db_table_prefix']."NotesKeywords` ". "(`NoteID`, `KeywordID`) ". "VALUES (". ((int)$v21158) .", ". ((int)$e70b77['ID']). ")" ); } } if ( $k98ea6!='ajaxresult' and $result and $_POST['instant-publish']=='yes' ){ $_POST['note-id']=$v21158; e2s_note_publish(); } } else { $v1fa03='{"status":"error", "message": "Title or text is empty"}'; $_fp_error=FP_TITLE_OR_TEXT_EMPTY; $result=false; } } else { $v1fa03='{"status":"error", "message": "No note id/new specified"}'; $_fp_error=FP_NO_ID_OR_NEW; $result=false; } ecc38(e83c8('e2s_dump', array ())); if ($k98ea6=='ajaxresult') return $v1fa03; else return$result; } function occ02($h92c58){ global$_config; $j8b7af='p1'; if (!he852()) { $j8b7af='p1v1'; $kf79b1="AND `IsVisible`=1"; } $id29bb=CACHES_FOLDER.$h92c58 .'-stamp-'. $j8b7af .'.e2time.psa'; if(CACHE_EDGE_TIMEINFO and is_file($id29bb)) { $result=@unserialize(file_get_contents($id29bb)); } if(is_array($result)) { return$result; } else { if ($h92c58=='start'){ l0738( "SELECT Stamp, Offset, IsDST FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 ". $kf79b1 ." ORDER BY Stamp LIMIT 1" ); } elseif ($h92c58=='end'){ l0738( "SELECT Stamp, Offset, IsDST FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 ". $kf79b1 ." ORDER BY Stamp DESC LIMIT 1" ); } $result=i0d6b(); if(count($result)) { $result=array ( 'stamp' => $result[0]['Stamp'], 'timezone' => h0923($result[0]), ); if(CACHE_EDGE_TIMEINFO)d6e52($id29bb,serialize($result)); return$result; } else { return array (); } } } function j8ca0($k1653c,$r0604c){ global$_config; if (!($k1653c and $r0604c) and !he852()) { die ('API MISUSE: e2_notes_count_general cannot be called for invisible notes or drafts unsecurely :-('); } if (!is_bool($k1653c) or !is_bool($r0604c)) { die ('API MISUSE: e2_notes_count_general must be called with bool params :-('); } if (!$k1653c and !$r0604c){ die ('API MISUSE: e2_notes_count_general called with nonsensical parameters'); } $id29bb=CACHES_FOLDER . 'notes-count-p'. (int)$k1653c . ($k1653c ? ('v'. (int)$r0604c):'') . '.txt'; $result=false; if(CACHE_NOTES_COUNTS and is_file($id29bb)) { $result=@file_get_contents($id29bb); } if(is_numeric($result) and $result > 0){ return$result; } else { l0738( "SELECT COUNT(*) As NotesCount FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=". (int)$k1653c. " ". ($k1653c ? ( "AND `IsVisible`=". (int)$r0604c ):"") ); $result=i0d6b(); $result=$result[0]['NotesCount']; if($result){ if(CACHE_NOTES_COUNTS)d6e52($id29bb,$result); return$result; } else { return null; } } } function r5421($j1cb25){ $ba80da=$j1cb25; $ba80da=str_replace(array ( '<p>','<blockquote>','<ul>','<ol>','<br />', ), "\n",$ba80da); $ba80da=trim(strip_tags($ba80da)); if(strpos($ba80da,"\n")!==false){ $ba80da=substr($ba80da,0,strpos($ba80da,"\n")); $ba80da=trim($ba80da,' :.()'."\n"); } if(preg_match('/^(.{100,}?)[:.!?()]|'."\n".'/s',$ba80da,$u9c28d)) { $ba80da=trim($u9c28d[0],' :.()'."\n"); } if(preg_match('/^(.{150,}?)[:.!?(),]/s',$ba80da,$u9c28d)) { $ba80da=trim($u9c28d[0],' :.()'."\n"); } if(preg_match('/^(.{200,}?)[:.!?(), ]/s',$ba80da,$u9c28d)) { $ba80da=trim($u9c28d[0],' :.()'."\n"); } if(in_array($ba80da[strlen($ba80da)-1], array (',',' '))) { $ba80da=trim($ba80da,', '). '...'; } if(mb_strlen($ba80da) > 250){ $ba80da=mb_substr($ba80da,0,250). '...'; } return $ba80da; } define('DRAFT_PREVIEW_LENGTH',100); function e2m_drafts(){ global$_strings,$_config; if(__LOG)__log('Drafts list: working...'); $cda3ad='LastModified'; $eda48a=null; if(CACHE_DRAFTS and is_file(CACHE_FILENAME_DRAFTS)) { $eda48a=@unserialize(file_get_contents(CACHE_FILENAME_DRAFTS)); } if(CACHE_DRAFTS and is_array($eda48a)) { if(__LOG)__log('Drafts list: retrieve cached ctree'); } else { if(__LOG)__log('Drafts list: assemle cacheable ctree...'); $eda48a=array(); if(__LOG)__log('Drafts list: select by '. $cda3ad .'...'); if (l0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=0 ". "ORDER BY `". $cda3ad ."` DESC" )) { $result=i0d6b(); $m4358b=array(); foreach($result as $d8ce4b => $e39a37){ $waad65['_']['_id']=$e39a37['ID']; $waad65['_']['_ord']=k; $waad65['_']['_ord_max']=count($result)-1; $waad65['href']=e83c8('e2m_draft', array ('*note' => $e39a37)); $waad65['title']=m6f10(htmlspecialchars(zea9c($e39a37),ENT_NOQUOTES,HSC_ENC)); if (isset ($waad65['image-href'])) unset ($waad65['image-href']); $e39a37['_']['_id']=$e39a37['ID']; $e39a37['_']['_ord']=0; $e39a37['_']['_ord_max']=0; $q8e4cd=m6791($e39a37,true); $waad65['_']['_resources']=null; if ($e39a37['FormatterID']=='neasden'){ $waad65['_']['_resources']=$q8e4cd['format-info']['resources-detected']; } elseif ($e39a37['FormatterID']=='calliope'){ $waad65['_']['_resources']=rc0c4( $e39a37['FormatterID'],$e39a37['Text'],'full' ); } $waad65['text-fragment']=strip_tags($q8e4cd['text']); $r2ab2d=false; if(mb_strlen($waad65['text-fragment']) > DRAFT_PREVIEW_LENGTH) { $r2ab2d=mb_strpos($waad65['text-fragment'],'.',DRAFT_PREVIEW_LENGTH); } if ($r2ab2d!==false){ $waad65['text-fragment']=mb_substr($waad65['text-fragment'],0,$r2ab2d+1); } $eda48a[] = $waad65; } if(CACHE_DRAFTS)d6e52(CACHE_FILENAME_DRAFTS,serialize($eda48a)); } } if(__LOG)__log('Drafts list: put thumbnail without cache'); if ($eda48a){ foreach ($eda48a as $d8ce4b => $w9e366){ $eda48a[$d8ce4b]['thumbs']=v2e82(@$w9e366['_']['_resources']); } } if(__LOG)__log('Drafts list: done'); $a2cb9d=array ( 'title' => $_strings['pt--drafts'], 'heading' => $_strings['pt--drafts'], ); if(count($eda48a)) { $a2cb9d['drafts']=$eda48a; } else { $a2cb9d['nothing']=$_strings['gs--no-drafts']; } return $a2cb9d; } function e2m_draft($parameters=array ()) { global$_strings,$r57de2; $waad65=e2_noterec_with_parameters_($parameters); if (!$waad65){ $parameters['alias']=$parameters['oalias']; unset($parameters['oalias']); $waad65=e2_noterec_with_parameters_($parameters); if ($waad65){ $jd58c0=e83c8('e2m_note', array ('*note' => $waad65)); return e2_go_to($jd58c0); } } if (!$waad65) return e2_error404_mode(); $waad65['_']['_id']=$waad65['ID']; $waad65['_']['_ord']=0; $waad65['_']['_ord_max']=0; $q8e4cd=m6791($waad65); $f45513=array ( '.note-id' => $waad65['ID'], 'form-action' => e83c8('e2s_note_publish'), 'submit-text' => $_strings['fb--publish-draft'], ); return array ( 'title' => zea9c($waad65).' ('. $_strings['wd--draft'] .')', 'notes' => array ('only' => $q8e4cd), 'form' => 'form-note-publish', 'form-note-publish' => $f45513, ); } function e2m_draft_preview($parameters=array ()) { $waad65=e2_noterec_with_parameters_($parameters); $xa2d26=e2drafts__preview_key($waad65); if(E2_EDITION and $parameters['preview-key']==$xa2d26){ $result=e2m_draft($parameters); unset($result ['notes']['only']['href']); unset($result ['form']); unset($result ['form-note-publish']); return$result; } else { return e2_error404_mode(); } } function e2_draft_alias_use_count($r176fe=''){ global$_config; if(__LOG)__log('Drafts: find duplicate OriginalAliases...'); if(CACHE_DRAFTS_ALIAS_USE_COUNTS and is_file(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)) { $zda552=@unserialize(file_get_contents(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)); } if(CACHE_DRAFTS_ALIAS_USE_COUNTS and is_array($zda552)) { if(__LOG)__log('Drafts: retrieve cached'); } else { if(__LOG)__log('Drafts: assemle cacheable...'); $zda552=array(); if (l0738( "SELECT `OriginalAlias` FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=0 ". "ORDER BY `ID`" )) { $result=i0d6b(); $m4358b=array(); foreach($result as $d8ce4b => $e39a37){ @$zda552[$e39a37['OriginalAlias']] ++; } } if(CACHE_DRAFTS_ALIAS_USE_COUNTS){ d6e52(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS,serialize($zda552)); } } if ($r176fe){ return $zda552[$r176fe]; } else { return $zda552; } } function e2drafts__preview_key($waad65){ return md5($waad65['Text'].$waad65['LastModified']); } $_url_map=array ( '@build' => 'e2://e2s_build', '@sync' => 'e2://e2s_sync', '@dump' => 'e2://e2s_dump', '@bsi' => 'e2://e2s_bsi_status', '@bsi/drop' => 'e2://e2s_bsi_drop', '@bsi/step' => 'e2://e2s_bsi_step', '@migrate' => 'e2://e2s_migrate', '@retrieve:source' => 'e2://e2s_retrieve', '@instantiate:version' => 'e2://e2s_instantiate', '@info' => 'e2://e2m_info', '@ajax/::' => 'e2://e2j_::', '@actions/::' => 'e2://e2s_::', '' => 'e2://e2m_frontpage?page=1', ':page' => 'e2://e2m_frontpage', 'rss' => 'e2://e2m_frontpage_rss', ':year' => 'e2://e2m_year', ':year/:month' => 'e2://e2m_month', ':year/:month/:day' => 'e2://e2m_day', 'all' => 'e2://e2m_everything', ':note' => 'e2://e2m_note', ':note/comment' => 'e2://e2m_note_comment', ':note/edit' => 'e2://e2m_note_edit?is_published=1', ':note/favourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=1', ':note/unfavourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=0', ':note/show' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=1', ':note/hide' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=0', ':note/discuss' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=1', ':note/quiet' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=0', ':note/withdraw' => 'e2://e2m_note_withdraw?is_published=1', ':note/json' => 'e2://e2m_note_json', ':note/broadcast' => 'e2://e2m_note_broadcast', ':note/delete' => 'e2://e2m_note_delete?is_published=1', ':note/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=1', ':note/:unsubscr' => 'e2://e2m_unsubscribe?is_published=1', ':note/hitinfo' => 'e2://e2m_note_hitinfo?is_published=1', ':note/comments-rss' => 'e2://e2m_note_comments_rss', ':note/:comnum' => 'e2://e2m_comment', ':note/:comnum/edit' => 'e2://e2m_comment_edit', ':note/:comnum/important' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=1', ':note/:comnum/usual' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=0', ':note/:comnum/replace' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=1', ':note/:comnum/remove' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=0', ':note/:comnum/spam' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=1', ':note/:comnum/good' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=0', ':note/:comnum/wipe' => 'e2://e2m_comment_delete', ':note/:comnum/reply/edit' => 'e2://e2m_comment_reply', ':note/:comnum/reply/important' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=1', ':note/:comnum/reply/usual' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=0', ':note/:comnum/reply/replace' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=1', ':note/:comnum/reply/remove' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=0', ':note/:comnum/reply/delete' => 'e2://e2m_comment_reply_delete', 'drafts' => 'e2://e2m_drafts', 'drafts/:draft' => 'e2://e2m_draft', 'drafts/:draft/edit' => 'e2://e2m_note_edit?is_published=0', 'drafts/:draft/show' => 'e2://e2m_note_flag?is_published=0&flag=IsVisible&value=1', 'drafts/:draft/hide' => 'e2://e2m_note_flag?is_published=0&flag=IsVisible&value=0', 'drafts/:draft/delete' => 'e2://e2m_note_delete?is_published=0', 'drafts/:draft/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=0', 'drafts/:draft/:preview' => 'e2://e2m_draft_preview', 'tags' => 'e2://e2m_tags', 'tags/:tag' => 'e2://e2m_tag?page=1', 'tags/:tag/:page' => 'e2://e2m_tag', 'tags/:tag/rss' => 'e2://e2m_tag_rss', 'tags/:tag/edit' => 'e2://e2m_tag_edit', 'tags/:tag/delete' => 'e2://e2m_tag_delete', 'tags/:tag/pin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=1', 'tags/:tag/unpin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=0', 'untagged' => 'e2://e2m_untagged', 'hot' => 'e2://e2m_most_commented', 'selected' => 'e2://e2m_favourites?page=1', 'selected/:page' => 'e2://e2m_favourites', 'found' => 'e2://e2m_found&query=', 'found/:query' => 'e2://e2m_found', 'found/:query/rss' => 'e2://e2m_found_rss', 'new' => 'e2://e2m_write', 'install' => 'e2://e2m_install', 'settings' => 'e2://e2m_settings', 'settings/name' => 'e2://e2m_name_and_author', 'settings/database' => 'e2://e2m_database', 'settings/password' => 'e2://e2m_password', 'settings/timezone' => 'e2://e2m_timezone', 'settings/sessions' => 'e2://e2m_sessions', 'sign-in' => 'e2://e2m_sign_in', 'sign-out' => 'e2://e2m_sign_out', ); $_url_chunks=array ( '\:page' => 'page\-(?P<page>\d+)', '\:year' => '(?P<year>\d{4})', '\:month' => '(?P<month>\d{1,2})', '\:day' => '(?P<day>\d{1,2})', '\:note' => array ( 'all\/(?P<alias>[-a-zA-Z0-9]+)', '(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)', ), '\:draft' => array ( '(?P<oalias2>[-a-zA-Z0-9]+)\/(?P<draft2>\d+)', '(?P<oalias>[-a-zA-Z0-9]+)', '-\/(?P<draft>\d+)', ), '\:comnum' => 'comment\-(?P<comment_number>[0-9]+)', '\:file' => '(?P<file>.*?)', '\:tag' => '(?P<tag_alias>[-a-zA-Z0-9]+)', '\:query' => '(?P<query>.*?)', '\:version' => '\:(?P<version>\d+)', '\:source' => '\:(?P<source>.*?)', '\:picture' => '\:(?P<picture>.*?)', '\:unsubscr' => 'unsubscribe\:(?P<unsubscribe_email>.+?)\:(?P<unsubscribe_key>[0-9a-f]{32})', '\:formatter' => '(?P<formatter>.*?)', '\:alias' => '(?P<newalias>[-a-zA-Z0-9]+)', '\:preview' => 'preview\:(?P<preview_key>[0-9a-f]{32})', ); $_url_autoredirects=array ( '/^favo(?:u?)rites(\~.+)?$/i' => 'selected\\1', '/^favo(?:u?)rites\/(.+)/i' => 'selected/\\1', '/^keywords$/i' => 'tags', '/^keywords\/(.*)/i' => 'tags/\\1', '/^everything$/i' => 'all', '/^search\/(.+)/i' => 'found/\\1', '/^(\d{4}\/\d{1,2}\/\d{1,2}\/\d+)\/comments(\/?)$/i' => '\\1', '/^\~(\d+)/i' => 'page-\\1', '/\/?\~(\d+)/i' => '/page-\\1', ); function kb6b0($a572d4){ global$_url_autoredirects,$aa57c1; $a572d4=preg_replace(array_keys($_url_autoredirects),array_values($_url_autoredirects),$a572d4); if(preg_match('/^([0-9]+)[.-]([0-9]+)[.-]([0-9]+)(.*)/',$a572d4,$u9c28d)) { if(2==strlen($u9c28d[3]))$u9c28d[3]='20'.$u9c28d[3]; return ($u9c28d[3].'/'.$u9c28d[2].'/'.$u9c28d[1].$u9c28d[4]); } if(preg_match('/^tags\-rss\/(.*?)\/?$/',$a572d4,$u9c28d)) { $de4d23=substr($u9c28d[1],strrpos($u9c28d[1],'/')+1); return ('tags/'. $de4d23.'/rss/'); } return $a572d4; } function l7059(){ global$__synthetic_urls,$_config; $__synthetic_urls=false; if($_config['url_composition']=='auto'){ if(function_exists('apache_get_modules')) { if(in_array('mod_rewrite',apache_get_modules())) { $__synthetic_urls=true; } } } if($_config['url_composition']=='synthetic'){ $__synthetic_urls=true; } } function e83c8($zc48ba,$parameters=array ()) { global$_url_map,$_url_chunks,$_config,$__synthetic_urls,$_protocol,$r57de2,$aa57c1; $pc2bd7=array_flip($_url_map); if ( @$_config['preferred_domain_name'] and $_SERVER['HTTP_HOST']!=$_config['preferred_domain_name'] ) { $r57de2=$_config['preferred_domain_name']; } $a572d4=$_protocol .'://'. $r57de2.$aa57c1 .'/'; $q9c464='e2://'. $zc48ba; if(array_key_exists('page',$parameters)) { $g71860=$parameters['page']; } else { $g71860=1; } if($parameters){ $q9c464.='?'; $i1c61f=array(); $h21711=array(); foreach($parameters as $c3c6e0 => $n2063c){ if ($c3c6e0=='*note'){ $h21711[] = $c3c6e0; $i1c61f[] = e2urls__expand_tricky_parameters_for_note_($n2063c); } if ($c3c6e0=='*tags'){ $h21711[] = $c3c6e0; $i1c61f[] = e2urls__expand_tricky_parameters_for_tags_($n2063c); } if ($c3c6e0=='*tag'){ $h21711[] = $c3c6e0; $i1c61f[] = e2urls__expand_tricky_parameters_for_tags_(array ($n2063c)); } } foreach ($h21711 as $c3c6e0) unset($parameters[$c3c6e0]); foreach ($i1c61f as $x58e2a){ $parameters=array_merge($parameters,$x58e2a); } foreach($parameters as $c3c6e0 => $n2063c){ if (@$c3c6e0[0]!='_'){ $q9c464.=$c3c6e0 .'='. urlencode($n2063c) .'&'; } } $q9c464=substr($q9c464,0, -1); } if(array_key_exists($q9c464,$pc2bd7)) { if ($pc2bd7[$q9c464]!='')$a572d4.=$pc2bd7[$q9c464] .'/'; return $a572d4; } else { $j44907=false; foreach ($pc2bd7 as $s45ea8 => $o9ea44){ $sb7365=$s45ea8; $sb7365=preg_quote($sb7365,'/'); $qed015=parse_url($s45ea8); $b2f532=$qed015['host']; $lebe09=parse_url($q9c464); if(strstr($s45ea8,'::')) { $effd6b=$lebe09['scheme'] .'://'. $lebe09['host']; $sb7365=str_replace('\:\:','(.*)',$sb7365); $sb7365='/^'. $sb7365 .'$/s'; if(preg_match($sb7365,$effd6b,$u9c28d)) { $ad6fe1=str_replace('::',$u9c28d[1],$o9ea44); $ad6fe1=str_replace('_','-',$ad6fe1); $y1b1cc=$lebe09['query']; if($__synthetic_urls and $y1b1cc){ $a572d4.=$ad6fe1 .'/?'. $y1b1cc; } elseif($__synthetic_urls){ $a572d4.=$ad6fe1 .'/'; } elseif ($y1b1cc){ $a572d4.='?go='. $ad6fe1 .'/&'. $y1b1cc; } else { $a572d4.='?go='. $ad6fe1 .'/'; } return $a572d4; } } $h54435=false; if ($zc48ba==$b2f532){ $j44907=true; if ($qed015['query']) { $v22c38=explode('&',$qed015['query']); foreach ($v22c38 as $g8822b){ list ($c3c6e0,$n2063c)=explode('=',$g8822b); $n2063c=urldecode($n2063c); $c3c6e0=str_replace('_','-',$c3c6e0); if ( array_key_exists($c3c6e0,$parameters) and $parameters[$c3c6e0]!=$n2063c ){ $h54435=true; break; } } } if (!$h54435){ if(preg_match_all('/\:[\-a-z]+/i',$o9ea44,$u9c28d)) { foreach ($u9c28d[0] as $lfc413){ $db0f75=$_url_chunks['\\'. $lfc413]; if (!is_array($db0f75)) { $db0f75=array ($db0f75); } $j05f62=$db0f75[0]; foreach ($db0f75 as $j05f62){ $weab03='/\(\?P\<(.*?)\>.*?\)/'; $r4274e=true; if (@preg_match($weab03,$j05f62,$u9c28d)) { $r4274e=true; for ($y865c0=1; $y865c0 < count($u9c28d); ++ $y865c0){ if (!$parameters[str_replace("_","-",$u9c28d[$y865c0])]) { $r4274e=false; break; } } } if (!$r4274e) continue; $kf9e1e=@preg_replace_callback( $weab03, function ($u9c28d) use ($parameters){ return$parameters[str_replace("_","-",$u9c28d[1])]; }, $j05f62 ); $kf9e1e=stripslashes($kf9e1e); $dc5d91=str_replace($lfc413,$kf9e1e,$o9ea44); break; } $o9ea44=$dc5d91; } } $k15214=array(); if ($o9ea44){ if($__synthetic_urls){ $a572d4.=$o9ea44 .'/'; } else { $k15214[] = 'go='. $o9ea44 .'/'; } } foreach($_GET as $d8ce4b => $w9e366) if(in_array($d8ce4b, array ('result','themeless'))) { $k15214[] = $d8ce4b . ($w9e366? ('='. urlencode($w9e366)) : ''); } if(count($k15214)) { $a572d4.='?'. implode('&',$k15214); } return $a572d4; } } } if ($j44907){ return $a572d4; } else { die ('Cannot compose url for candy '. $zc48ba); } } } function jb7e9($a572d4){ global$_url_map,$_url_chunks,$_config,$_current_url,$__synthetic_urls,$_protocol,$r57de2,$aa57c1; $y196c2=$a572d4; $a572d4=trim($a572d4,'/'); $a572d4=kb6b0($a572d4); if(__LOG)__log($a572d4); $parameters=array(); foreach($_url_map as $x12a24 => $s45ea8){ $id532d=$x12a24; $id532d=preg_quote($id532d,'/'); if(strstr($x12a24,'::')) { $id532d=str_replace('\:\:','(.*)',$id532d); $id532d='/^'. $id532d .'$/s'; if(preg_match($id532d,$a572d4,$u9c28d)) { $o53b9e=str_replace('-','_',$u9c28d[1]); $q9c464=str_replace('::',$o53b9e,$s45ea8); } } elseif(strstr($x12a24,':')) { $n1e380=array(); foreach($_url_chunks as $d8ce4b => $w9e366){ if(is_array($w9e366)) { $n1e380[$d8ce4b]='(?:(?:'. implode(')|(?:',$w9e366) .'))'; } else { $n1e380[$d8ce4b]=$w9e366; } } $id532d=str_replace( array_keys($n1e380), array_values($n1e380), $id532d ); $id532d='/^'. $id532d .'$/s'; if(preg_match($id532d,$a572d4,$u9c28d)) { $q9c464=$s45ea8; foreach ($u9c28d as $c3c6e0 => $n2063c) if (!is_numeric($c3c6e0)) { $c3c6e0=str_replace('_','-',$c3c6e0); $parameters[$c3c6e0]=$n2063c; } } } else { if ($x12a24==$a572d4){ $q9c464=$s45ea8; break; } } } $jfafdd=(bool)$q9c464; if (!$q9c464)$q9c464='e2://e2m_404'; $lebe09=parse_url($q9c464); $zc48ba=$lebe09['host']; if ($lebe09['query']) { $v22c38=explode('&',$lebe09['query']); foreach ($v22c38 as $g8822b){ list ($c3c6e0,$n2063c)=explode('=',$g8822b); $n2063c=urldecode($n2063c); $c3c6e0=str_replace('_','-',$c3c6e0); $parameters[$c3c6e0]=$n2063c; } } $a2cb9d=false; $parameters=e2urls__consolidate_tricky_parameters_($parameters); if ($jfafdd){ if($_config['force_canonical_urls']) { $n95d32=e83c8($zc48ba,$parameters); list ($ra4c3a,$aab96c)=explode('?',$_SERVER['REQUEST_URI'],2); $ia37bf=$_protocol .'://'.$_SERVER['HTTP_HOST'].$ra4c3a; $e5d6ba=$_protocol .'://'.$_SERVER['HTTP_HOST'].urldecode($ra4c3a); $aab96c=explode('&',$aab96c); foreach ($aab96c as $e6c0d0){ list ($g5c5e7, ) = explode('=',$e6c0d0); if ($g5c5e7=='go'){ $ia37bf.='?'. $e6c0d0; $e5d6ba.='?'. urldecode($e6c0d0); } } $_current_url=$ia37bf; if ($ia37bf!=$n95d32 and $e5d6ba!=$n95d32){ e2_go_to($n95d32); } } if(is_callable($zc48ba)) { $a2cb9d=array ($zc48ba,$parameters); } else { $a2cb9d=array (null, array ()); } } else { $a2cb9d=array (null, array ()); } return $a2cb9d; } function e2urls__expand_tricky_parameters_for_note_($e39a37){ global $aa57c1,$_config; if (!isset ($e39a37['IsPublished'])) { return array (); } if (!$e39a37['IsPublished']) { if ($e39a37['OriginalAlias']==''){ $parameters['draft']=$e39a37['ID']; } elseif(e2_draft_alias_use_count($e39a37['OriginalAlias']) == 1){ $parameters['oalias']=$e39a37['OriginalAlias']; } else { $parameters['draft2']=$e39a37['ID']; $parameters['oalias2']=$e39a37['OriginalAlias']; } $parameters['is-published']=0; return$parameters; } $parameters['is-published']=1; $cb80bb=$e39a37['ID']; $o96b8c=$e39a37['Stamp']; $xb2c6c=h0923($e39a37); if (!isset ($e39a37['__noalias!'])) { if (isset ($e39a37['alias'])) { $parameters['alias']=$e39a37['alias']; } else { $parameters['alias']=e2_active_alias_for_page_(ENTITY_TYPE_NOTE,$e39a37['ID']); } } if($parameters['alias']) return$parameters; list ($z41529,$h6f8f5,$c8277e)=explode('/', g5a2f('Y/m/d',$o96b8c,$xb2c6c) ); $parameters['year']=$z41529; $parameters['month']=$h6f8f5; $parameters['day']=$c8277e; if (isset ($e39a37['day_number'])) { $parameters['day-number']=$e39a37['day_number']; } else { list ($pd9d0f, ) = n5273($z41529,$h6f8f5,$c8277e); if (l0738( "SELECT `ID`, `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND (`Stamp` BETWEEN " .$pd9d0f. " AND " .$o96b8c. ") ". "ORDER BY `Stamp`" )) { $result=i0d6b(); $tb1bc2=1; foreach($result as $v65afd){ if ( $z41529.'/'.$h6f8f5.'/'.$c8277e == g5a2f('Y/m/d',$v65afd['Stamp'],h0923($v65afd)) ) { if ($v65afd['ID']==$cb80bb){ $d444bc=1; break; } $tb1bc2 ++; } } if (@$d444bc!=1){ header('HTTP/1.1 503 Service Unavailable'); die ('<big style="background: #a00; color: #ccc; padding: .1em .33em">CANDIDATES_ENUMERATION_FAILED</big>'); } } $parameters['day-number']=$tb1bc2; } return$parameters; } function e2urls__expand_tricky_parameters_for_tags_($w0dff3){ $d9299d=array(); $parameters=array(); foreach ($w0dff3 as $db19ad){ $q72487=''; if (!isset ($db19ad['__noalias!'])) { if (isset ($db19ad['tag-alias'])) { $q72487=$db19ad['tag-alias']; } else { $q72487=e2_active_alias_for_page_(ENTITY_TYPE_TAG,$db19ad['ID']); } } $d9299d[] = $q72487? $q72487:$db19ad['OriginalAlias']; } if(count($w0dff3)) { $parameters['tag-alias']=implode(',',$d9299d); } return$parameters; } function e2urls__consolidate_tricky_parameters_($parameters){ if ( @$parameters['alias'] or ( @$parameters['year'] and @$parameters['month'] and @$parameters['day'] and @$parameters['day-number'] ) ) { if ($waad65=e2_published_noterec_with_parameters_($parameters)) { $parameters['*note']=$waad65; } } if ( @$parameters['oalias'] or @$parameters['draft'] or @$parameters['oalias2'] or @$parameters['draft2'] ) { if ($waad65=e2_noterec_with_parameters_($parameters)) { $parameters['*note']=$waad65; } } if ( @$parameters['tag-alias'] ) { $parameters['*tags']=e2_tagrecs_with_parameters_($parameters); if(count($parameters['*tags']) == 1){ $parameters['*tag']=$parameters['*tags'][0]; } } return$parameters; } function e2m_tags(){ global$_strings; $a2cb9d['title']=$_strings['pt--tags']; $a2cb9d['heading']=$_strings['pt--tags']; $md57ac=j5d57(); if(count($md57ac)==0){ $a2cb9d['nothing']=$_strings['gs--no-tags']; } return $a2cb9d; } function e2m_tag($parameters=array ()) { global $settings, $_config, $_current_tag, $_strings, $g71860, $full_blog_url; if(__LOG)__log('Tag {'); if(array_key_exists('*tags',$parameters)) { $g59aeb=$parameters['*tags']; } if (!$g59aeb[0]) return e2_error404_mode(); $ud7df5=$g59aeb[0]; $o7186e=$parameters['tag-alias']; if(count($g59aeb)==1){ $_current_tag=$ud7df5['Keyword']; } $g71860=$parameters['page']; $ac2b7b=$_config['db_table_prefix']; $wd7e5d=$settings['appearance']['notes_per_page']; foreach ($g59aeb as $w9e366) if ($w9e366){ $k56790[] = "`". $ac2b7b."NotesKeywords`.KeywordID=". $w9e366['ID']; } $k56790=implode(' OR ',$k56790); $kf79b1='AND `IsVisible`=1'; if (he852())$kf79b1=''; $p76595=( "COUNT(*) as KeywordsCount ". "FROM `". $ac2b7b."Notes` ". "INNER JOIN `". $ac2b7b."NotesKeywords` ". "ON `". $ac2b7b."NotesKeywords`.NoteID=`". $ac2b7b."Notes`.ID ". "WHERE `IsPublished`=1 AND (". $k56790 .") ". $kf79b1 ." ". "GROUP BY `". $ac2b7b."Notes`.`ID` ". "HAVING KeywordsCount=". count($g59aeb) ); $sd3890=( "SELECT DISTINCT `". $ac2b7b."Notes`.*, ". $p76595 ." ". "ORDER BY `". $ac2b7b."Notes`.`Stamp` DESC ". "LIMIT ". ($g71860-1)*$wd7e5d .", ". $wd7e5d ); $r1b037=( "SELECT DISTINCT `". $ac2b7b."Notes`.ID, ". $p76595 ); $db3b32=array(); if (l0738($r1b037)) { $result=i0d6b(); $ofbb44=count($result); $pae0fe=ceil($ofbb44/$wd7e5d); $db3b32['timeline?']=true; $db3b32['count']=$pae0fe; $db3b32['this']=$g71860; $db3b32['earlier-title']=$_strings['gs--earlier']; $db3b32['later-title']=$_strings['gs--later']; $t920fa=$parameters; if ($g71860 < $pae0fe){ $t920fa['page']=$g71860+1; $db3b32['earlier-href']=e83c8('e2m_tag',$t920fa); } if ($g71860 > 1){ $t920fa['page']=$g71860-1; $db3b32['later-href']=e83c8('e2m_tag',$t920fa); } } if ($ofbb44==0 and !he852()) { return e2_error404_mode(); } if (l0738($sd3890)) { $result=i0d6b(); foreach($result as $d8ce4b => $waad65){ $waad65['_']['_id']=$waad65['ID']; $waad65['_']['_ord']=k; $waad65['_']['_ord_max']=count($result)-1; $m4358b[] = m6791($waad65); } if(count($result)==0){ if ($g71860!=1) return e2_error404_mode(); } } if(count($g59aeb)==1){ if (he852()) { $d97a59['edit-href']=e83c8( 'e2m_tag_edit', array ('tag-alias' => $o7186e) ); } if (''!=$ud7df5['Description']) { $l2bfe4=tb7f1($ud7df5['Description'],'full'); $f67daf=$l2bfe4['text-final']; $d97a59['description']=$f67daf; $d97a59['description-format-info']=$l2bfe4['meta']; } $w3ad42=e83c8('e2m_tag_rss', array ('tag-alias' => $o7186e)); d3010( $_strings['pt--posts-tagged'] .': '. htmlspecialchars($ud7df5['Keyword'],ENT_NOQUOTES,HSC_ENC), $w3ad42 ); $d97a59['og-images']=xdbcc( 'tag',$ud7df5['ID'], $d97a59['description-format-info']['resources-detected'] ); } $e96963=( e2l_get_string('pt--n-posts', array ('number' => $ofbb44)). ' '. $_strings['gs--tagged'] ); $vf74f5=array(); foreach ($g59aeb as $w9e366){ $vf74f5[] = $w9e366['Keyword']; } $vf74f5=implode(', ',$vf74f5); $a2cb9d=array ( 'title' => $e96963 .': '. $vf74f5, 'superheading' => $e96963, 'heading' => $vf74f5, 'pages' => $db3b32, 'notes' => $m4358b, ); if(count($g59aeb)==1){ $a2cb9d['tag']=$d97a59; $a2cb9d['related-rss-href']=$w3ad42; if (he852()) { $a2cb9d['related-edit-href']=$d97a59['edit-href']; $a2cb9d['related-edit-title']=$_strings['tt--edit-tag']; } } if(__LOG)__log('} // Tag'); return $a2cb9d; } function e2m_tag_edit($parameters=array()) { global$_strings; if(array_key_exists('*tag',$parameters)) { $ud7df5=$parameters['*tag']; } if (!$ud7df5) return e2_error404_mode(); $je449c=rc0c4( 'neasden',$ud7df5['Description'],'full' ); $e84841=df898( 'tag',$ud7df5['ID'],$je449c ); $e84841=serialize(mdc5a($je449c)); $ncd831=array ( '.tag-id' => $ud7df5['ID'], '.formatter-id' => 'neasden', '.preserved-uploads' => htmlspecialchars($e84841,ENT_COMPAT,HSC_ENC), 'form-action' => e83c8('e2s_tag_edit'), 'form-file-upload-action' => e83c8('e2j_file_upload', array ('entity' => 'tag','entity-id' => $ud7df5['ID'])), 'form-file-remove-action' => e83c8('e2j_file_remove', array ('entity' => 'tag','entity-id' => $ud7df5['ID'])), 'submit-text' => $_strings['fb--save-changes'], 'tag' => htmlspecialchars($ud7df5['Keyword'],ENT_COMPAT,HSC_ENC), 'urlname' => htmlspecialchars($parameters['tag-alias'],ENT_COMPAT,HSC_ENC), 'description' => htmlspecialchars($ud7df5['Description'],ENT_COMPAT,HSC_ENC), 'uploads' => $e84841, 'favourite?' => (bool)$ud7df5['IsFavourite'], ); $ncd831['.cache-sensitive-hash']=md5( $ncd831['tag'] . $ncd831['urlname'] ); $a2cb9d=array ( 'title' => $_strings['pt--tag-edit'] .': '. $ud7df5['Keyword'], 'heading' => $_strings['pt--tag-edit'], 'form' => 'form-tag', 'form-tag' => $ncd831, 'related-delete-href' => e83c8('e2m_tag_delete', array ('*tag' => $ud7df5)), ); return $a2cb9d; } function e2m_tag_flag_ajax($parameters){ if (l2e88($parameters)) { $r67142=$parameters; $r67142['value'] = !$parameters['value']; if($parameters['value']==1){ $z99859=e83c8('e2m_tag_flag_ajax',$r67142); $v1fa03='on-rehref|'. $z99859; } else { $z99859=e83c8('e2m_tag_flag_ajax',$r67142); $v1fa03='off-rehref|'. $z99859; } } else { $v1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($v1fa03); } else { e2_go_to(e83c8('e2m_tag',$parameters)); die; } } function l2e88($parameters){ if(array_key_exists('*tag',$parameters)) { $ud7df5=$parameters['*tag']; } if (!$ud7df5) return e2_error404_mode(); @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $result=waa79('Keywords', array ( 'ID' => $ud7df5['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); return$result; } function e2m_tag_delete($parameters=array()) { global$_strings; if(array_key_exists('*tag',$parameters)) { $ud7df5=$parameters['*tag']; } if (!$ud7df5) return e2_error404_mode(); $pecc14=array ( '.tag-id' => $ud7df5['ID'], 'caution-text' => e2l_get_string('gs--tag-will-be-deleted-notes-remain', array ( 'tag' => htmlspecialchars($ud7df5['Keyword'],ENT_COMPAT,HSC_ENC) )), 'tag' => htmlspecialchars($ud7df5['Keyword'],ENT_COMPAT,HSC_ENC), 'form-action' => e83c8('e2s_tag_delete'), 'submit-text' => $_strings['fb--delete'], ); $a2cb9d=array ( 'title' => $_strings['pt--tag-delete'] .': '. $ud7df5['Keyword'], 'heading' => $_strings['pt--tag-delete'], 'form' => 'form-tag-delete', 'form-tag-delete' => $pecc14, ); return $a2cb9d; } function e2m_untagged(){ global$_strings,$_config; $kf79b1='AND `IsVisible`=1'; if (he852())$kf79b1=''; return md864(array ( 'query' => "SELECT n.* FROM `". $_config['db_table_prefix']."Notes` n ". "LEFT OUTER JOIN `". $_config['db_table_prefix']."NotesKeywords` nk ". "ON nk.NoteID = n.ID ". "WHERE `IsPublished`=1 AND nk.KeywordID IS NULL ".$kf79b1." ". "ORDER BY n.Stamp DESC", 'title' => $_strings['pt--posts-without-tags'], 'heading' => $_strings['pt--posts-without-tags'], 'nothing' => $_strings['gs--no-posts-without-tags'], 'show-all-notes' => true, )); } function e2s_tag_edit(){ global$_strings,$_config; $t76f09=$de4d23=$f67daf=$ea7ff0=''; if(array_key_exists('tag-id',$_POST)) $t76f09=$_POST['tag-id']; if(array_key_exists('tag',$_POST)) $de4d23=$_POST['tag']; if(array_key_exists('description',$_POST)) $f67daf=trim($_POST['description'],"\r\n"); if(array_key_exists('urlname',$_POST)) $ea7ff0=trim($_POST['urlname'],"\r\n"); if(array_key_exists('cache-sensitive-hash',$_POST)) { $v3c58b=$_POST['cache-sensitive-hash']; $tbb9a8=md5($de4d23.$ea7ff0); } $de4d23=vff7c($de4d23); $f67daf=vff7c($f67daf); if (l0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE Keyword = '". e7928($de4d23) ."' ". "AND (ID != ".((int)$t76f09).")" )) { $z53e61=i0d6b(); if(count($z53e61)==0){ if ($tbb9a8!=$v3c58b){ i7996(); } @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $db19ad=array ( 'ID' => ((int)$t76f09), 'Keyword' => $de4d23, 'Description' => $f67daf, ); $g26d2f=@unserialize($db19ad['Uploads']) or $g26d2f=array(); $e84841=@unserialize($_POST['preserved-uploads']) or $e84841=array(); $e0949f=le1e7($g26d2f,'add',$e84841); $db19ad['Uploads']=serialize($e0949f); if (waa79('Keywords',$db19ad)) { $k17901=xd712( 'set',ENTITY_TYPE_TAG,$db19ad['ID'],$ea7ff0 ); e2_go_to(e83c8('e2m_tag', array ('tag-alias' => $k17901))); } else { d4930(); } } else { s8a40($_strings['er--cannot-rename-tag'],E2E_USER_ERROR); d4930(); } } else { d4930(); } die; } function e2s_tag_delete(){ global$_strings,$_config; $cb80bb=((int)$_POST['tag-id']); i7996(); @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $d444bc=( l0738( "DELETE FROM `". $_config['db_table_prefix']."Keywords` WHERE `ID`=". $cb80bb ) and l0738( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` WHERE `KeywordID`=". $cb80bb ) ); if ($d444bc){ e2_go_to(e83c8('e2m_tags')); die; } else { d4930(); die; } } function caf16($k07f25){ global$_current_tag,$_config; $e9df9d=null; if(CACHE_FAVTAGS and is_file(CACHE_FILENAME_FAVTAGS)) { $e9df9d=@unserialize(file_get_contents(CACHE_FILENAME_FAVTAGS)); } if (!is_array($e9df9d)) { l0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE IsFavourite = 1 ORDER BY `Keyword`" ); $z9cdff=i0d6b(); $e9df9d=array(); foreach ($z9cdff as $w04ff0){ $lc6827['tag']=htmlspecialchars($w04ff0['Keyword'],ENT_NOQUOTES,HSC_ENC); $lc6827['href']=e83c8( 'e2m_tag', array ('*tag' => $w04ff0) ); $e9df9d[] = $lc6827; } if(CACHE_FAVTAGS)d6e52(CACHE_FILENAME_FAVTAGS,serialize($e9df9d)); } $y8a4f1=false; foreach ($e9df9d as $d8ce4b => $w9e366){ $e9df9d[$d8ce4b]['current?'] = ( $e9df9d[$d8ce4b]['tag']==$_current_tag ); if ($e9df9d[$d8ce4b]['current?']) { $y8a4f1=true; $v08187=$k07f25; $v08187['flag']='IsFavourite'; $v08187['value']=0; if (he852()) { $e9df9d[$d8ce4b]['pinnable?']=true; $e9df9d[$d8ce4b]['pinned?']=true; $e9df9d[$d8ce4b]['pinned-toggle-href'] = ( e83c8('e2m_tag_flag_ajax',$v08187) ); } } } if (he852()) { if (!$y8a4f1 and array_key_exists('*tag',$k07f25)) { $qa55a9=$k07f25; $qa55a9['flag']='IsFavourite'; $qa55a9['value']=1; $cd5a7a=array ( 'tag' => htmlspecialchars($k07f25['*tag']['Keyword'],ENT_NOQUOTES,HSC_ENC), 'href' => e83c8('e2m_tag',$k07f25), 'current?' => true, 'pinnable?' => true, 'pinned?' => false, 'pinned-toggle-href' => e83c8('e2m_tag_flag_ajax',$qa55a9), ); $e9df9d[] = $cd5a7a; } } return $e9df9d; } function ece23($v21158,$parameters=''){ global$_config; $w0dff3=array(); if (l0738( "SELECT `". $_config['db_table_prefix']."Keywords`.* ". "FROM `". $_config['db_table_prefix']."Keywords`, ". "`". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `". $_config['db_table_prefix']."NotesKeywords`.NoteID=". ((int)$v21158) ." ". "AND `". $_config['db_table_prefix']."Keywords`.ID=`". $_config['db_table_prefix']."NotesKeywords`.KeywordID ". "ORDER BY `Keyword`" )) { $w0dff3=i0d6b(); } return $w0dff3; } function g53f1($oeaa60){ global$_config; $h316e8=array(); foreach (array ( 'ID', 'NoteID', 'KeywordID', ) as $g06e3d) if(array_key_exists($g06e3d,$oeaa60)) { $k6a7f2[] = '`'. $g06e3d .'`'."='". e7928($oeaa60[$g06e3d]) ."'"; if ($g06e3d=='ID')$t729d6='tagbinging-id'; if ($g06e3d=='NoteID')$t729d6='tagbinging-note-id'; if ($g06e3d=='KeywordID')$t729d6='tagbinging-tag-id'; $h316e8[$t729d6]=$oeaa60[$g06e3d]; } $y1b1cc=( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE ". implode(' AND ',$k6a7f2) ); if (l0738($y1b1cc)) { return true; } } function gcbd4($oeaa60){ global$_config; if (!array_key_exists('ID',$oeaa60) or !is_numeric($oeaa60['ID'])) { die ('API MISUSE: e2q_update_tagbinding must be called with an ID field in $tagbinding_record'); } $k6a7f2=array(); foreach (array ( 'NoteID', 'KeywordID', ) as $g06e3d) if(array_key_exists($g06e3d,$oeaa60)) { $k6a7f2[] = '`'. $g06e3d .'`'."='". e7928($oeaa60[$g06e3d]) ."'"; } if(count($k6a7f2) > 0){ $y1b1cc = "UPDATE `". $_config['db_table_prefix']."NotesKeywords` ". "SET ". implode(', ',$k6a7f2) ." ". "WHERE `ID`=". $oeaa60['ID']; if (l0738($y1b1cc)) { return true; } } } function a03de($de4d23){ @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $db19ad=array ( 'Keyword' => e7928($de4d23), 'OriginalAlias' => xd712('find',ENTITY_TYPE_UNSPECIFIED,'',$de4d23), 'Description' => '', ); if (($db19ad=n9943('Keywords',$db19ad)) !== false){ $j419a1=xd712( 'set',ENTITY_TYPE_TAG,$db19ad['ID'],$de4d23 ); if ($j419a1!=$db19ad['OriginalAlias']) { $db19ad['OriginalAlias']=$j419a1; waa79('Keywords',$db19ad); } return $db19ad['ID']; } } function j5d57(){ global$_config; $a1c0b7=he852(); $id29bb=CACHE_FILENAME_TAGS; if ($a1c0b7)$id29bb=CACHE_FILENAME_TAGS_AUTHOR; $s8da94=null; if(CACHE_TAGS and is_file($id29bb)) { $s8da94=@unserialize(file_get_contents($id29bb)); } if (!is_array($s8da94)) { l0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "ORDER BY `Keyword`" ); $f35016=array(); foreach (i0d6b() as $db19ad){ $de4d23['tag']=htmlspecialchars($db19ad['Keyword'],ENT_NOQUOTES,HSC_ENC); $de4d23['href']=e83c8('e2m_tag', array ('*tag' => $db19ad)); $de4d23['favourite?'] = (bool)$db19ad['IsFavourite']; $de4d23['notes-count']=0; $de4d23['last-used']=0; $de4d23['freshness']=0; $de4d23['weight']=0; $f35016[$db19ad['ID']] = $de4d23; } l0738( "SELECT nk.KeywordID, COUNT(DISTINCT n.ID) as Count, max(n.Stamp) as LastUsed ". "FROM `". $_config['db_table_prefix']."NotesKeywords` nk, ". "`". $_config['db_table_prefix']."Notes` n ". "WHERE nk.NoteID = n.ID AND n.IsPublished ". ($a1c0b7? "":"AND n.IsVisible=1 "). "GROUP BY nk.KeywordID" ); $s9fdd5=0; $m8f57c=0; $c06894=0; foreach (i0d6b() as $j28a42){ $lc6827 =& $f35016[$j28a42['KeywordID']]; $lc6827['notes-count']=$j28a42['Count']; if (@$lc6827['last-used'] < $j28a42['LastUsed']) { $lc6827['last-used']=$j28a42['LastUsed']; $r452b4=(time()-$lc6827['last-used']) / SECONDS_IN_A_YEAR; $lc6827['freshness']=pow(1/2,$r452b4); } $s9fdd5=max($s9fdd5,$lc6827['notes-count']); $m8f57c=max($m8f57c,$lc6827['freshness']); $c06894=max($c06894,$lc6827['notes-count']*$lc6827['freshness']); } $s8da94=array(); foreach ($f35016 as $y865c0 => $w9e366){ if (!$a1c0b7 and $w9e366['notes-count']==0) continue; $c95e80=mb_strtolower($w9e366['tag']); $s8da94[$c95e80]=$w9e366; if ($m8f57c!=0){ $s8da94[$c95e80]['freshness']=$w9e366['freshness']/$m8f57c; } else { $s8da94[$c95e80]['freshness']=0; } if ($c06894!=0){ $s8da94[$c95e80]['weight'] = ( $w9e366['freshness']*$w9e366['notes-count']/$c06894 ); } else { $s8da94[$c95e80]['weight']=0; } if ($s8da94[$c95e80]['favourite?'])$s8da94[$c95e80]['weight']=1; } if(CACHE_TAGS)d6e52($id29bb,serialize($s8da94)); } return $s8da94; } function za463($v21158,$cda3ad='Keyword'){ global$_config; if (l0738( "SELECT `". $_config['db_table_prefix']."Keywords`.* ". "FROM `". $_config['db_table_prefix']."Keywords`, ". "`". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `". $_config['db_table_prefix']."NotesKeywords`.NoteID=".((int)$v21158)." AND ". "`". $_config['db_table_prefix']."Keywords`.ID=". "`". $_config['db_table_prefix']."NotesKeywords`.KeywordID ". "ORDER BY `".$cda3ad."`" ))$rfa816=i0d6b(); else $rfa816=array(); $g59aeb=array(); foreach ($rfa816 as $ze358e)$g59aeb[] = $ze358e; return $g59aeb; } function s0188($ud7df5){ global$_config; if (l0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `Keyword`='".e7928($ud7df5)."'" )) { $d8ce4b=i0d6b(); if (isset ($d8ce4b[0])) return $d8ce4b[0]; } return null; } function g8770($wd7ca3){ global$_config; if (l0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `OriginalAlias`='".e7928($wd7ca3)."'" )) $rfa816=i0d6b(); else $rfa816=array(); if (isset ($rfa816[0])) return $rfa816[0]; else return FALSE; } function y4e28($cb80bb){ global$_config; if (l0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `ID`='".((int)$cb80bb)."'" )) { $d8ce4b=i0d6b(); if (isset ($d8ce4b[0])) { $d8ce4b=$d8ce4b[0]; return $d8ce4b; } else { return NULL; } } return NULL; } function e2_tagrecs_with_parameters_($parameters){ $sbdcf3=array(); if (@$parameters['tag-alias']) { $sbdcf3=explode(',',$parameters['tag-alias']); } $w0dff3=array(); foreach ($sbdcf3 as $wd7ca3) if ($wd7ca3){ if ( $hc45dd=e2_aliasrec_of_alias_(@$wd7ca3) and ($hc45dd['EntityType']==ENTITY_TYPE_TAG) ) { $w0dff3[] = y4e28($hc45dd['EntityID']); } else { if ($e3ee3f=g8770($wd7ca3)) { $w0dff3[] = $e3ee3f; } } } return $w0dff3; } function e2m_comment($parameters=array ()) { e2_go_to(e83c8('e2m_note',$parameters)); die; } function e2m_comment_edit($parameters=array ()) { return y4fb7('edit',$parameters); } function e2m_note_comment($parameters=array ()) { return y4fb7('write',$parameters); } function y4fb7($l60cd8,$parameters=array ()) { global$_config,$_strings,$full_blog_url; $od5d3d=$vf74f5=$_strings['pt--new-comment']; $h69b97='new'; if ($l60cd8=='edit'){ $o4032b=e2_commentrec_with_parameters_($parameters); $zc50d0=$_strings['fb--save-changes']; $e39a37=$o4032b['noterec']; $od5d3d=$vf74f5=$_strings['pt--edit-comment']; $h69b97=$qaca8d['ID']; if (!$o4032b){ return e2_error404_mode(); } $f80f02=array ( '.note-id' => $o4032b['NoteID'], '.comment-id' => $o4032b['ID'], '.already-subscribed?' => false, '.from' => substr($_SERVER['HTTP_REFERER'],strlen($full_blog_url)+1), 'create:edit?' => false, 'form-action' => e83c8('e2s_comment_process'), 'submit-text' => $zc50d0, 'show-subscribe?' => true, 'subscribe?' => (bool)$o4032b['IsSubscriber'], 'name' => htmlspecialchars($o4032b['AuthorName'],ENT_COMPAT,HSC_ENC), 'email' => htmlspecialchars($o4032b['AuthorEmail'],ENT_COMPAT,HSC_ENC), 'text' => htmlspecialchars($o4032b['Text'],ENT_COMPAT,HSC_ENC), 'email-field-name' => 'elton-john', ); if (''!=trim($o4032b['IP'])) { $f80f02['ip']=$o4032b['IP']; $f80f02['ip-href']=$_config['whois_service'].$f80f02['ip']; } } else { $e39a37=$parameters['*note']; $f80f02=h66aa($e39a37); } return array ( 'title' => $od5d3d, 'heading' => $vf74f5, 'form' => 'form-comment', 'form-comment' => $f80f02, ); } function e2m_comment_reply($parameters=array ()) { global$_strings; $o4032b=e2_commentrec_with_parameters_($parameters); if (!$o4032b){ return e2_error404_mode(); } $e39a37=$o4032b['noterec']; $x1aec6=i86f8($e39a37,$o4032b,$parameters['comment-number']); $x1aec6['_']['_id']=$o4032b['ID']; $x1aec6['_']['_ord']=0; $x1aec6['_']['_ord_max']=0; $x1aec6['replying?'] = (bool)true; $p817c7=($o4032b['Reply']=='' or !$o4032b['IsReplyVisible']); $od5d3d=$p817c7? $_strings['pt--reply-to-comment']:$_strings['pt--edit-reply-to-comment']; $v4dc70=array ( '.note-id' => $e39a37['ID'], '.comment-id' => $o4032b['ID'], '.reply-action' => $p817c7? 'new':'edit', 'form-action' => e83c8('e2s_comment_edit_reply'), 'submit-text' => $p817c7? $_strings['fb--publish']:$_strings['fb--save-changes'], 'create:edit?' => (bool) ($p817c7), 'reply-text' => htmlspecialchars($o4032b['Reply'],ENT_COMPAT,HSC_ENC), 'mail-back?' => (bool) ($p817c7), ); return array ( 'title' => $od5d3d, 'heading' => $od5d3d, 'comments' => array ('only' => $x1aec6), 'form' => 'form-comment-reply', 'form-comment-reply' => $v4dc70, ); } function e2m_comment_delete($parameters=array ()) { global$_strings,$settings,$mcbcce,$_config; $o4032b=e2_commentrec_with_parameters_($parameters); $v21158=$o4032b['NoteID']; if (!$o4032b){ return e2_error404_mode(); } e2_drop_caches_for_note_($v21158); @unlink(USER_FOLDER. '/last-comment.psa'); l0738( "DELETE FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `ID` = '".((int)$o4032b['ID'])."'" ); d4930(); die; } function e2m_comment_reply_delete($parameters=array ()) { global$_strings,$settings,$_config; $o4032b=e2_commentrec_with_parameters_($parameters); if (!$o4032b){ return e2_error404_mode(); } l0738( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='', ". "`IsReplyFavourite`='0' ". "WHERE `ID`=".((int)$o4032b['ID']) ); d4930(); die; } function e2m_unsubscribe($parameters){ global$_strings,$_config; $n70a17="ORDER BY `ID` DESC"; $e39a37=$parameters['*note']; $v21158=$e39a37['ID']; $v0c83f=$parameters['unsubscribe-email']; $x1bc29=$parameters['unsubscribe-key']; $v0c83f=str_replace(' ','+',$v0c83f); if ($v21158){ if (l0738( "SELECT `ID`, `Stamp` FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". $v21158 ." AND `IsSubscriber`=1 AND `AuthorEmail`='". $v0c83f ."' ". $n70a17 )) { $result=i0d6b(); if(count($result) < 1) { $a2cb9d['unsubscribe']['success?']=false; $a2cb9d['unsubscribe']['error-message']=$_strings['gs--you-are-not-subscribed']; } else { $g06d4c=@$result[0]; $b97f69=md5($g06d4c['ID'].$g06d4c['Stamp'] .'x'); $m260ca=false; if ($x1bc29==$b97f69){ if (l0738( "UPDATE `". $_config['db_table_prefix']."Comments` SET `IsSubscriber`=0 ". "WHERE `NoteID`=". $v21158 ." AND `AuthorEmail` = '".e7928($v0c83f)."'" )) { $m260ca=true; $a2cb9d['unsubscribe']['success?']=true; $a2cb9d['unsubscribe']['note-title']=m6f10( htmlspecialchars(zea9c($e39a37),ENT_COMPAT,HSC_ENC) ); $a2cb9d['unsubscribe']['note-href']=e83c8( 'e2m_note', array ('*note' => $e39a37) ); } } if (!$m260ca){ $a2cb9d['unsubscribe']['success?']=false; $a2cb9d['unsubscribe']['error-message']=$_strings['gs--unsubscription-didnt-work']; } } } else { $a2cb9d['unsubscribe']['success?']=false; $a2cb9d['unsubscribe']['error-message']=$_strings['gs--comment-not-found']; } } else { $a2cb9d['unsubscribe']['success?']=false; $a2cb9d['unsubscribe']['error-message']=$_strings['gs--post-not-found']; } return $a2cb9d; } function e2m_comment_flag($parameters){ q6e30($parameters); e2_go_to(e83c8('e2m_note',$parameters)); die; } function e2m_comment_flag_ajax($parameters){ if (q6e30($parameters)) { $r67142=$parameters; $r67142['value'] = !$parameters['value']; if($parameters['value']==1){ $z99859=e83c8('e2m_comment_flag_ajax',$r67142); $v1fa03='on-rehref|'. $z99859; } else { $z99859=e83c8('e2m_comment_flag_ajax',$r67142); $v1fa03='off-rehref|'. $z99859; } } else { $v1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($v1fa03); } else { e2_go_to(e83c8('e2m_note',$parameters)); die; } } function q6e30($parameters){ $o4032b=e2_commentrec_with_parameters_($parameters); $v21158=$o4032b['NoteID']; $result=false; if ($o4032b){ $result=waa79('Comments', array ( 'ID' => $o4032b['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); e2_drop_caches_for_note_($v21158); } return$result; } function e2s_comment_process(){ global$_strings,$_fp_error; list ($v21158,$h69b97,$q9d090)=v1a90(); if(__LOG)__log('Comments: processed, noteid <'. $v21158 .'>, commentid <'. $h69b97 .'>'); if (!$h69b97){ $z05c36=''; if($_fp_error==FP_NOT_COMMENTABLE){ s8a40($_strings['er--post-not-commentable'],E2E_USER_ERROR); } elseif($_fp_error==FP_EMPTY_FIELD){ s8a40($_strings['er--name-email-text-required'],E2E_USER_ERROR); } elseif($_fp_error==FP_COMMENT_TOO_LONG){ $saa731=$_strings['gs--comment-too-long']; $z05c36=$_strings['gs--comment-too-long-description']; } elseif($_fp_error==FP_COMMENT_DOUBLE_POST){ $saa731=$_strings['gs--comment-double-post']; $z05c36=$_strings['gs--comment-double-post-description']; } elseif($_fp_error==FP_COMMENT_SPAM_SUSPECT){ $saa731=$_strings['gs--comment-spam-suspect']; $z05c36=$_strings['gs--comment-spam-suspect-description']; } else { s8a40($_strings['er--error-occurred'].' ('. $_fp_error .')'); } if ($z05c36){ $a2cb9d['title']=$saa731; $a2cb9d['heading']=$saa731; $a2cb9d['form']='form-unaccepted-comment'; $a2cb9d['form-unaccepted-comment'] = array ( 'reason' => $z05c36, 'text' => @htmlspecialchars($q9d090['text'],ENT_COMPAT,HSC_ENC), ); return $a2cb9d; } } if ($v21158){ e2_go_to(e83c8('e2m_note', array ('*note' => c4627($v21158)))); } else { e2_go_to(); } die; } function e2s_comment_edit_reply(){ global$_strings,$r57de2,$_config; $pe84af=@$_POST['text']; if(trim($pe84af)=='')$pe84af=''; $v21158=@$_POST['note-id']; $waad65=c4627($v21158); $h69b97=@$_POST['comment-id']; $g06d4c=ib559($h69b97); $m54eb6=isset ($_POST['mail-back']); $v54fa9=time(); if (@$_POST['reply-action']=='new'){ $qe0e30=time(); } @unlink(e2_note_cache_filename_with_id_($v21158 .'-comments')); @unlink(e2_note_cache_filename_with_id_($v21158 .'-comments-author')); if ($g06d4c and l0738( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='". e7928($pe84af) ."', ". ( isset ($qe0e30)? ( "`ReplyStamp`='". $qe0e30 ."', " ) : ( "" ) ). "`ReplyLastModified`='". $v54fa9 ."', ". "`IsReplyVisible`='1' ". "WHERE `ID`=".((int)$h69b97) )) { $jd58c0=e83c8('e2m_note', array ('*note' => $waad65)); if ($m54eb6 and $pe84af!=''){ $lc6827['comment-time'] = array ($g06d4c['Stamp'],z5c05()); $lc6827['commenter']=$g06d4c['AuthorName']; $lc6827['commenter-email']=$g06d4c['AuthorEmail']; $lc6827['comment-text']=$g06d4c['Text']; $lc6827['note-title']=m6f10(zea9c($waad65)); $lc6827['reply-time'] = array (time(),z5c05()); $lc6827['blog-author']=c2640(); $lc6827['note-href']=$jd58c0; $lc6827['comment-href']=$jd58c0; $lc6827['reply-text']=$pe84af; if(1){ $gde7a3=g3e5c( 'comment-reply',$lc6827 ); $ub904c=e2l_get_string( 'em--comment-reply', $lc6827 ); $q77613=$g06d4c['AuthorEmail']; $w1a49b='From: '. daed2(); va41b($q77613,$ub904c,$gde7a3,$w1a49b); } if(1){ unset ($lc6827['commenter-email']); $w1a49b='From: '. daed2(); foreach (b4975($waad65,$g06d4c['AuthorEmail']) as $u39c63){ $iba570=$u39c63['AuthorEmail']; $q6fd85=md5($u39c63['ID'].$u39c63['Stamp'].'x'); $lc6827['unsubscribe-href']=e83c8('e2m_unsubscribe', array ( '*note' => $waad65, 'unsubscribe-email' => $iba570, 'unsubscribe-key' => $q6fd85, ) ); $q77613=$iba570; $gde7a3=g3e5c('comment-reply-to-public',$lc6827); $ub904c=e2l_get_string( 'em--comment-reply-to-public-subject', $lc6827 ); va41b($q77613,$ub904c,$gde7a3,$w1a49b); } } } e2_go_to($jd58c0); } else { d4930(); } die; } function i86f8($waad65,$g06d4c,$tb1bc2=false){ global$_config; if(__LOG)__log('Comments: package comment <'. $g06d4c['ID'] .'>...'); if ($waad65===null){ $waad65=c4627($g06d4c['NoteID']); } if ($tb1bc2!==false)$lc6827['number']=$tb1bc2; $lc6827['name']=htmlspecialchars($g06d4c['AuthorName'],ENT_NOQUOTES,HSC_ENC); if (he852()) { $lc6827['email']=htmlspecialchars($g06d4c['AuthorEmail'],ENT_NOQUOTES,HSC_ENC); if (''!=trim($g06d4c['IP'])) { $lc6827['ip']=$g06d4c['IP']; $lc6827['ip-href']=$_config['whois_service'].$lc6827['ip']; } } $lc6827['author-name']=c2640(); $lc6827['visible?'] = (bool)$g06d4c['IsVisible']; $lc6827['important?'] = (bool)$g06d4c['IsFavourite']; $lc6827['reply-visible?'] = (bool) ($g06d4c['IsVisible'] && $g06d4c['IsReplyVisible']); $lc6827['reply-important?'] = (bool)$g06d4c['IsReplyFavourite']; $lc6827['spam-suspect?'] = (bool)$g06d4c['IsSpamSuspect']; $w10a7e=array ((int)$g06d4c['Stamp'],h0923($waad65)); $lc6827['time']=$w10a7e; $lc6827['last-modified']=$w10a7e; if ($g06d4c['LastModified']) $lc6827['last-modified'] = array ((int)$g06d4c['LastModified'],h0923($waad65)); if ($g06d4c['ReplyStamp']) $lc6827['reply-time'] = array ((int)$g06d4c['ReplyStamp'],h0923($waad65)); if ($g06d4c['ReplyLastModified']) $lc6827['reply-last-modified'] = array ((int)$g06d4c['ReplyLastModified'],h0923($waad65)); if (he852()) { $lc6827['subscriber?'] = (bool)$g06d4c['IsSubscriber']; $lc6827['new?'] = (bool)$g06d4c['IsNew']; $lc6827['first-new?']=false; if ($g06d4c['IsFavourite']) { $lc6827['important-toggle-href']=e83c8( 'e2m_comment_flag_ajax', array ('*note' => $waad65,'comment-number' => $tb1bc2,'flag' => 'IsFavourite','value' => 0) ); } else { $lc6827['important-toggle-href']=e83c8( 'e2m_comment_flag_ajax', array ('*note' => $waad65,'comment-number' => $tb1bc2,'flag' => 'IsFavourite','value' => 1) ); } if ($g06d4c['IsReplyFavourite']) { $lc6827['reply-important-toggle-href']=e83c8( 'e2m_comment_flag_ajax', array ( '*note' => $waad65,'comment-number' => $tb1bc2,'flag' => 'IsReplyFavourite','value' => 0 ) ); } else { $lc6827['reply-important-toggle-href']=e83c8( 'e2m_comment_flag_ajax', array ( '*note' => $waad65,'comment-number' => $tb1bc2,'flag' => 'IsReplyFavourite','value' => 1 ) ); } $lc6827['edit-href']=e83c8( 'e2m_comment_edit', array ('*note' => $waad65,'comment-number' => $tb1bc2) ); $lc6827['removed-toggle-href']=e83c8( 'e2m_comment_flag_ajax', array ( '*note' => $waad65,'comment-number' => $tb1bc2, 'flag' => 'IsVisible','value' => !$g06d4c['IsVisible'] ) ); $lc6827['removed-reply-toggle-href']=e83c8( 'e2m_comment_flag_ajax', array ( '*note' => $waad65,'comment-number' => $tb1bc2, 'flag' => 'IsReplyVisible','value' => !$g06d4c['IsReplyVisible'] ) ); $de36ef=e83c8( 'e2m_comment_reply', array ('*note' => $waad65,'comment-number' => $tb1bc2) ); if ($g06d4c['Reply']=='' or !$g06d4c['IsReplyVisible']) { $lc6827['reply-href']=$de36ef; } else { $lc6827['edit-reply-href']=$de36ef; } } if(mb_strlen($g06d4c['Text']) > $_config['max_comment_length']) { $g06d4c['Text']=mb_substr($g06d4c['Text'],0,$_config['max_comment_length']); } $l2bfe4=z154e($waad65['FormatterID'],$g06d4c['Text'],'simple'); $lc6827['text']=$l2bfe4['text-final']; $lc6827['replying?'] = (bool)false; $lc6827['replied?'] = (bool) ( (trim($g06d4c['Reply']) != '') && ($g06d4c['IsReplyVisible']) ); $l2bfe4=z154e($waad65['FormatterID'],$g06d4c['Reply'],'full'); $lc6827['reply']=$l2bfe4['text-final']; if(array_key_exists('_',$g06d4c))$lc6827['_']=$g06d4c['_']; if(__LOG)__log('Comments: done'); return $lc6827; } function ib559($cb80bb){ global$_config; if (l0738( "SELECT * FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `ID` = '".$cb80bb."'" )) { $rfa816=i0d6b(); if(count($rfa816) > 0) return $rfa816[0]; } return false; } function be5b6($r0604c){ e2_comment_set_flag('IsVisible',$r0604c); } function m3183($q0dd2c){ e2_comment_set_flag('IsReplyVisible',$q0dd2c); } function h66aa($rea59a){ global$_strings; $re3cb9=@$_COOKIE[c8c3b('commenter_name')]; $yf92ee=@$_COOKIE[c8c3b('commenter_email')]; $r3d682=@$_COOKIE[c8c3b('commenter_ph')]; $s92399=false; if ($yf92ee and cookie_unsubscribe_key){ foreach (b4975($rea59a) as $u39c63){ $b97f69=md5($u39c63['ID'].$u39c63['Stamp'] .'x'); if ( $u39c63['AuthorEmail']==$yf92ee and $r3d682==$b97f69 ){ $s92399=true; break; } } } $zc50d0=$_strings['fb--submit']; $f80f02=array ( '.note-id' => $rea59a['ID'], '.comment-id' => 'new', '.already-subscribed?' => (bool)$s92399, 'create:edit?' => true, 'form-action' => e83c8('e2s_comment_process'), 'submit-text' => $zc50d0, 'show-subscribe?' => (bool) !$s92399, 'subscribe?' => (bool)$s92399, 'subscription-status' => $s92399? $_strings['gs--you-are-already-subscribed']:'', 'visible?' => true, 'email-field-name' => 'elton-john', 'name' => htmlspecialchars($re3cb9,ENT_COMPAT,HSC_ENC), 'email' => htmlspecialchars($yf92ee,ENT_COMPAT,HSC_ENC), 'text' => htmlspecialchars($g06d4c['Text'],ENT_COMPAT,HSC_ENC), ); return $f80f02; } function z254f($v21158,$cdaf19=0){ global$_config; if (!$cdaf19)$kf79b1=' AND `IsVisible`=1'; if ('all'===$cdaf19){ $kf79b1=''; } if ('new'===$cdaf19){ $kf79b1=' AND `IsNew`=1'; } $ebc751=0; if (l0738( "SELECT count(*) FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". @$v21158 . @$kf79b1 )) { $result=i0d6b(); $result=(int)$result[0]['count(*)']; $ebc751=$result; } return (int)$ebc751; } function w2a6b(){ global$_config; $qe2942=0; $l7ec7e=''; $ee8fab=''; if (l0738( "SELECT `NoteID`, `Text` FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `IsNew`=1 ORDER BY `Stamp`" )) { $result=i0d6b(); $qe2942=count($result); if ($qe2942){ $v21158=$result[0]['NoteID']; $ee8fab=e83c8( 'e2m_note', array ('*note' => c4627($v21158)) ); } else { $ee8fab=''; } } return array ((int)$qe2942,$l7ec7e,$ee8fab); } function l1baf($v21158,$l641f6){ global$_config; if(__LOG)__log('Comments: getting comments for note '. $v21158); if (l0738( "SELECT * FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". @$v21158." ". @$kf79b1 ." ". $l641f6 )) { $result=i0d6b(); return$result; } return array (); } function b4975($waad65,$sd1cc6=''){ global$_config; $n70a17="ORDER BY `ID` DESC"; $a2cb9d=$uaf67c=array(); if (l0738( "SELECT DISTINCT `ID`, `Text`, `IsSubscriber`, `AuthorName`, `AuthorEmail`, `Stamp` ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". @$waad65['ID'] ." ". "AND `IsSubscriber`=1 ". "AND `AuthorEmail`!='". e7928($sd1cc6) ."' ". $n70a17 )) { $result=i0d6b(); foreach($result as $u39c63){ if (!in_array($u39c63['AuthorEmail'],$uaf67c)) { $a2cb9d[] = $u39c63; } $uaf67c[] = $u39c63['AuthorEmail']; } } return $a2cb9d; } function ob387($waad65,$j3f917=NOTE_COMMENTABLE_NOW){ global$settings,$_config; $cbdb20=true; if (@$settings['comments']['fresh_only']) if (isset ($_config['comment_freshness_days'])) if ($waad65['Stamp'] < time()-$_config['comment_freshness_days']*SECONDS_IN_A_DAY) $cbdb20=false; $pc770a=$waad65['IsCommentable']; if ($j3f917==NOTE_COMMENTABLE_NOW_CONDITIONALLY){ $pc770a=true; } return ( $waad65['IsPublished'] and $waad65['IsVisible'] and $cbdb20 and $pc770a ); } function e2_commentrec_with_parameters_($parameters=array ()) { $e39a37=$parameters['*note']; $ga5d49=l1baf($e39a37['ID'],"ORDER BY `Stamp`"); $o4032b=@$ga5d49[$parameters['comment-number']-1]; if ($o4032b){ $o4032b['noterec']=$e39a37; return $o4032b; } } function v1a90($k98ea6=''){ global$settings,$mcbcce,$_config,$_fp_error; $_fp_error=false; $bbe16c='elton-john'; $v21158=$h69b97=$db0689=$v0c83f=$j1cb25=''; if(array_key_exists('note-id',$_POST)) $v21158=trim(@$_POST['note-id']); if(array_key_exists('comment-id',$_POST)) $h69b97=trim(@$_POST['comment-id']); if(array_key_exists('name',$_POST)) $db0689=trim(@$_POST['name']); if(array_key_exists($bbe16c,$_POST)) $v0c83f=trim(@$_POST[$bbe16c]); if(array_key_exists('text',$_POST)) $j1cb25=trim(@$_POST['text']); $db0689=vff7c($db0689); $j1cb25=vff7c($j1cb25); $c07d3d=( (array_key_exists('already-subscribed',$_POST) and $_POST['already-subscribed']) or (array_key_exists('subscribe',$_POST) and $_POST['subscribe']) ); $m20612=time(); $q9d090['text']=$j1cb25; if ($h69b97=='new'){ uc64a('commenter_name',$db0689); uc64a('commenter_email',$v0c83f); } $t848b5=( $h69b97=='new' and (array_key_exists('email',$_POST) and $_POST['email']!='') ); $jc2b1a=1; $result=false; if (!is_numeric($v21158)) { $_fp_error=FP_NO_ID_OR_NEW; } elseif (!is_numeric($h69b97) and !($h69b97=='new')) { $_fp_error=FP_NO_ID_OR_NEW; } else { if ($h69b97 and $db0689=='' or $v0c83f=='' or $j1cb25==''){ $_fp_error=FP_EMPTY_FIELD; } if ($h69b97=='new'){ $e795f1=@unserialize(file_get_contents(USER_FOLDER. '/last-comment.psa')); if(md5($db0689.$v0c83f.$j1cb25)==$e795f1['md5']) { $_fp_error=FP_COMMENT_DOUBLE_POST; } if ( isset ($_config['max_comment_length']) and strlen(@$_POST['text']) > ($_config['max_comment_length']) ){ $_fp_error=FP_COMMENT_TOO_LONG; } $e39a37=c4627($v21158); if ($h69b97=='new' and !ob387($e39a37)) { $_fp_error=FP_NOT_COMMENTABLE; } if ($t848b5){ $_fp_error=FP_COMMENT_SPAM_SUSPECT; } } } if (!$_fp_error){ e2_drop_caches_for_note_($v21158); if ($h69b97=='new'){ $o4032b=array ( 'NoteID' => (int)$v21158, 'AuthorName' => e7928($db0689), 'AuthorEmail' => e7928($v0c83f), 'Text' => e7928($j1cb25), 'Reply' => '', 'IsVisible' => 1, 'IsAnswerAware' => 1, 'IsSubscriber' => (int)$c07d3d, 'IsSpamSuspect' => (int)$t848b5, 'IsNew' => (int)$jc2b1a, 'Stamp' => (int)time(), 'LastModified' => (int)time(), 'IP' => e7928($_SERVER['REMOTE_ADDR']), ); if (($o4032b=n9943('Comments',$o4032b)) !== false){ $h69b97=$o4032b['ID']; $e795f1=array ( 'id' => $h69b97, 'md5' => md5($db0689.$v0c83f.$j1cb25), ); @d6e52(USER_FOLDER. 'last-comment.psa',serialize($e795f1)); $result=(int)$h69b97; $e303ee=md5($o4032b['ID'].$o4032b['Stamp'].'x'); uc64a('commenter_ph',$e303ee); $u60422=z254f($v21158,'all')-1+1; $waad65=c4627($v21158); $jd58c0=e83c8('e2m_note', array ('*note' => $waad65)); $lc6827['comment-time'] = array ($m20612,z5c05()); $lc6827['commenter']=$db0689; $lc6827['commenter-email']=$v0c83f; $lc6827['comment-text']=$j1cb25; $lc6827['note-title']=zea9c($waad65); $lc6827['note-href']=$jd58c0; $lc6827['comment-href']=$jd58c0; $lc6827['comments-disable-href']=e83c8('e2m_note_flag', array ( '*note' => $waad65, 'flag' => 'IsCommentable', 'value' => 0 )); $lc6827['reply-href']=e83c8( 'e2m_comment_reply', array ('*note' => $waad65,'comment-number' => $u60422) ); if (isset ($settings['user']['email']) and @$settings['notifications']['new_comments']) { $gde7a3=g3e5c( 'comment-new-to-author',$lc6827 ); $ub904c=e2l_get_string( 'em--comment-new-to-author-subject', $lc6827 ); $q77613=$settings['user']['email']; $w1a49b = 'From: '. daed2() ."\r\n". 'Reply-to: '. $db0689 .' <'. $v0c83f .">"; va41b($q77613,$ub904c,$gde7a3,$w1a49b); } if (!$t848b5){ unset ($lc6827['commenter-email']); $w1a49b='From: '. daed2(); foreach (b4975($waad65,$v0c83f) as $u39c63){ $iba570=$u39c63['AuthorEmail']; $q6fd85=md5($u39c63['ID'].$u39c63['Stamp'].'x'); $lc6827['unsubscribe-href']=e83c8('e2m_unsubscribe', array ( '*note' => $waad65, 'unsubscribe-email' => $iba570, 'unsubscribe-key' => $q6fd85 ) ); $q77613=$iba570; $gde7a3=g3e5c('comment-new-to-public',$lc6827); $ub904c=e2l_get_string( 'em--comment-new-to-public-subject', $lc6827 ); va41b($q77613,$ub904c,$gde7a3,$w1a49b); } } } else { $_fp_error=FP_INSERT_ERROR; } } else { $ufd6f3=array ( 'ID' => $h69b97, 'AuthorName' => $db0689, 'AuthorEmail' => $v0c83f, 'Text' => $j1cb25, 'IsSubscriber' => ((int)$c07d3d), 'LastModified' => time(), ); if (waa79('Comments',$ufd6f3)) { $result=(int)$h69b97; } else { $_fp_error=FP_UPDATE_ERROR; }; } } if ($k98ea6=='ajaxresult') return $v1fa03; else return array ((int)$v21158,$result,$q9d090); } function e2m_most_commented(){ global$settings,$_strings,$_config; $na0acf=@$_GET['period']; if ($na0acf=='')$na0acf=$_config['hot_period']; $z632a2=time()-v35c3($na0acf); $kf79b1="AND `IsVisible`=1 "; if (he852())$kf79b1=''; return md864(array ( 'query' => "SELECT `IsVisible`, `Stamp`, `NoteID` ID, count(*) c ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE (`Stamp` > ". $z632a2.") ". $kf79b1. "GROUP BY `NoteID` ". "ORDER BY c ". "DESC ". "LIMIT ".$settings['appearance']['notes_per_page'], 'query-returns-only-ids' => 1, 'limit' => $settings['appearance']['notes_per_page'], 'class' => 'most-commented', 'title' => e2l_get_string('pt--most-commented', array ('period' => $na0acf)), 'heading' => e2l_get_string('pt--most-commented', array ('period' => $na0acf)), 'nothing' => $_strings['gs--no-such-notes'], )); } function e2m_favourites($parameters=array ()) { global$_config,$_strings; $kf79b1="AND `IsVisible`=1 "; if (he852())$kf79b1=''; return md864(array ( 'query' => "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND `IsFavourite`=1 ". $kf79b1 . "ORDER BY `Stamp` DESC", 'page' => $parameters['page'], 'candy' => 'e2m_favourites', 'parameters' => $parameters, 'class' => 'favourites', 'title' => $_strings['pt--favourites'], 'heading' => $_strings['pt--favourites'], 'nothing' => $_strings['gs--no-favourites'], )); } function v35c3($na0acf){ if ('year'==$na0acf) return SECONDS_IN_A_YEAR; elseif ('month'==$na0acf) return SECONDS_IN_A_MONTH; elseif ('week'==$na0acf) return SECONDS_IN_A_DAY*7; elseif ('day'==$na0acf) return SECONDS_IN_A_DAY; else return PHP_INT_MAX; } function h8696($n8d777){ global$_current_url; if(__LOG)__log('Arbitrary list ('. $n8d777['_log'] .') {'); $qe919a=u7f78(); $kf4ac8=null; if ($n8d777['cache'] and is_file($n8d777['cache-filename'])) { $kf4ac8=@unserialize(file_get_contents($n8d777['cache-filename'])); } $gf957e=true; if ($n8d777['cache-filename-expires']) { if ($n8d777['cache'] and is_file($n8d777['cache-filename-expires'])) { $b07cc6=time(); $d09bcb=(int) @file_get_contents($n8d777['cache-filename-expires']); if(__LOG)__log('List expires '. date('r',$d09bcb) .', now '. date('r',$b07cc6)); $gf957e=($b07cc6 < $d09bcb); } } $vdbb0c=array(); if ($n8d777['cache'] and is_array($kf4ac8) and $gf957e){ if(__LOG)__log('Retrieve cached ctree'); $vdbb0c=$kf4ac8; } else { if(__LOG)__log('Assemle cacheable ctree...'); $m4358b=array(); if (l0738($n8d777['query'])) { $result=i0d6b(); foreach($result as $d8ce4b => $e39a37){ $e39a37=c4627($e39a37['ID']); if ($e39a37['IsVisible'] and $e39a37['IsPublished']) { $waad65['_']['_id']=$e39a37['ID']; $waad65['_']['_ord']=$d8ce4b; $waad65['_']['_ord_max']=count($result)-1; $waad65['href']=e83c8('e2m_note', array ('*note' => $e39a37)); $waad65['time'] = array ($e39a37['Stamp'],h0923($e39a37)); $waad65['title']=m6f10(htmlspecialchars(zea9c($e39a37),ENT_NOQUOTES,HSC_ENC)); $vdbb0c[] = $waad65; } } $kf4ac8=$vdbb0c; if ($n8d777['cache']) { @d6e52($n8d777['cache-filename'],serialize($kf4ac8)); if ($n8d777['cache-filename-expires']) { @d6e52($n8d777['cache-filename-expires'],time()+$n8d777['expires-after']); } } } } foreach ($vdbb0c as $d8ce4b => $w9e366){ $vdbb0c[$d8ce4b]['current?'] = ($vdbb0c[$d8ce4b]['href']==$_current_url); } if(__LOG)__log('} // Arbitrary list @ '. round(u7f78()-$qe919a,3)); return $vdbb0c; } function v09d1(){ global$_config; $z632a2=time()-v35c3($_config['hot_period']); return h8696(array ( '_log' => 'most_commented', 'cache' => CACHE_HOT, 'cache-filename' => CACHE_FILENAME_HOT, 'cache-filename-expires' => CACHE_FILENAME_HOT_EXPIRES, 'expires-after' => SECONDS_IN_A_DAY, 'query' => ( "SELECT `Stamp`, `NoteID` ID, count(*) c ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `Stamp` > ". $z632a2 ." AND IsVisible='1'". "GROUP BY `NoteID` ". "ORDER BY c DESC LIMIT 10" ), )); } function v0256(){ global$_config; $z632a2=time()-v35c3($_config['popular_period']); return h8696(array ( '_log' => 'most_read', 'cache' => CACHE_POPULAR, 'cache-filename' => CACHE_FILENAME_POPULAR, 'cache-filename-expires' => CACHE_FILENAME_POPULAR_EXPIRES, 'expires-after' => SECONDS_IN_A_DAY, 'query' => ( "SELECT n.`ID`, n.`Title`, n.`IsFavourite`, a.`EntityID`, SUM(a.`HitCount`) HitCount ". "FROM `". $_config['db_table_prefix']."Actions` a, ". "`". $_config['db_table_prefix']."Notes` n  ". "WHERE a.`Stamp` > ". $z632a2 ." ". "AND a.`EntityID` = n.`ID` ". "GROUP BY a.`EntityID` ". "ORDER BY `IsFavourite` DESC, HitCount DESC ". "LIMIT 10" ), )); } function e2m_password(){ global$settings,$_strings; $a2cb9d['title']=$_strings['pt--password']; $a2cb9d['heading']=$_strings['pt--password-for-blog']; $a2cb9d['form']='form-password'; $a2cb9d['form-password'] = array ( 'form-action' => e83c8('e2s_password_save'), 'submit-text' => $_strings['fb--change'], ); return $a2cb9d; } function e2m_sessions(){ global$settings,$_strings; $a2d6d8=o7785(); $a2cb9d['title']=$_strings['pt--sessions']; $a2cb9d['heading']=$_strings['pt--sessions']; $e161bc=array(); $c3c6e0=$_COOKIE[c8c3b('key')]; foreach ($a2d6d8['sessions'] as $d8ce4b => $w9e366){ $e161bc[] = array ( 'current?' => c4c49($c3c6e0)===$w9e366['key_hash'], 'opened' => array ((int)$w9e366['stamp'],j3211()), 'ip-address' => $w9e366['remote_ip'], 'source' => ($w9e366['remote_ip']=='127.0.0.1')? $_strings['gs--locally']:$w9e366['remote_ip'], 'title' => jcc31($w9e366['ua']), 'user-agent' => $w9e366['ua']? $w9e366['ua']:$_strings['gs--unknown'], ); } $e161bc=array_reverse($e161bc); $a2cb9d['sessions']['each']=$e161bc; if(count($e161bc) > 1){ $a2cb9d['form']='form-sessions'; $a2cb9d['form-sessions'] = array ( 'form-action' => e83c8('e2s_drop_other_sessions'), 'submit-text' => $_strings['fb--end-all-sessions-but-this'], ); } return $a2cb9d; } function e2m_sign_in(){ if (he852()) { e2_go_to(e83c8('e2m_frontpage', array ('page' => 1))); } else { return array (); } } function e2m_sign_out(){ global$_strings; $a2d6d8=o7785(); $s48bb9=-1; if(array_key_exists('sessions',$a2d6d8) and is_array($a2d6d8['sessions'])) { foreach ($a2d6d8['sessions'] as $d8ce4b => $w9e366){ $c3c6e0=$_COOKIE[c8c3b('key')]; if (c4c49($c3c6e0)===$w9e366['key_hash']) { $s48bb9=$d8ce4b; break; } } } if ($s48bb9 > -1) unset ($a2d6d8['sessions'][$s48bb9]); if (!g1d21($a2d6d8)) { s8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } uc64a('key',''); e2_go_to(); die; } function e2s_password_save(){ global$settings,$_strings; $n0512f=trim($_POST['old-password']); if (ka8cf($n0512f)) { $p88162=trim($_POST['new-password']); if ($p88162!=''){ if (@d6e52(USER_FOLDER. '/password-hash.psa',serialize(c4c49($p88162)))) { s8a40($_strings['gs--password-changed'],E2E_MESSAGE); e2_go_to(); } else { s8a40($_strings['er--could-not-change-password'],E2E_PERMISSIONS_ERROR); e2_go_to(e83c8('e2m_password')); } } else { s8a40($_strings['er--no-password-entered'],E2E_USER_ERROR); e2_go_to(e83c8('e2m_password')); } } else { s8a40($_strings['er--wrong-password'],E2E_USER_ERROR); e2_go_to(e83c8('e2m_password')); } die; } function e2s_sign_in_necessary(){ e2_go_to(e83c8('e2m_sign_in')); die; } function e2s_sign_in(){ global$_strings; $a2d6d8=o7785(); if($_SERVER['REQUEST_METHOD']=='POST'){ $h5f4dc=@$_POST['password']; $y6bc8e=@$_POST['is_public_pc']; } else { $h5f4dc=@$_GET['password']; $y6bc8e=false; } if (ka8cf($h5f4dc)) { $m21d6f=array ( 'stamp' => time(), 'remote_ip' => $_SERVER['REMOTE_ADDR'], 'key_hash' => be8ed($y6bc8e), 'ua' => $_SERVER['HTTP_USER_AGENT'], ); $a2d6d8['sessions'][] = $m21d6f; } elseif(strlen(trim($h5f4dc)) > 0){ pa711(); s8a40($_strings['er--wrong-password'],E2E_USER_ERROR); } if (!g1d21($a2d6d8)) { s8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); e2_go_to(); die; } d4930(); die; } function e2s_drop_other_sessions(){ global$_strings; $a2d6d8=o7785(); foreach ($a2d6d8['sessions'] as $d8ce4b => $w9e366){ $c3c6e0=$_COOKIE[c8c3b('key')]; if (c4c49($c3c6e0)===$w9e366['key_hash']) { $m21d6f=$w9e366; break; } } $a2d6d8['sessions'] = array ($m21d6f); if (!g1d21($a2d6d8)) { s8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } d4930(); die; } function ka8cf($h5f4dc){ $m8e9a8=@unserialize(file_get_contents(USER_FOLDER. '/password-hash.psa')); return (c4c49($h5f4dc)===$m8e9a8 and trim($h5f4dc)!=''); } function be8ed($k2a2a4=false){ global$settings; $c3c6e0=y2a24(); $w3f363=c4c49($c3c6e0); uc64a('key',$c3c6e0, !$k2a2a4); return $w3f363; } function he852(){ global $a1c0b7,$settings,$_auth_sessions; if (isset ($a1c0b7)) return $a1c0b7; $a1c0b7=false; if (isset ($_COOKIE[c8c3b('key')])) { $c3c6e0=$_COOKIE[c8c3b('key')]; $a2d6d8=o7785(); $y0f83b=array(); if(array_key_exists('sessions',$a2d6d8) and is_array($a2d6d8['sessions'])) { foreach ($a2d6d8['sessions'] as $m21d6f){ $y0f83b[] = $m21d6f['key_hash']; } $_auth_sessions['count']=count($a2d6d8['sessions']); } if(1){ $a1c0b7=(bool)in_array(c4c49($c3c6e0),$y0f83b,true); } if (!$a1c0b7){ uc64a('key',''); } } return $a1c0b7; } function c4c49($p25d90){ if(function_exists('sha1')) { return sha1($p25d90); } else { return substr(md5($p25d90).md5(' '.$p25d90),0,40); } } function o7785(){ if(is_file(USER_FOLDER.'auth.psa')) { $a2d6d8=unserialize(@file_get_contents(USER_FOLDER.'auth.psa')); if ($a2d6d8) return $a2d6d8; } return array (); } function g1d21($a2d6d8){ return d6e52(USER_FOLDER.'auth.psa',serialize($a2d6d8)); } function cc3fb(){ if ($c3c6e0=$_COOKIE[c8c3b('key')]) { return c8c3b('key') .'='. $c3c6e0 .""; } } function jff2e(){ if ($c3c6e0=$_COOKIE[c8c3b('key')]) { return 'Cookie: '. c8c3b('key') .'='. $c3c6e0 ."\r\n"; } return "\r\n"; } function jcc31($f5269f){ global$_strings; if(strstr($f5269f,'iPhone')) return$_strings['gs--ua-iphone']; if(strstr($f5269f,'iPad')) return$_strings['gs--ua-ipad']; if(strstr($f5269f,'Opera'))$a2cb9d=$_strings['gs--ua-opera']; if(strstr($f5269f,'Firefox'))$a2cb9d=$_strings['gs--ua-firefox']; if(strstr($f5269f,'Chrome'))$a2cb9d=$_strings['gs--ua-chrome']; if(strstr($f5269f,'Safari') and !strstr($f5269f,'Chrome'))$a2cb9d=$_strings['gs--ua-safari']; if (!$a2cb9d)$a2cb9d=$_strings['gs--ua-unknown']; if(strstr($f5269f,'Macintosh')) { if ($a2cb9d)$a2cb9d.=' '. $_strings['gs--ua-for-mac']; } return $a2cb9d; } function e2j_check_password(){ $m8e9a8=@unserialize(file_get_contents(USER_FOLDER. '/password-hash.psa')); $h5f4dc=''; if(array_key_exists('password',$_POST))$h5f4dc=$_POST['password']; pa711(); if (c4c49($h5f4dc)===$m8e9a8 and trim($h5f4dc)!=''){ die ('password-correct'); } die ('password-wrong'); } function y2a24(){ $wb04ec=''; $rb8d1b='0123456789abcdef'; for ($y865c0=0; $y865c0 < 40; $y865c0++)$wb04ec.=$rb8d1b[mt_rand(0,15)]; $wb04ec.=time(); $wb04ec=c4c49($wb04ec); return $wb04ec; } function pa711(){ if(is_file(USER_FOLDER. 'password-wait.psa')) { $uaf788=unserialize( file_get_contents(USER_FOLDER. '/password-wait.psa') ); if ($uaf788['delay'] < 5){ $uaf788['delay'] ++; } if(time()-$uaf788['time'] > SECONDS_IN_A_MINUTE){ $uaf788['delay']=0; } $uaf788['time']=time(); } else { $uaf788=array ( 'time' => time(), 'delay' => 5, ); } d6e52(USER_FOLDER.'password-wait.psa',serialize($uaf788)); sleep($uaf788['delay']); } function s7874(){ return md5('seсret'); } function v1305($vb45cf){ $c3c6e0=s7874(); $i16ec1=strlen($c3c6e0); $m2db95=strlen($vb45cf); $a2cb9d=''; for ($y865c0=0; $y865c0 < $m2db95+rand(16,64); ++ $y865c0){ if ($y865c0 > $m2db95){ $j462e1=rand(0,127); } elseif ($y865c0==$m2db95){ $j462e1=0; } else { $j462e1=ord($vb45cf[$y865c0]); } $v18e1b=chr(($j462e1+ord($c3c6e0[$y865c0%$i16ec1])) % 256); $a2cb9d.=$v18e1b; } $a2cb9d=base64_encode($a2cb9d); return $a2cb9d; } function qee85($vb45cf){ $c3c6e0=s7874(); $i16ec1=strlen($c3c6e0); $vb45cf=base64_decode($vb45cf); $m2db95=strlen($vb45cf); $a2cb9d=''; for ($y865c0=0; $y865c0 < $m2db95; ++ $y865c0){ $wd9468=(ord($vb45cf[$y865c0]) + 256-ord($c3c6e0[$y865c0%$i16ec1])) % 256; if ($wd9468===0) break; $a2cb9d.=chr($wd9468); } return $a2cb9d; } $_candies_installer=array ( 'e2s_build', 'e2m_info', 'e2m_install', 'e2j_check_db_config', 'e2j_list_databases', 'e2s_instantiate', 'e2s_install', 'e2s_update_perform', ); $_candies_public=array ( 'e2m_info', 'e2m_frontpage', 'e2m_frontpage_rss', 'e2m_note', 'e2m_note_json', 'e2m_note_comment', 'e2m_note_comments_rss', 'e2m_draft_preview', 'e2m_tags', 'e2m_tag', 'e2m_tag_rss', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_found_rss', 'e2m_comments', 'e2m_everything', 'e2m_year', 'e2m_month', 'e2m_day', 'e2m_unsubscribe', 'e2m_sign_out', 'e2s_sign_in', 'e2s_comment_process', 'e2s_search', 'e2s_bsi_step', 'e2j_check_password', ); $_candies_public=array_merge($_candies_public,$_candies_installer); $_candies_parents=array ( 'e2m_note' => 'e2m_tag', 'e2m_tag' => 'e2m_tags', ); $_candies_indexable=array ( 'e2m_note', ); $_candies_indexable_conditionally=array ( 'e2m_frontpage', 'e2m_tag', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_tags', 'e2m_everything', ); $_candies_ajax=array ( 'e2j_check_db_config', 'e2j_list_databases', 'e2j_check_password', 'e2j_userpic_upload', 'e2j_file_upload', 'e2j_file_remove', 'e2j_note_livesave', 'e2m_note_flag_favourite', 'e2m_comment_flag_ajax', 'e2m_tag_flag_ajax', ); function e2_modes($parameters){ global$content,$_strings; if (!is_array($parameters))$parameters=array(); if(array_key_exists('~',$parameters)) { $g71860=$parameters['~']; } if(e2_is_installed()) { if(__LOG)__log('Popular and tags menu {'); $content['popular'] = array ( 'title' => $_strings['nm--most-read'], ); $content['popular']['each']=v0256(); if(count($content['popular']['each']) < 10) unset($content['popular']['each']); $content['tags']['each']=j5d57(); $content['tags']['many?']=count($content['tags']['each']) > KEYWORDS_MANY_THRESH; $content['tags']['menu-each']=caf16($parameters); if(__LOG)__log('} // Popular and tags menu'); } } function p6f51(){ global$settings,$_strings; if ( array_key_exists('site_title',$settings) and trim($settings['site_title']) != '' ){ return trim($settings['site_title']); } else { return$_strings['e2--default-blog-title']; } } function c2640(){ global$settings,$_strings; if ( array_key_exists('author',$settings) and trim($settings['author']) != '' ){ return trim($settings['author']); } else { return$_strings['e2--default-blog-author']; } } function j2461(){ global$full_blog_url; if(is_file(USER_FOLDER .'userpic@2x.png')) { return$full_blog_url .'/'. USER_FOLDER .'userpic@2x.png'; } elseif(is_file(USER_FOLDER .'userpic@2x.jpg')) { return$full_blog_url .'/'. USER_FOLDER .'userpic@2x.jpg'; } else { return false; } } function e2m_info(){ global$settings,$_config,$r57de2,$aa57c1,$_template; $ff1f71=array ( 'E2_VERSION' => E2_VERSION, 'E2_RELEASE' => E2_RELEASE, 'E2_UA_STRING' => E2_UA_STRING, '---', 'PHP_VERSION' => PHP_VERSION, '---', 'installed' => (bool)e2_is_installed(), 'server_name' => $r57de2, 'folder_on_server' => $aa57c1, '---', 'request_logging' => $_config['request_logging'], 'default formatter' => $_config['default_formatter'], '---', 'theme' => $settings['template'], '---', 'Olba name' => $_template['name'], 'Olba max_image_width' => $_template['max_image_width'], 'Olba stack' => $_template['stack'], '---', 'Neasden' => substr(md5(file_get_contents('system/neasden/neasden.php')), 0,4), '---', ); echo '<pre>'; foreach ($ff1f71 as $d8ce4b => $w9e366){ if ($w9e366=='---'){ echo "\n"; continue; } echo str_pad($d8ce4b,24); echo '\''; print_r($w9e366); echo '\''; echo "\n"; } echo '</pre>'; die; } function e2m_frontpage($parameters=array ()) { global$settings,$_config,$_strings; $g71860=$parameters['page']; $wd7e5d=$settings['appearance']['notes_per_page']; $b06d2e=j8ca0(true,true); if (he852())$b06d2e+=j8ca0(true,false); $pae0fe=ceil($b06d2e/$wd7e5d); $id29bb=CACHE_FILENAME_FRONTPAGE; if (he852())$id29bb=CACHE_FILENAME_FRONTPAGE_AUTHOR; if ($g71860 < 1) return e2_error404_mode(); if(CACHE_FRONTPAGE and $g71860==1 and is_file($id29bb)) { $m4358b=@unserialize(file_get_contents($id29bb)); } if(CACHE_FRONTPAGE and $g71860==1 and is_array($m4358b)) { } else { if (($result=c50d7('web',$g71860)) === false){ s8a40($_strings['er--cannot-show-latest-notes'],E2E_DATABASE_ERROR); return array ( 'title' => htmlspecialchars(p6f51(),ENT_NOQUOTES,HSC_ENC), ); } $m4358b=array(); if(count($result) > 0){ foreach($result as $d8ce4b => $waad65){ $waad65['_']['_id']=$waad65['ID']; $waad65['_']['_title']=zea9c($waad65); $waad65['_']['_ord']=$d8ce4b; $waad65['_']['_ord_max']=count($result)-1; $qe244c=m6791($waad65); $m4358b[] = $qe244c; } } else { if ($g71860!=1) return e2_error404_mode(); } if(CACHE_FRONTPAGE and $g71860==1)d6e52($id29bb,serialize($m4358b)); } $db3b32['timeline?']=true; $db3b32['count']=$pae0fe; $db3b32['this'] = (int)$g71860; if ($pae0fe > 1){ if ($g71860 < $pae0fe)$db3b32['earlier-href']=e83c8('e2m_frontpage', array ('page' => $g71860+1)); if ($g71860 > 1)$db3b32['later-href']=e83c8('e2m_frontpage', array ('page' => $g71860-1)); $db3b32['earlier-title']=$_strings['gs--earlier']; $db3b32['later-title']=$_strings['gs--later']; } $od5d3d=p6f51(); return array ( 'frontpage?' => (bool) ($g71860==1), 'title' => $od5d3d, 'notes' => $m4358b, 'pages' => $db3b32, ); } function e2m_frontpage_rss($parameters=array ()) { global$settings; $id29bb=CACHE_FILENAME_FRONTPAGE_RSS; if(CACHE_FRONTPAGE_RSS and is_file($id29bb)) { if(__LOG)__log('RSS: cached'); $ged0d3=@unserialize(file_get_contents($id29bb)); $tf0e70=filemtime($id29bb); } else { if(__LOG)__log('RSS: not cached, will need to build'); $ged0d3=''; $tf0e70=0; if (($result=c50d7('rss')) !== false){ foreach($result as $waad65){ if ($waad65['IsVisible'] and $waad65['IsPublished']) { $ged0d3.=l307d($waad65); $tf0e70=max($tf0e70,$waad65['Stamp']); } } } if(CACHE_FRONTPAGE_RSS)d6e52($id29bb,serialize($ged0d3)); } $ged0d3=str_replace("\x0",'',$ged0d3); h7be5( $ged0d3, $tf0e70, $settings['site_title'], e83c8('e2m_frontpage', array ('page' => 1)) ); die; } function e2m_note_comments_rss($parameters=array ()) { global$settings,$_config,$_strings; $waad65=e2_published_noterec_with_parameters_($parameters); $tf0e70=0; $n93759=''; if ( ($result=l1baf($waad65['ID'],"AND `Stamp` > ". (time()-SECONDS_IN_A_MONTH) ." ORDER BY `Stamp` DESC LIMIT ". $_config['rss_items'])) !== false ){ foreach($result as $g06d4c){ if ($g06d4c['IsVisible'] and !$g06d4c['IsSpamSuspect']) { $n93759.=ec6e2($waad65,$g06d4c); $tf0e70=max($tf0e70,$g06d4c['Stamp']); } } } h7be5( $n93759, $tf0e70, $settings['site_title'] .', '. $_strings['gs--comments-on-post'] .': '. $waad65['Title'], e83c8('e2m_note', array ('*note' => $waad65)) ); die; } function e2m_tag_rss($parameters=array ()) { global$settings,$_config,$_strings; if(array_key_exists('*tag',$parameters)) { $de4d23=$parameters['*tag']; } else { return e2_error404_mode(); } $k56790[] = ( "`". $_config['db_table_prefix'] . "NotesKeywords`.KeywordID=". $de4d23['ID'] ); $k56790=implode(' OR ',$k56790); $ac2b7b=$_config['db_table_prefix']; return bcbfb( "INNER JOIN `". $ac2b7b."NotesKeywords` ". "ON `". $ac2b7b."NotesKeywords`.NoteID=`". $ac2b7b."Notes`.ID ". "WHERE (". $k56790 .") ". "ORDER BY `". $ac2b7b ."Notes`.`Stamp` DESC LIMIT ". $_config['rss_items'], $settings['site_title'] .', '. $_strings['gs--posts-tagged'] .': '. $de4d23['Keyword'], e83c8('e2m_tag',$parameters) ); } function e2m_found_rss($parameters=array ()) { global$_config,$settings,$_strings; $parameters['query']=trim($parameters['query']); $y1b1cc=$parameters['query']; return bcbfb( "WHERE MATCH (`Title`, `Text`) AGAINST ('". e7928(preg_quote($y1b1cc)). "') ORDER BY `Stamp` DESC LIMIT ". $_config['rss_items'], $settings['site_title'] .', '. $_strings['gs--search-results'] .': '. $y1b1cc, e83c8('e2m_found',$parameters) ); } function bcbfb($i15c46,$od5d3d,$k2a304){ global$settings,$_config; $l8bb85=''; $tf0e70=0; if ((l0738( "SELECT `". $_config['db_table_prefix']."Notes`.* ". "FROM `". $_config['db_table_prefix']."Notes` ". $i15c46 )) !== false){ $result=i0d6b(); foreach($result as $waad65){ if ($waad65['IsVisible'] and $waad65['IsPublished']) { $l8bb85.=l307d($waad65); $tf0e70=max($tf0e70,$waad65['Stamp']); } } } h7be5( $l8bb85, $tf0e70, $od5d3d, $k2a304 ); die; } function d3010($od5d3d,$ee8fab){ global$_newsfeeds; $p336a4=array ('title' => $od5d3d,'href' => $ee8fab); $_newsfeeds[] = $p336a4; } function l307d($waad65){ global$settings,$r57de2; $i90141=e83c8('e2m_note', array ('*note' => $waad65)); $l8bb85=''; $l8bb85.='<item>'; $l8bb85.='<title>'. (m6f10(htmlspecialchars(zea9c($waad65),ENT_NOQUOTES,HSC_ENC))) .'</title>'; $l8bb85.='<guid isPermaLink="true">'. $i90141 .'</guid>'; $l8bb85.='<link>'. $i90141 .'</link>'; $l8bb85.='<comments>'. $i90141 .'</comments>'; $f67daf=z154e($waad65['FormatterID'], @$waad65['Text'],'full-rss'); $f67daf=$f67daf['text-final']; for ($y865c0=0; $y865c0 < strlen($f67daf); ++$y865c0){ if(ord($f67daf[$y865c0]) < 32 and !in_array(ord($f67daf[$y865c0]), array (10,13))) { $f67daf[$y865c0]=''; } } $l8bb85.='<description>'; $l8bb85.=htmlspecialchars($f67daf,ENT_NOQUOTES,HSC_ENC); $l8bb85.='</description>'; $g588e0 = ma846('D, d M Y H:i:s ',$waad65['Stamp']) . ad536($waad65['Stamp']); $l8bb85.='<pubDate>'. $g588e0 .'</pubDate>'; $l8bb85.='</item>'; return $l8bb85; } function ec6e2($waad65,$g06d4c){ global$settings,$r57de2,$_strings; $i90141=e83c8('e2m_note', array ('*note' => $waad65)); $w0ad4f = '<b>'. htmlspecialchars($g06d4c['AuthorName'],ENT_NOQUOTES,HSC_ENC) .'</b>, '. $_strings['gs--comment-on-post'] .' <a href="'. $i90141 .'">"'. m6f10(htmlspecialchars(zea9c($waad65),ENT_NOQUOTES,HSC_ENC)) .'"</a>'; $l8bb85=''; $l8bb85.='<item>'; $l8bb85.='<title>'. strip_tags($w0ad4f) .'</title>'; $l8bb85.='<link>'. $i90141 .'</link>'; $f67daf=$w0ad4f.':'; $f67daf.='<br /><br />'; $u64be6=z154e($waad65['FormatterID'],$g06d4c['Text'],'simple-rss'); $u64be6=$u64be6['text-final']; $f67daf.=$u64be6; for ($y865c0=0; $y865c0 < strlen($f67daf); ++$y865c0){ if(ord($f67daf[$y865c0]) < 32 and !in_array(ord($f67daf[$y865c0]), array (10,13))) { $f67daf[$y865c0]=''; } } $l8bb85.='<description>'; $l8bb85.=htmlspecialchars($f67daf,ENT_NOQUOTES,HSC_ENC); $l8bb85.='</description>'; $g588e0 = ma846('D, d M Y H:i:s ',$g06d4c['Stamp']) . ad536($g06d4c['Stamp']); $l8bb85.='<pubDate>'. $g588e0 .'</pubDate>'; $l8bb85.='</item>'; return $l8bb85; } function h7be5($k691d5,$tf0e70,$od5d3d,$k2a304){ global$settings; $content=array ( 'title' => htmlspecialchars($od5d3d,ENT_NOQUOTES,HSC_ENC), 'link' => $k2a304, 'generator' => E2_UA_STRING, 'items' => $k691d5, ); if(array_key_exists('description',$settings)) { $l2bfe4=tb7f1($settings['description'],'full'); $f67daf=$l2bfe4['text-final']; $content['description']=htmlspecialchars($f67daf,ENT_NOQUOTES,HSC_ENC); } $u54870=gmdate('r',$tf0e70); $a1872a=md5($tf0e70); header('Content-type: application/xml; charset=utf-8'); header('Last-modified: '.$u54870); header('Etag: '.$a1872a); header('Cache-Control: public'); header('Expires: '. date('r',$tf0e70+SECONDS_IN_A_DAY)); $e0c3cd=isset($_SERVER['HTTP_IF_MODIFIED_SINCE'])? stripslashes($_SERVER['HTTP_IF_MODIFIED_SINCE']): false; $zc3522=isset($_SERVER['HTTP_IF_NONE_MATCH'])? stripslashes($_SERVER['HTTP_IF_NONE_MATCH']): false; if ( !$e0c3cd && !$zc3522 or $zc3522 && $zc3522!=$a1872a or $e0c3cd && $e0c3cd!=$u54870 ){ $x92eac=DEFAULTS_FOLDER.'rss/rss.tmpl.php'; if(is_file($x92eac)) { ob_start(); include $x92eac; $l8bb85=ob_get_contents(); ob_end_clean(); } echo $l8bb85; } else { header('HTTP/1.1 304 Not Modified'); } } function e2m_year($parameters=array ()) { global$_strings,$_config; $z84cdc=$parameters['year']; $o09d6c=e2l_get_string('pt--nth-year', array ('year' => $z84cdc)); if (!w1665($z84cdc)) { return e2_error404_mode(); } $ce6e7d=gmmktime(0,0,0,1,1,$z84cdc-1); $b029bd=gmmktime(0,0,0,1,1,$z84cdc+1); list ($s8aebd,$f5a7f3)=e2__fruitful_neighbours_with_ymd_($z84cdc); $sa6d40='e2m_year'; if ($s8aebd){ $db3b32['prev-href']=e83c8( $sa6d40,e2__parameters_with_timestamp_($s8aebd) ); $db3b32['prev-jump?'] = (bool) (gmdate('Y',$ce6e7d)!=gmdate('Y',$s8aebd)); $db3b32['prev-title']=gmdate('Y',$s8aebd); } if ($f5a7f3){ $db3b32['next-href']=e83c8( $sa6d40,e2__parameters_with_timestamp_($f5a7f3) ); $db3b32['next-jump?'] = (bool) (gmdate('Y',$b029bd)!=gmdate('Y',$f5a7f3)); $db3b32['next-title']=gmdate('Y',$f5a7f3); } $db3b32['timeline?']=false; $db3b32['this']=$z84cdc; $db3b32['this-title']=$z84cdc; $eb2442=occ02('start'); $v8dbc7=occ02('end'); if ( $z84cdc==g5a2f('Y',$eb2442['stamp'],$eb2442['timezone']) ) { $hfa098=g5a2f('m',$eb2442['stamp'],$eb2442['timezone']); } else { $hfa098=1; } if ( $z84cdc==ma846('Y',time()) ) { $lfd384=ma846('m',time()); } else { $lfd384=12; } $e6eac3=db92c($z84cdc); for ($x7436f=1; $x7436f <= 12; ++ $x7436f){ $j7f769=gmmktime(0,0,0,$x7436f,1,$z84cdc); $sd039b[$x7436f] = array ( 'number' => $x7436f, 'start-time' => array ($j7f769,j3211()), 'href' => gmdate('Y/m/',$j7f769), 'real?' => $x7436f >= $hfa098 and $x7436f <= $lfd384, 'fruitful?' => @in_array(gmdate('n',$j7f769),$e6eac3), ); } list ($x7b314,$ca1f20)=n5273($z84cdc); l0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND `IsVisible` = 1 ". "AND `Stamp` BETWEEN ". $x7b314 ." ". "AND ". $ca1f20 ." ". "ORDER BY `Stamp`" ); $result=i0d6b(); $m4358b=h28df($result,$z84cdc); $a2cb9d=array ( 'title' => $o09d6c, 'heading' => $o09d6c, 'pages' => $db3b32, 'year' => (int)$z84cdc, 'year-months' => $sd039b, ); if(count($m4358b)) { $a2cb9d['notes-list']=$m4358b; } else { $a2cb9d['nothing']=$_strings['gs--no-such-notes']; } return $a2cb9d; } function e2m_month($parameters=array ()) { global$_strings,$_config; $z84cdc= $parameters['year']; $x7436f=$parameters['month']; $o09d6c=e2l_get_string( 'pt--nth-month-of-nth-year', array ('year' => $z84cdc,'month' => $x7436f) ); if (!w1665($z84cdc,$x7436f)) { return e2_error404_mode(); } $ce6e7d=gmmktime(0,0,0,$x7436f-1,1,$z84cdc); $b029bd=gmmktime(0,0,0,$x7436f+1,1,$z84cdc); list ($s8aebd,$f5a7f3)=e2__fruitful_neighbours_with_ymd_($z84cdc,$x7436f); $sa6d40='e2m_month'; if ($s8aebd){ $db3b32['prev-href']=e83c8( $sa6d40,e2__parameters_with_timestamp_($s8aebd) ); $db3b32['prev-jump?'] = (bool) (gmdate('Y/m',$ce6e7d)!=gmdate('Y/m',$s8aebd)); $db3b32['prev-title']=e2l_get_string( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate('Y',$s8aebd),'month' => gmdate('n',$s8aebd) ) ); } if ($f5a7f3){ $db3b32['next-href']=e83c8( $sa6d40,e2__parameters_with_timestamp_($f5a7f3) ); $db3b32['next-jump?'] = (bool) (gmdate('Y/m',$b029bd)!=gmdate('Y/m',$f5a7f3)); $db3b32['next-title']=e2l_get_string( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate('Y',$f5a7f3),'month' => gmdate('n',$f5a7f3) ) ); } $db3b32['timeline?']=false; $db3b32['this-title']=$o09d6c; list ($x7b314,$ca1f20)=n5273($z84cdc,$x7436f); l0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND `IsVisible` = 1 ". "AND `Stamp` BETWEEN ". $x7b314 ." ". "AND ". $ca1f20 ." ". "ORDER BY `Stamp`" ); $result=i0d6b(); $m4358b=h28df($result,$z84cdc,$x7436f); $ge70c4['title']=$o09d6c; $ge70c4['heading']=$o09d6c; $ge70c4['pages']=$db3b32; $ge70c4['year'] = (int)$z84cdc; $ge70c4['month'] = (int)$x7436f; $ge70c4['month-days']=e2_pack_month_days_with_ymd_($z84cdc,$x7436f,false); if(count($m4358b)) { $ge70c4['notes-list']=$m4358b; } else { $ge70c4['nothing']=$_strings['gs--no-such-notes']; } return $ge70c4; } function e2m_day($parameters=array ()) { global$_strings; $z84cdc= (int)$parameters['year']; $x7436f=(int)$parameters['month']; $u628b7= (int)$parameters['day']; if (!(w1665($z84cdc,$x7436f,$u628b7))) { return e2_error404_mode(); } $o09d6c=e2l_get_string( 'pt--nth-day-of-nth-month-of-nth-year', array ('year' => $z84cdc,'month' => $x7436f,'day' => $u628b7) ); $ce6e7d=gmmktime(0,0,0,$x7436f,$u628b7-1,$z84cdc); $b029bd=gmmktime(0,0,0,$x7436f,$u628b7+1,$z84cdc); list ($s8aebd,$f5a7f3)=e2__fruitful_neighbours_with_ymd_($z84cdc,$x7436f,$u628b7); $sa6d40='e2m_day'; if ($s8aebd){ $db3b32['prev-href']=e83c8( $sa6d40,e2__parameters_with_timestamp_($s8aebd) ); $db3b32['prev-jump?'] = (bool) (gmdate('Y/m/d',$ce6e7d)!=gmdate('Y/m/d',$s8aebd)); $db3b32['prev-title']=e2l_get_string( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate('Y',$s8aebd),'month' => gmdate('n',$s8aebd),'day' => gmdate('j',$s8aebd), ) ); } if ($f5a7f3){ $db3b32['next-href']=e83c8( $sa6d40,e2__parameters_with_timestamp_($f5a7f3) ); $db3b32['next-jump?'] = (bool) (gmdate('Y/m/d',$b029bd)!=gmdate('Y/m/d',$f5a7f3)); $db3b32['next-title']=e2l_get_string( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate('Y',$f5a7f3),'month' => gmdate('n',$f5a7f3),'day' => gmdate('j',$f5a7f3), ) ); } $db3b32['timeline?']=false; $db3b32['this-title']=$o09d6c; if (($result=zf9fb($z84cdc,$x7436f,$u628b7)) !== false){ $result=array_reverse($result); foreach($result as $d8ce4b => $waad65){ if ($waad65['IsVisible'] or he852()) { $waad65['_']['_id']=$waad65['ID']; $waad65['_']['_ord']=k; $waad65['_']['_ord_max']=count($result)-1; $m4358b[] = m6791($waad65); } } } $ge70c4['title']=$o09d6c; $ge70c4['heading']=$o09d6c; $ge70c4['pages']=$db3b32; $ge70c4['month-days']=e2_pack_month_days_with_ymd_($z84cdc,$x7436f,$u628b7); if(count($m4358b)) { $ge70c4['notes']=$m4358b; } else { $ge70c4['nothing']=$_strings['gs--no-such-notes']; } return $ge70c4; } function e2m_everything($parameters=array ()) { global$_strings,$_config; $m4358b=null; if(CACHE_FULLLIST and is_file(CACHE_FILENAME_FULLLIST)) { $m4358b=@unserialize(file_get_contents(CACHE_FILENAME_FULLLIST)); if(__LOG)__log('Everything: retrieving from cache...'); } if (!is_array($m4358b)) { if(__LOG)__log('Everything: retrieving from database...'); l0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND `IsVisible` = 1 ". "ORDER BY `Stamp`" ); $result=i0d6b(); if(__LOG)__log('Everything: preparing notes list...'); $m4358b=h28df($result); if(__LOG)__log('Everything: saving cache...'); if(CACHE_FULLLIST)d6e52(CACHE_FILENAME_FULLLIST,serialize($m4358b)); } $y1f525=count($m4358b); $o09d6c=e2l_get_string('pt--n-posts', array ('number' => $y1f525)); if(array_key_exists('part',$_GET) and array_key_exists('of',$_GET)) { if(__LOG)__log('Everything: splitting into parts...'); $zf4c93=$_GET['part']; $f8bf88=$_GET['of']; $o09d6c.=' ('. e2l_get_string('gs--part-x-of-y', array ('part' => $zf4c93,'of' => $f8bf88)) .')'; $j895e3=$y1f525/$f8bf88; $md98a0=($zf4c93-1)*$j895e3; $e01b6e=$zf4c93*$j895e3; $m4358b=array_slice($m4358b,round($md98a0),round($e01b6e-round($md98a0))); } if(__LOG)__log('Everything: done, returning'); $ge70c4['class']='everything'; $ge70c4['title']=$o09d6c; $ge70c4['heading']=$o09d6c; if(count($m4358b)) { $ge70c4['notes-list']=$m4358b; } else { $ge70c4['nothing']=$_strings['gs--no-notes']; } return $ge70c4; } function e2_pack_month_days_with_ymd_($z84cdc,$x7436f,$u628b7){ $ha6933=g5a2f('t',gmmktime(0,0,0,$x7436f,1,$z84cdc),j3211()); $eb2442=occ02('start'); $v8dbc7=occ02('end'); if ( $z84cdc .'/'. $x7436f == g5a2f('Y/n',$eb2442['stamp'],$eb2442['timezone']) ) { $d42eb4=g5a2f('d',$eb2442['stamp'],$eb2442['timezone']); } else { $d42eb4=1; } if ( $z84cdc .'/'. $x7436f == ma846('Y/n',time()) ) { $rd5f50=ma846('d',time()); } else { $rd5f50=$ha6933; } $ce4602=r82dc($z84cdc,$x7436f); for ($y865c0=1; $y865c0 <= $ha6933; ++ $y865c0){ $j7f769=gmmktime(0,0,0,$x7436f,$y865c0,$z84cdc); $q271c1[$y865c0] = array ( 'number' => $y865c0, 'start-time' => array ($j7f769,j3211()), 'href' => gmdate('Y/m/d/',$j7f769), 'this?' => (bool) ($y865c0==$u628b7), 'real?' => $y865c0 >= $d42eb4 and $y865c0 <= $rd5f50, 'fruitful?' => @in_array(gmdate('d',$j7f769),$ce4602), ); } return $q271c1; } function w1665($z84cdc,$x7436f=false,$u628b7=false){ $eb2442=occ02('start'); if ($eb2442===false){ return false; } $mc1f1e=g5a2f('Y',$eb2442['stamp'],$eb2442['timezone']); $xebeb3=ma846('Y',time()); if ($x7436f===false){ return (bool) ( $z84cdc >= $mc1f1e and $z84cdc <= $xebeb3 ); } else { $y782fc=g5a2f('n',$eb2442['stamp'],$eb2442['timezone']); $r13dd1=ma846('n',time()); if ($u628b7===false){ return (bool) ( $x7436f >= 1 and $x7436f <= 12 and ( ($z84cdc > $mc1f1e and $z84cdc < $xebeb3) or ($z84cdc==$mc1f1e and $x7436f >= $y782fc) or ($z84cdc==$xebeb3 and $x7436f <= $r13dd1) ) ); } else { $y7a9c0=g5a2f('j',$eb2442['stamp'],$eb2442['timezone']); $t23209=ma846('j',time()); if(1){ return (bool) ( checkdate($x7436f,$u628b7,$z84cdc) and ( ($z84cdc > $mc1f1e and $z84cdc < $xebeb3) or ($z84cdc==$mc1f1e and $x7436f > $y782fc) or ($z84cdc==$mc1f1e and $x7436f==$y782fc and $u628b7 >= $y7a9c0) or ($z84cdc==$xebeb3 and $x7436f < $r13dd1) or ($z84cdc==$xebeb3 and $x7436f==$r13dd1 and $u628b7 <= $t23209) ) ); } } } } function e2__fruitful_neighbours_with_ymd_($z41529,$h6f8f5=false,$c8277e=false){ global$_db,$_config; list ($a3d2fa,$e9468c)=n5273($z41529,$h6f8f5,$c8277e); $wada4b=SECONDS_IN_A_DAY; if ($c8277e===false)$wada4b=SECONDS_IN_A_MONTH; if ($h6f8f5===false)$wada4b=SECONDS_IN_A_YEAR; if (!he852())$kf79b1="`IsVisible`=1 AND "; if (v0f7c()) { $_db['result']=mysqli_query( $_db['link'], "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` ". "WHERE `IsPublished`=1 AND " .@$kf79b1. "Stamp < '". ($e9468c-$wada4b) ."' ". "ORDER BY Stamp DESC" ); while ($x6438c=@mysqli_fetch_array($_db['result'],MYSQLI_ASSOC)) { list ($z84cdc,$x7436f,$u628b7)=explode('/', g5a2f('Y/n/j',$x6438c['Stamp'],h0923($x6438c)) ); $p7474d=$z41529*10000 + ($h6f8f5? ($h6f8f5*100):0) + ($c8277e? $c8277e:0); $kbd8da=$z84cdc*10000 + ($h6f8f5? ($x7436f*100):0) + ($c8277e? $u628b7:0); if ($kbd8da < $p7474d){ $ybf025=gmmktime(0,0,0,$x7436f,$u628b7,$z84cdc); break; } } $_db['result']=mysqli_query( $_db['link'], "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` ". "WHERE `IsPublished`=1 AND " .@$kf79b1. "Stamp > '". ($a3d2fa+$wada4b) ."' ". "ORDER BY Stamp" ); while ($x6438c=@mysqli_fetch_array($_db['result'],MYSQLI_ASSOC)) { list ($z84cdc,$x7436f,$u628b7)=explode('/', g5a2f('Y/n/j',$x6438c['Stamp'],h0923($x6438c)) ); $p7474d=$z41529*10000 + ($h6f8f5? ($h6f8f5*100):0) + ($c8277e? $c8277e:0); $kbd8da=$z84cdc*10000 + ($h6f8f5? ($x7436f*100):0) + ($c8277e? $u628b7:0); if ($kbd8da > $p7474d){ $f8dc98=gmmktime(0,0,0,$x7436f,$u628b7,$z84cdc); break; } } return array ($ybf025,$f8dc98); } } function e2__parameters_with_timestamp_($o96b8c){ list ( $parameters['year'], $parameters['month'], $parameters['day'] ) = explode('/',gmdate('Y/m/d',$o96b8c)); return$parameters; } function h28df($gc2d18,$z84cdc=false,$x7436f=false){ $v229c3=0; $m4358b=array(); $gf09d8=''; $m4358b=array(); $acc73f=array(); foreach ($gc2d18 as $d8ce4b => $e39a37){ $waad65['href'] = e83c8('e2m_note', array ('*note' => $e39a37)); $waad65['time'] = array ((int)min($waad65['Stamp'],time()), h0923($waad65)); $waad65['last-modified'] = array ((int)min($waad65['LastModified'],time()), h0923($waad65)); $waad65['favourite?'] = (bool) ($e39a37['IsFavourite'] && $e39a37['IsPublished']); if ( ($z84cdc and $x7436f and ( ((int)$z84cdc) .'/'. ((int)$x7436f) == g5a2f('Y/n',$e39a37['Stamp'],h0923($e39a37)) )) or ($z84cdc and !$x7436f and ( (int)$z84cdc == g5a2f('Y',$e39a37['Stamp'],h0923($e39a37)) )) or (!$z84cdc and !$x7436f) ) { array_unshift($m4358b,$waad65); array_unshift($acc73f,str_replace("\n",' ',zea9c($e39a37))); } } $b789f1=implode("\n",$acc73f); if(strlen($b789f1) < 20000){ $b789f1=m6f10(htmlspecialchars($b789f1,ENT_NOQUOTES,HSC_ENC)); $acc73f=explode("\n",$b789f1); } foreach ($m4358b as $d8ce4b => $w9e366){ $m4358b[$d8ce4b]['title']=$acc73f[$d8ce4b]; } return $m4358b; } function e2s_sync(){ e2_drop_all_kinds_of_cache(); die ('All caches clean.'); } function e2_note_cache_filename_with_id_($cb80bb){ return str_replace('*',$cb80bb,CACHE_FILENAMES_NOTES); } function e2_drop_caches_for_note_($v21158){ if(__LOG)__log('Caches: Drop caches for note id '. $v21158); ze2f1(); j22e7(); @unlink(e2_note_cache_filename_with_id_($v21158)); @unlink(e2_note_cache_filename_with_id_($v21158 .'-comments')); @unlink(e2_note_cache_filename_with_id_($v21158 .'-comments-author')); @unlink(CACHE_FILENAME_HOT); @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); @unlink(CACHE_FILENAME_FRONTPAGE_RSS); @unlink(CACHE_FILENAME_FULLLIST); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); @unlink(CACHE_FILENAME_LASTMODIFIEDS); } function i7996(){ if(__LOG)__log('Caches: Drop notes caches'); bc5a6(CACHE_FILENAMES_NOTES); bc5a6(CACHE_FILENAMES_NOTES_COMMENTS); @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); @unlink(CACHE_FILENAME_FRONTPAGE_RSS); @unlink(CACHE_FILENAME_LASTMODIFIEDS); } function ze2f1(){ if(__LOG)__log('Caches: Drop notes counts cache'); bc5a6(CACHE_FILENAMES_NOTES_COUNTS); } function j22e7(){ if(__LOG)__log('Caches: Drop egde time info cache'); bc5a6(CACHE_FILENAMES_EDGE_TIMEINFO); } function e2_drop_all_kinds_of_cache(){ if(__LOG)__log('Caches: Drop all kinds of caches'); bc5a6(CACHES_FOLDER.'*'); return true; } function w4e27($f139c8){ global$_template,$_config; if(__LOG)__log('Olba: Prepare template <'. $f139c8 .'>'); $kaf10b=array(); $r8598c=$f139c8; $t620f7=TEMPLATES_FOLDER.$r8598c .'/'; $l1b14d=false; if ( $f139c8!='' and !array_key_exists('themeless',$_GET) ){ if ( is_dir($t620f7) and is_file($t620f7 .'/theme-info.php') ) { while (1){ $t620f7=TEMPLATES_FOLDER.$r8598c .'/'; array_push($kaf10b,$t620f7); $m38226=include $t620f7 .'/theme-info.php'; $k4e502[$t620f7]=$m38226; if(array_key_exists('max_image_width',$m38226)) { if ($l1b14d===false){ $l1b14d=$m38226['max_image_width']; } } if(array_key_exists('based_on',$m38226)) { $r8598c=$m38226['based_on']; } else { break; } } } else { } } $t620f7=SYSTEM_TEMPLATE_FOLDER; array_push($kaf10b,$t620f7); $m38226=include $t620f7 .'/theme-info.php'; $k4e502[$t620f7]=$m38226; if(array_key_exists('max_image_width',$m38226)) { if ($l1b14d===false){ $l1b14d=$m38226['max_image_width']; } } if ($l1b14d===false){ $l1b14d=$_config['max_image_width']; } $_template['name']=$f139c8; $_template['max_image_width']=$l1b14d; $_template['stack']=$kaf10b; $_template['infos']=$k4e502; }; function c53ee($td436e){ global$content; ++ $_olba_includes; include $td436e; } function d6a97($n52678){ if(0){ echo '<div style="background: #ff0">'.$n52678.'</div>'; } if(is_dir(EXTRAS_FOLDER)) { $h71cae=EXTRAS_FOLDER.$n52678 .'.tmpl.php'; if(is_file($h71cae)) { c53ee($h71cae); } } return ''; } function z166b($n52678){ global$_template,$_olba_includes; $h71cae='templates/'. $n52678 .'.tmpl.php'; if ($td436e=e2o__usable_file_with_basename_($h71cae)) { if(__LOG)__log('Olba: Apply template <'. $td436e .'>'); c53ee($td436e); } else { f1928($h71cae); } } function qbc21(){ global$_config; if ( @$_config['raw_template_data'] or @$_config['raw_template_data_with_param'] and array_key_exists('raw',$_GET) ) { $a3f7d9='raw'; } else { $a3f7d9='main'; } return z166b($a3f7d9); } function f1928($j8b7af){ mf1da($j8b7af,'_olba_missing_templates'); } function vd4c1($o45ac4){ mf1da($o45ac4 .'.css','_olba_used_stylesheets'); } function wd00a($n3205c){ mf1da($n3205c .'.js','_olba_used_scripts'); } function i16f0($be8acc){ foreach (array (SYSTEM_LIBRARY_FOLDER,USER_LIBRARY_FOLDER) as $v71379){ foreach(glob($v71379.$be8acc .'/*') as $j8c7dd){ $tabf77=pathinfo($j8c7dd,PATHINFO_EXTENSION); if ($tabf77=='js'){ mf1da($j8c7dd,'_olba_used_scripts'); } if ($tabf77=='css'){ mf1da($j8c7dd,'_olba_used_stylesheets'); } } } } function ie655(){ global$_olba_missing_templates; if (isset ($_olba_missing_templates)) { return array_unique($_olba_missing_templates); } } function l94dd(){ global$_template,$_config,$settings; if($_config['list_system_theme']) { $iccf6b['system']=SYSTEM_TEMPLATE_FOLDER; } if ($ze1260=@opendir(TEMPLATES_FOLDER)) { while (false !== ($e1f769=readdir($ze1260))) { if(is_dir(TEMPLATES_FOLDER. $e1f769) and $e1f769!='.' and $e1f769!='..'){ if(is_file(TEMPLATES_FOLDER.$e1f769 .'/theme-info.php')) { $iccf6b[$e1f769]=TEMPLATES_FOLDER.$e1f769 .'/'; } } } closedir($ze1260); } $y10ae9=array(); foreach ($iccf6b as $db0689 => $t85114){ $m38226=include $t85114 .'theme-info.php'; $ic2657=$m38226['display_name']; if(is_file($cbe5fb=$t85114.$j8c7dd .'preview@2x.png')) { } elseif(is_file($cbe5fb=$t85114.$j8c7dd .'preview.png')) { } else { $cbe5fb=DEFAULTS_FOLDER.'preview@2x.png'; } if(is_array($ic2657)) { if(array_key_exists($settings['language'],$ic2657)) { $ic2657=$ic2657[$settings['language']]; } else { $ic2657=array_shift($ic2657); } } $y10ae9[] = array ( 'name' => $db0689, 'display-name' => $ic2657, 'current?' => (bool) ($db0689==$_template['name']), 'preview' => $cbe5fb, ); } return $y10ae9; } function i1492($v435ed){ return e2o__usable_file_with_basename_('images/'. $v435ed); } function gf42c($bb1197){ return file_get_contents(e2o__usable_file_with_basename_('images/'. $bb1197 .'.svg')); } function p576f($o45ac4){ global$_template; $m954eb='styles/'. $o45ac4 .'.css'; $m95aa1=array(); foreach($_template['stack'] as $t620f7){ if(is_file($v435ed=$t620f7.$m954eb)) { $m95aa1[] = $v435ed; } if ( array_key_exists('reset_styles',$_template['infos'][$t620f7]) and in_array($o45ac4,$_template['infos'][$t620f7]['reset_styles']) ) { break; } } $m95aa1=array_reverse($m95aa1); } function m37ca(){ global$_olba_used_stylesheets,$_template; if (!isset ($_olba_used_stylesheets)) return; $_olba_used_stylesheets=array_unique($_olba_used_stylesheets); $oc7f50=array(); foreach($_olba_used_stylesheets as $o45ac4){ if(is_file($o45ac4)) { $oc7f50[] = $o45ac4; continue; } if(is_file($v435ed=USER_FOLDER .'js/'. $o45ac4)) { $oc7f50[] = $v435ed; } $m954eb='styles/'. $o45ac4; $m95aa1=array(); foreach($_template['stack'] as $t620f7){ if(is_file($v435ed=$t620f7.$m954eb)) { $m95aa1[] = $v435ed; } if ( array_key_exists('reset_styles',$_template['infos'][$t620f7]) and in_array($o45ac4,$_template['infos'][$t620f7]['reset_styles']) ) { break; } } $m95aa1=array_reverse($m95aa1); $oc7f50=array_merge($oc7f50,$m95aa1); } foreach ($oc7f50 as $d8ce4b => $w9e366){ $tbc7b3=stat($w9e366); $oc7f50[$d8ce4b].='?'. $tbc7b3['mtime']; } return $oc7f50; } function p4753(){ global$_olba_used_scripts; if (!isset ($_olba_used_scripts)) return; $_olba_used_scripts=array_unique($_olba_used_scripts); $sd6c58=array(); foreach($_olba_used_scripts as $n3205c){ if(is_file($n3205c)) { $sd6c58[] = $n3205c; continue; } if(is_file($e9d679=USER_FOLDER .'js/'. $n3205c)) { $sd6c58[] = $e9d679; } $m954eb='js/'. $n3205c; if ($e9d679=e2o__usable_file_with_basename_($m954eb)) { $sd6c58[] = $e9d679; } } foreach ($sd6c58 as $d8ce4b => $w9e366){ $tbc7b3=stat($w9e366); $sd6c58[$d8ce4b].='?'. $tbc7b3['mtime']; } return $sd6c58; } function mf1da($n2063c,$ff1f71){ if (!isset ($GLOBALS[$ff1f71])) { $GLOBALS[$ff1f71] = array ($n2063c); } else { $GLOBALS[$ff1f71][] = $n2063c; } } function e2o__usable_file_with_basename_($m954eb){ global$_template; foreach($_template['stack'] as $t620f7){ if(is_file($v435ed=$t620f7.$m954eb)) { return $v435ed; } } return ''; } define('SEARCH_EXTRA_PREFIX','Rose'); define('SEARCH_LIMIT',20); define('SEARCH_SNIPPETS_LIMIT',20); define('SEARCH_USE_ROSE',1); define('SEARCH_USE_MYSQL',1); use S2\Rose\Storage\Exception\EmptyIndexException; use S2\Rose\Storage\Database\PdoStorage; use S2\Rose\Stemmer\PorterStemmerRussian; use S2\Rose\Indexer; use S2\Rose\Entity\Indexable; use S2\Rose\Entity\Query; use S2\Rose\Finder; use S2\Rose\SnippetBuilder; function e2m_found($parameters=array ()) { global$_strings,$_config,$settings,$full_blog_url; $parameters['query']=trim($parameters['query']); $y1b1cc=$parameters['query']; if (!$y1b1cc){ return array ( 'title' => $_strings['pt--search-query-empty'], 'heading' => $_strings['pt--search'], 'nothing' => $_strings['gs--search-query-empty'], ); } $kf79b1="AND `IsVisible`=1 "; if (he852())$kf79b1=''; $k11128=false; if (l0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `Keyword`='". e7928($y1b1cc)."'" )) { $rfa816=i0d6b(); if (isset ($rfa816[0]['ID'])) { $k11128=array ( 'href' => e83c8('e2m_tag', array ('*tag' => $rfa816[0])), 'name' => htmlspecialchars($y1b1cc,ENT_NOQUOTES,HSC_ENC), ); } } $w3ad42=e83c8('e2m_found_rss', array ('query' => htmlspecialchars($y1b1cc,ENT_NOQUOTES,HSC_ENC))); d3010( $_strings['pt--search-results'] .': '. htmlspecialchars($y1b1cc,ENT_NOQUOTES,HSC_ENC),$w3ad42 ); $m4dd42=t163d(' ',$parameters['query']); $pfce9c=new PorterStemmerRussian(); foreach ($m4dd42 as $d8ce4b => $w9e366){ $m4dd42[$d8ce4b]=$pfce9c -> stemWord($m4dd42[$d8ce4b]); } $y8e830=array(); if(SEARCH_USE_ROSE){ try { $dddece=d476c(); $w5b9bd=new Finder($dddece,$pfce9c); $w5b9bd -> setHighlightTemplate('<mark>%s</mark>'); $pf7de9=new Query($y1b1cc); $pf7de9 -> setLimit(SEARCH_LIMIT); $resultSet=$w5b9bd -> find($pf7de9); foreach($resultSet -> getFoundExternalIds() as $g0e684){ if ($g0e684[0]=='n'){ $v21158=substr($g0e684,1); $waad65=c4627($v21158); if ($waad65['IsFavourite']) { $resultSet->setRelevanceRatio($g0e684, @$_config['search_favourites_boost']); } } } $snippetBuilder=new SnippetBuilder($pfce9c); $snippetBuilder -> setSnippetLineSeparator(' · '); $snippetBuilder -> attachSnippets($resultSet, function (array $abf516){ $result=array(); foreach(array_slice($abf516,0,SEARCH_SNIPPETS_LIMIT) as $g0e684){ if ($g0e684[0]=='n'){ $v21158=substr($g0e684,1); $e39a37=c4627($v21158); $e39a37['_']['_id']=$v21158; $waad65=m6791($e39a37); $result[$g0e684]=$waad65['text']; } } return$result; }); foreach($resultSet -> getItems() as $g0e684 => $y447b7){ if ($g0e684[0]=='n'){ $v21158=substr($g0e684,1); $waad65=c4627($v21158); $waad65['_']['_id']=$v21158; $waad65['_']['_srprovider']='rose'; $waad65['_']['_rose_relevance']=$y447b7 -> getRelevance(); $waad65['_']['_rose_title']=$y447b7 -> getHighlightedTitle($pfce9c); $waad65['_']['_rose_snippet']=$y447b7 -> getSnippet(); if ($waad65['IsPublished'] and ($waad65['IsVisible'] or he852())) { $y8e830[] = $waad65; } } } if($_config['rose_debug_info']) { $d1e441=print_r($resultSet -> getTrace(),true); } } catch (EmptyIndexException $e){} } if(1 and SEARCH_USE_MYSQL){ $a36a38=e7928(preg_quote($y1b1cc)); $teb31b=( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND MATCH (`Title`, `Text`) AGAINST ('". $a36a38 ."')". $kf79b1 ." ". "LIMIT ". SEARCH_LIMIT ); if (l0738($teb31b)) { $result=i0d6b(); foreach($result as $d8ce4b => $waad65){ $waad65['_']['_id']=$waad65['ID']; $waad65['_']['_srprovider']='mysql'; $y8e830[] = $waad65; } } } $tfbdf2=array(); $m4358b=array(); $y865c0=0; foreach ($y8e830 as $e39a37){ if (!in_array($e39a37['ID'],$tfbdf2)) { $waad65=m6791($e39a37); if (@$waad65['_']['_rose_title']) { $waad65['title']=$waad65['_']['_rose_title']; } else { $waad65['title']=n4c2d($waad65['title'],$m4dd42); } if (@$waad65['_']['_rose_snippet']) { $waad65['text']='<p>'. $waad65['_']['_rose_snippet'] .'</p>'; } else { $j1cb25=$waad65['text']; $j1cb25=preg_replace('/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/i','',$j1cb25); $j1cb25=preg_replace('/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/i','',$j1cb25); $j1cb25=str_replace( array ( '<br>', '<br/>', '<br />', '</h1>', '</h2>', '</h3>', '</h4>', '</h5>', '</h6>', '</p>', '</pre>', '</blockquote>', '</li>', ), ' ', $j1cb25 ); $j1cb25=strip_tags($j1cb25); $rad7ba=array(); $d9cc49=preg_split('/[\\n\(\)\[\]]|[.:;?!](\s|$)/uis',$j1cb25); $x363b1=0; $v02db3=''; foreach ($d9cc49 as $ud866f){ $ud866f=trim($ud866f); if (!$ud866f) continue; if (!$v02db3)$v02db3=$ud866f; $k870c2=$ud866f; $k870c2=n4c2d($k870c2,$m4dd42); if ($k870c2!=$ud866f){ $rad7ba[] = s48d8($k870c2); $x363b1 ++; if ($x363b1 > 3) break; } } if(count($rad7ba)) { $waad65['text']='<p>'. implode(' · ',$rad7ba) .'</p>'; } else { $waad65['text']='<p>'. $v02db3 .'</p>'; } } $waad65['has-highlighed-thumbs?']=false; if ($i55b55=@$waad65['format-info']['resources-detected']) { $t750fa=v2e82($i55b55); foreach ($t750fa as $d8ce4b => $w9e366){ $t750fa[$d8ce4b]['highlighted?'] = ( strstr($w9e366['original-filename'],$y1b1cc)!==false ); if ($t750fa[$d8ce4b]['highlighted?']) { $waad65['has-highlighted-thumbs?']=true; } } $waad65['thumbs']=$t750fa; } $m4358b[] = $waad65; $tfbdf2[] = $e39a37['ID']; $y865c0 ++; if ($y865c0 >= SEARCH_LIMIT) break; } } $ofbb44=count($m4358b); if ($ofbb44){ $r5cde2=e2l_get_string( 'pt--n-posts', array ('number' => $ofbb44) ); } else { $r5cde2=$_strings['pt--no-posts']; $a2cb9d['nothing']=$_strings['gs--nothing-found']; } if ($y865c0 >= SEARCH_LIMIT){ $r5cde2=$_strings['gs--many-posts']; } if ($k11128){ $a2cb9d['search-related-tag']=$k11128; } $a2cb9d['notes']=$m4358b; $a2cb9d['pages'] = array (); $a2cb9d['title']=$r5cde2 .' '. $_strings['gs--found-for-query'] .': '. htmlspecialchars($y1b1cc,ENT_NOQUOTES,HSC_ENC); $a2cb9d['superheading']=$r5cde2 .' '. $_strings['gs--found-for-query']; $a2cb9d['heading']=$y1b1cc; $a2cb9d['related-rss-href']=$w3ad42; if (@$d1e441){ $a2cb9d['rose-debug-info']=$d1e441; } return $a2cb9d; } function e2s_search(){ $y1b1cc=@$_POST['query']; $y1b1cc=str_replace('?',urlencode('?'),$y1b1cc); $y1b1cc=str_replace('/',' ',$y1b1cc); $y1b1cc=trim($y1b1cc); $y1b1cc=str_replace(' ','+',$y1b1cc); e2_go_to(e83c8('e2m_found', array ('query' => $y1b1cc))); die; } function e2s_bsi_status(){ global$_db,$_config; echo '<pre>'; echo '/@bsi/step/ — Make one step of indexing<br />'; echo '/@bsi/drop/ — Drop indexes<br /><br />'; $se1fab=@unserialize(file_get_contents(USER_FOLDER.'indexing.psa')); if (!is_array($se1fab))$se1fab=array ('spent' => '?'); if (v0f7c() and $_db['link']) { $p34421=$be0d69='?'; if (l0738( "SELECT count(*) c FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 " )) { $e9b207=i0d6b(); $p34421=$e9b207[0]['c']; } if (l0738( "SELECT count(*) c FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsIndexed`=1 AND `IsPublished`=1 " )) { $e9b207=i0d6b(); $be0d69=$e9b207[0]['c']; } $md1647=round($be0d69/$p34421*100); echo 'Indexed '. $be0d69 .' notes of '. $p34421 .' ('. $md1647 .'%)<br />'; echo 'Spent '. $se1fab['spent'] .' s (or more)'; } else { echo 'DB unaccessible'; } die ('</pre>'); } function e2s_bsi_step(){ global$_db,$_config,$_strings; if (!l3b97()) { die ('Not indexing</pre>'); } $se1fab=@unserialize(file_get_contents(USER_FOLDER.'indexing.psa')); if (!is_array($se1fab))$se1fab=array ('spent' => '?'); if ( !isset ($se1fab['lock']) or $se1fab['lock'] < time() - (BSI_GIVE_UP_TIMEOUT+BSI_UNLOCK_TIMEOUT) ) { if (isset ($se1fab['lock'])) { echo 'Old lock: '. $se1fab['lock'] .'<br />'; } else { echo 'No old lock<br />'; } $se1fab['lock']=time(); if (!@d6e52(USER_FOLDER.'indexing.psa',serialize($se1fab))) { echo 'Can’t get a new lock<br />'; die; } echo 'New lock: '. $se1fab['lock'] .'<br /><br />'; if (v0f7c() and $_db['link']) { $y865c0=0; $j680a2=0; $ece2fc=u7f78(); $a30d94=false; while ($j680a2 < BSI_GIVE_UP_TIMEOUT){ if (l0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsIndexed`=0 AND `IsPublished`=1 ". "ORDER BY `Stamp` DESC ". "LIMIT ". BSI_SELECT_PORTION )) { $e9b207=i0d6b(); } if(count($e9b207)) { echo 'Portion '. ++$y865c0 .'<br />'; foreach ($e9b207 as $rea59a){ echo 'Indexing: '. $rea59a['Title'] .'<br />'; $rea59a['IsIndexed']='1'; if (waa79('Notes',$rea59a)) { hd2e1($rea59a); } } $j680a2=round(u7f78()-$ece2fc,3); echo 'Done '. count($e9b207) .', spent '. $j680a2 .' ms so far<br /><br />'; } else { $a30d94=true; break; } } if ($a30d94){ echo 'Indexing done<br /><br />'; @unlink(USER_FOLDER.'indexing.psa'); } else { echo 'Time out<br />'; unset ($se1fab['lock']); $se1fab['done']=count($e9b207); if ($se1fab['spent']!='?')$se1fab['spent']+=$j680a2; @d6e52(USER_FOLDER.'indexing.psa',serialize($se1fab)); } } else { echo 'DB unaccessible<br />'; } } else { echo 'Locked<br />'; } die ('</pre>'); } function e2s_bsi_drop(){ global$_db,$_config; if (v0f7c() and $_db['link']) { echo '<pre>'; if (za521()) { echo 'All notes marked for reindexing<br />'; $dddece=d476c(); $dddece -> erase(); echo 'Indexes dropped<br />'; } else { echo 'DB error: '. mysqli_error($_db['link']).'<br />'; } c198f(); die ('</pre>'); } die ('<pre>DB unaccessible</pre>'); } define('BSI_SELECT_PORTION',10); define('BSI_GIVE_UP_TIMEOUT',10); define('BSI_UNLOCK_TIMEOUT',10); function c198f(){ $se1fab=array(); @d6e52(USER_FOLDER.'indexing.psa',serialize($se1fab)); } function l3b97(){ return (is_file(USER_FOLDER.'indexing.psa')); } function hd2e1($e39a37){ static $jf4540=null; try { if ($jf4540===null){ $pfce9c=new PorterStemmerRussian(); $jf4540=new Indexer(d476c(),$pfce9c); } $l2bfe4=z154e($e39a37['FormatterID'], @$e39a37['Text'],'full-rss'); efc4d($e39a37,$l2bfe4); $j1cb25=strip_tags($l2bfe4['text-final']); $t3e961=new Indexable( 'n'. $e39a37['ID'], $e39a37['Title'], $j1cb25 ); return $jf4540 -> index($t3e961); } catch (Exception $e){ return false; } } function a10fe($cb80bb){ static $jf4540=null; try { if ($jf4540===null){ $pfce9c=new PorterStemmerRussian(); $jf4540=new Indexer(d476c(),$pfce9c); } return $jf4540 -> removeById('n'. $cb80bb); } catch (Exception $e){ return false; } } function o713e($ra2f2e){ $g851f5='S2\\Rose\\'; $m32fcc=__DIR__.'/library/rose/'; $hf5a8e=strlen($g851f5); if(strncmp($g851f5,$ra2f2e,$hf5a8e)!==0) return; $ge1cb9=substr($ra2f2e,$hf5a8e); $j8c7dd=$m32fcc.str_replace('\\','/',$ge1cb9).'.php'; if(file_exists($j8c7dd)) require $j8c7dd; } function d476c(){ global$_config,$settings; static $s88131=null; if ($s88131===null){ $acf66e=new \PDO( 'mysql:'. 'host='. $settings['db']['server'] .';'. 'dbname='. $settings['db']['name']. ';'. 'charset=utf8', $settings['db']['user_name'], qee85($settings['db']['passw']) ); $acf66e -> setAttribute(\PDO::ATTR_ERRMODE, \PDO::ERRMODE_EXCEPTION); $s88131=new PdoStorage( $acf66e, $_config['db_table_prefix'].SEARCH_EXTRA_PREFIX, array ( PdoStorage::TOC => 'Contents', PdoStorage::WORD => 'Word', PdoStorage::FULLTEXT_INDEX => 'Fulltext', PdoStorage::KEYWORD_INDEX => 'Keyword', PdoStorage::KEYWORD_MULTIPLE_INDEX => 'KeywordMultiple', ) ); } return $s88131; } function n4c2d($j1cb25,$m4dd42){ foreach ($m4dd42 as $e2510c){ if ($e2510c=='-') continue; $e2510c=preg_quote($e2510c,'/'); $e2510c=str_replace('е','[её]',$e2510c); $e2510c=str_replace('Е','[ЕЁ]',$e2510c); $j1cb25=preg_replace('/(?<=^|\W)('.$e2510c.'[\w\p{M}]*)/iu','<mark>$1</mark>',$j1cb25); } $j1cb25=str_replace('</mark> <mark>',' ',$j1cb25); $j1cb25=str_replace('</mark> <mark>',' ',$j1cb25); return $j1cb25; } function s48d8($i341be){ $me05fe=mb_strtoupper(mb_substr($i341be,0,1)); return $me05fe.mb_substr($i341be,1); } function za521(){ global$_config; return l0738( "UPDATE `". $_config['db_table_prefix']."Notes` ". "SET `IsIndexed`=0" ); } function e2_check_timeout(){ static $w90272; if(is_null($w90272)) { $ff48ef=ini_get('max_execution_time'); if ($ff48ef){ $w90272=time()+$ff48ef-5; } else { $w90272=0; } } return ($w90272==0)?true:$w90272 >= time(); } function e2_write_dump_header($j8c7dd){ $l099fb=( 'SET SQL_MODE="NO_AUTO_VALUE_ON_ZERO";' .PHP_EOL. 'SET AUTOCOMMIT=0;' .PHP_EOL. 'START TRANSACTION;' .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;" .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;" .PHP_EOL. "/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;" .PHP_EOL. "/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;" .PHP_EOL. "/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;" .PHP_EOL. "/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=NO_AUTO_VALUE_ON_ZERO */;" .PHP_EOL. "/*!40101 SET NAMES utf8 */;" .PHP_EOL. '' ); fwrite($j8c7dd,$l099fb); return true; } function e2_write_dump_footer($j8c7dd){ $g251d1='COMMIT;' .PHP_EOL; $g251d1 .= "/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;" .PHP_EOL ."/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;" .PHP_EOL ."/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;" .PHP_EOL ."/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;".PHP_EOL ."/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;" .PHP_EOL ."/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;" .PHP_EOL; fwrite($j8c7dd,$g251d1); return true; } function e2_get_table_definition($v0c1d0,$gaab9e){ $n5c286=null; $result=mysqli_query($v0c1d0,"SHOW CREATE TABLE `{$gaab9e}`"); if($result){ $z47c80=mysqli_fetch_array($result); $n5c286=$z47c80['Create Table']; } return $n5c286; } function e2_write_table_definition($j8c7dd,$v0c1d0,$gaab9e){ $y30618=e2_get_table_definition($v0c1d0,$gaab9e); if(e2_check_timeout() && $y30618){ fwrite($j8c7dd,$y30618); fwrite($j8c7dd,';'); fwrite($j8c7dd,PHP_EOL.PHP_EOL); return true; } return false; } function e2_get_table_data($v0c1d0,$gaab9e,$o7a86c,$jaa9f7){ $y1b1cc="SELECT * FROM `{$gaab9e}` LIMIT {$o7a86c}, {$jaa9f7}"; $result=mysqli_query($v0c1d0,$y1b1cc); if (!$result){ return false; } $i66e9c=''; $w3c41a="INSERT INTO `{$gaab9e}` VALUES"; while ($ff1965=mysqli_fetch_assoc($result)) { $k691d5=array(); foreach($ff1965 as $n2063c){ $k691d5[] = is_null($n2063c)?"NULL":"'".mysqli_real_escape_string($v0c1d0,$n2063c)."'"; } $i66e9c.=$w3c41a.'('.join(', ',$k691d5).');'.PHP_EOL; } return $i66e9c; } function e2_table_disable_keys($gaab9e){ return "ALTER TABLE `{$gaab9e}` DISABLE KEYS;".PHP_EOL; } function e2_table_enable_keys($gaab9e){ return "ALTER TABLE `{$gaab9e}` ENABLE KEYS;".PHP_EOL; } function e2_get_total_records($v0c1d0,$gaab9e){ $d8ce4b=mysqli_fetch_row(mysqli_query($v0c1d0,"SELECT COUNT(*) FROM `{$gaab9e}`")); return $d8ce4b[0]; } function e2_write_table_data($j8c7dd,$v0c1d0,$gaab9e){ $ofbb44=e2_get_total_records($v0c1d0,$gaab9e); $o7a86c=0; $jaa9f7=1000; $result=true; $z47495=20000; $r80fc1=30; if ($ofbb44){ $bfbda5=e2_table_disable_keys($gaab9e); fwrite($j8c7dd,$bfbda5); } $i66e9c="INSERT INTO `{$gaab9e}` VALUES"; $zde57a=$ofbb44; while ($zde57a > 0){ $y1b1cc="SELECT * FROM `{$gaab9e}` LIMIT {$o7a86c}, {$jaa9f7}"; $result=mysqli_query($v0c1d0,$y1b1cc); $ob428d=mysqli_num_rows($result); if (!$result || !e2_check_timeout()) { $result=false; break; } $rdf347=array(); $b4b3a6=0; $nb6539=0; while ($ff1965=mysqli_fetch_assoc($result)) { if (!e2_check_timeout()) { $result=false; break; } $ob428d--; $p54ca8=array(); foreach($ff1965 as $n2063c){ $p54ca8[] = is_null($n2063c)?"NULL":"'".mysqli_real_escape_string($v0c1d0,$n2063c)."'"; } $n8d777='('.join(', ',$p54ca8).')'; $b4b3a6+=strlen($n8d777); $rdf347[] = $n8d777; $nb6539++; if ( ($b4b3a6 >= $z47495) || ($nb6539 >= $r80fc1) || ($ob428d==0)) { $y1b1cc=$i66e9c.join(', ',$rdf347).';'; fwrite($j8c7dd,$y1b1cc); fwrite($j8c7dd,PHP_EOL); $b4b3a6=0; $nb6539=0; $rdf347=array(); } } $o7a86c+=$jaa9f7; $zde57a -= $jaa9f7; } if ($ofbb44){ $l6bfc4=e2_table_enable_keys($gaab9e); fwrite($j8c7dd,$l6bfc4); } return$result; } function e2_backup($v0c1d0,$u9ab2e,$pa9745,$p93da6=array()) { mysqli_query($v0c1d0,"SET NAMES utf8"); $x2beda=tmpfile(); e2_write_dump_header($x2beda); if(__LOG)__log('DB Backup: wrote header'); $b75101=true; foreach($u9ab2e as $gaab9e){ if(__LOG)__log('DB Backup: table '. $gaab9e); $r91e7e=e2_write_table_definition($x2beda,$v0c1d0,$gaab9e); if(__LOG)__log('DB Backup: wrote table definition with result '. (int)$r91e7e); $d35285=e2_write_table_data($x2beda,$v0c1d0,$gaab9e); if(__LOG)__log('DB Backup: wrote table data with result '. (int)$d35285); $b75101=$r91e7e && $d35285; if ($b75101===false){ break; } } if(__LOG)__log('DB Backup: wrote data with running == '. (int)$b75101); if ($b75101){ e2_write_dump_footer($x2beda); fseek($x2beda,0); $j8c7dd=fopen($pa9745,'w+'); while ($b75101 && ($n8d777=fread($x2beda,1024))) { if(e2_check_timeout()) { fwrite($j8c7dd,$n8d777); } else { $b75101=false; } } fclose($j8c7dd); } fclose($x2beda); return $b75101; } function g3e5c($x0c426,$content){ $a52766=MTMPL_FOLDER.$x0c426 .'.mtmpl.php'; if(is_file($a52766)) { ob_start(); include $a52766; $gde7a3=ob_get_contents(); ob_end_clean(); return trim($gde7a3); } } function daed2(){ global$_config; $x9e35a=$_config['mail_from']; if ($x9e35a[strlen($x9e35a)-1]=='@'){ $x9e35a.=$_SERVER['HTTP_HOST']; } return $x9e35a; } function va41b($e01b6e,$subject,$u78e73,$s145a2=''){ global $r57de2; if ($r57de2==DEV_HOST){ $c8fa14=tempnam('mail-debug',''); $j1cb25=( 'To:       '.$e01b6e."\n". 'Subject:  '.$subject."\n". "--------------------------------------------------\n". $u78e73 ); d6e52($c8fa14,$j1cb25); chmod($c8fa14,NEW_FILES_RIGHTS); rename($c8fa14,$c8fa14.'.txt'); } else { $subject='=?UTF-8?B?'. base64_encode($subject) .'?='; $s145a2.="\r\nContent-Type: text/plain; charset=utf-8"; mail($e01b6e,$subject,$u78e73,trim($s145a2)); } } function _A($j1cb25){ global$_candy,$_protocol,$r57de2,$aa57c1,$_current_url; if ( preg_match('/\<a href\=\"(.*?)\"[^>]*\>(.*?)\<\/a\>/si',$j1cb25,$u9c28d) and ( $u9c28d[1]=='' or $u9c28d[1]==$_current_url or $_protocol .'://'. $r57de2.$u9c28d[1]==$_current_url or $_protocol .'://'. $r57de2.$aa57c1 .'/'. $u9c28d[1]==$_current_url or $_candy=='e2m_install' ) ) { return $u9c28d[2]; } else { return $j1cb25; } } function _AT($ee8fab){ global$_candy,$r57de2,$aa57c1,$_current_url; return ( $ee8fab=='' or $ee8fab==$_current_url or $_protocol .'://'. $r57de2.$ee8fab==$_current_url or $_protocol .'://'. $r57de2.$aa57c1 .'/'. $ee8fab==$_current_url ); } function _IMGSRC($v435ed){ return i1492($v435ed); } function _SVG($v435ed){ return gf42c($v435ed); } function _COLOR($vf97c5,$vb8a9f,$jcc321,$a4efa2=1){ if(strlen($vf97c5)!=3 and strlen($vf97c5)!=6) return 'f0f'; if(strlen($vb8a9f)!=3 and strlen($vb8a9f)!=6) return 'f0f'; if(strlen($vf97c5)==3)$vf97c5=$vf97c5{0}.$vf97c5{0}.$vf97c5{1}.$vf97c5{1}.$vf97c5{2}.$vf97c5{2}; if(strlen($vb8a9f)==3)$vb8a9f=$vb8a9f{0}.$vb8a9f{0}.$vb8a9f{1}.$vb8a9f{1}.$vb8a9f{2}.$vb8a9f{2}; $gf09cc=array ( $vf97c5{0}.$vf97c5{1}, $vf97c5{2}.$vf97c5{3}, $vf97c5{4}.$vf97c5{5}, $vb8a9f{0}.$vb8a9f{1}, $vb8a9f{2}.$vb8a9f{3}, $vb8a9f{4}.$vb8a9f{5}, ); foreach ($gf09cc as $d8ce4b => $w9e366){ $gf09cc[$d8ce4b]=hexdec($w9e366); } $q22af6=array ( $gf09cc[0]+pow($jcc321,$a4efa2) * ($gf09cc[3]-$gf09cc[0]), $gf09cc[1]+pow($jcc321,$a4efa2) * ($gf09cc[4]-$gf09cc[1]), $gf09cc[2]+pow($jcc321,$a4efa2) * ($gf09cc[5]-$gf09cc[2]), ); $k70dda=''; foreach ($q22af6 as $d8ce4b => $w9e366){ $k70dda.=str_pad(dechex($w9e366),2,'0',STR_PAD_LEFT); } return $k70dda; } function _DT($i1ddcb,$cb35c6){ if (!$cb35c6) return ''; list ($o96b8c,$xb2c6c)=$cb35c6; $a2cb9d=$i1ddcb; $x7436f=g5a2f('m',$o96b8c,$xb2c6c); $a2cb9d=str_replace('{zone}',e2__escape_all(c9515($xb2c6c['offset'])), $a2cb9d); $a2cb9d=str_replace('{month}',e2__escape_all(e2l_get_string('um--month', array ('month' => $x7436f))), $a2cb9d); $a2cb9d=str_replace('{month-short}',e2__escape_all(e2l_get_string('um--month-short', array ('month' => $x7436f))), $a2cb9d); $a2cb9d=str_replace('{month-g}',e2__escape_all(e2l_get_string('um--month-g', array ('month' => $x7436f))), $a2cb9d); $a2cb9d=g5a2f($a2cb9d,$o96b8c,$xb2c6c); return $a2cb9d; } function _AGO($cb35c6){ return t7a0b($cb35c6[0], array ('offset' => $cb35c6[1]['offset'],'is_dst' => $cb35c6[1]['is_dst']) ); } function _NUM($j1cb25){ return e2_decline_for_number($j1cb25); } function _SIZE($size,$o3e34b=_SIZE_AUTO){ return e2_format_size($size,$o3e34b); } function _FIRST($a437b9){ return ($a437b9['_']['_ord']==0); } function _LAST($a437b9){ return ($a437b9['_']['_ord']==$a437b9['_']['_ord_max']); } function _CSS($yc7a62){ return vd4c1($yc7a62); } function _CSS_HREF($yc7a62){ return p576f($yc7a62); } function _JS($b32981){ return wd00a($b32981); } function _LIB($be8acc){ return i16f0($be8acc); } function _T($n52678){ return z166b($n52678); } function _X($n52678){ return d6a97($n52678); } function _T_FOR($n52678,$xd5566=null){ global$content; if ($xd5566===null)$xd5566=$n52678; if(array_key_exists($xd5566,$content)) { z166b($n52678); } else { return ''; } } function _GUIDES($reca07=false){ global$_olba_guides; if(is_array($reca07))$_olba_guides=$reca07; if (!is_array($_olba_guides)) return; $l88408='<div style="position: fixed; width: 100%; height: 100%; z-index: -100">'; $b1d623=0; $q07d43=$_olba_guides; $q07d43[] = 100; foreach ($q07d43 as $y865c0 => $fd89e2){ if ($fd89e2==100) break; $b1d623+=$fd89e2; $l88408.='<div style="position: fixed; left: '. $fd89e2 .'%; width: 0; height: 100%; border-left: 1px #000 dotted; opacity: .2; -webkit-opacity: .2; -moz-opacity: .2"></div>'; $ha1b01='position: absolute; padding: 2px 3px; top: 0; font-size: 9px; background: #ccc; color: #000; font-family: "Verdana", sans-serif; opacity: .8; -webkit-opacity: .8; -moz-opacity: .8'; if ($q07d43[$y865c0+1]-$q07d43[$y865c0] < 4){ $l88408.='<div style="'. $ha1b01.'; right: '. (100-$fd89e2) .'%; border-bottom-left-radius: .5em; -webkit-border-bottom-left-radius: .5em; -moz-border-bottom-left-radius: .5em;">'. $fd89e2 .'%</div>'; } else { $l88408.='<div style="'. $ha1b01.'; left: '. $fd89e2 .'%; border-bottom-right-radius: .5em; -webkit-border-bottom-right-radius: .5em; -moz-border-bottom-right-radius: .5em;">'. $fd89e2 .'%</div>'; } } $l88408.='</div>'; $_olba_current_col=0; return $l88408; } function _S($vb45cf){ global$_strings; return$_strings[$vb45cf]; } function _SHORTCUT($db0689){ return hbb8d($db0689); } function e2__escape_all($vb45cf){ $a2cb9d=''; for ($y865c0=0; $y865c0 <= mb_strlen($vb45cf); ++ $y865c0){ $a2cb9d.='\\'. mb_substr($vb45cf,$y865c0,1); } return $a2cb9d; } function e2l_get_string($ffa206,$n8d777){ global$_strings; $db0689=$_strings[$ffa206]; if(preg_match_all('/\$\[(.+?)\]/u',$db0689,$u9c28d,PREG_SET_ORDER)) { foreach ($u9c28d as $xe3cc9){ $tb2145=$xe3cc9[1]; $wf2ffc=''; if(strstr($tb2145,'.')) list ($tb2145,$wf2ffc)=explode('.',$tb2145,2); if(array_key_exists($tb2145,$n8d777)) { if ($wf2ffc){ $db0689=str_replace($xe3cc9[0],e2l__format_value($wf2ffc,$n8d777[$tb2145],$ffa206),$db0689); } else { $db0689=str_replace($xe3cc9[0],$n8d777[$tb2145],$db0689); } } } } return $db0689; } function e2l_transliterate($vb45cf){ $ze358e=array(); if(is_file(DEFAULTS_FOLDER.'translit.txt')) { $ze358e=file(DEFAULTS_FOLDER.'translit.txt'); } $md98a0=$e01b6e=''; foreach ($ze358e as $y865c0 => $x6438c){ if (!($y865c0%2))$md98a0.=rtrim($x6438c) .' '; else $e01b6e.=rtrim($x6438c) .' '; if ($y865c0%2){ while (mb_strlen($e01b6e) < mb_strlen($md98a0))$e01b6e.=' '; while (mb_strlen($e01b6e) > mb_strlen($md98a0))$md98a0.=' '; } } $g60ae1=''; $qde2e7=-1; for ($y865c0=0; $y865c0 < mb_strlen($md98a0); ++ $y865c0){ $k4a8a0=mb_substr($md98a0,$y865c0,1); if ($k4a8a0!=' '){ $g60ae1.=$k4a8a0; if ($qde2e7 == -1)$qde2e7=$y865c0; } elseif ($g60ae1){ $c52ac1=trim(mb_substr($e01b6e,$qde2e7,mb_strpos($e01b6e,' ',$qde2e7+1)-$qde2e7)); $h33c9b=array ($g60ae1,$c52ac1); $uce83f[mb_strlen($g60ae1)][] = $h33c9b; $g60ae1=''; $qde2e7=-1; } } $k1d78d=array(); for ($y865c0=count($uce83f); $y865c0 > 0; -- $y865c0){ foreach ($uce83f[$y865c0] as $h33c9b)$k1d78d[$h33c9b[0]] = $h33c9b[1]; } return strtr($vb45cf,$k1d78d); } function e2l__format_value($wf2ffc,$n2063c,$ffa206){ list ($wf2ffc,$v3ad73)=explode('.',$wf2ffc,2); $ve6875='e2lstr_'. $wf2ffc; if(function_exists($ve6875)) { return call_user_func($ve6875,$n2063c,$v3ad73,$ffa206); } else { return $n2063c; } return $n2063c; } spl_autoload_register(o713e); if($_config['write_log_reset'])__log(null); if(__LOG)__log('System: loaded'); if(is_file($w2d354=LANGUAGES_FOLDER.$settings['language'] .'.php')) { $_lang=$settings['language']; include $w2d354; } elseif(is_file($w2d354=LANGUAGES_FOLDER.DEFAULT_LANGUAGE .'.php')) { $_lang=DEFAULT_LANGUAGE; include $w2d354; } else { die ('Language file missing: '. $w2d354); } $_strings=e2l_load_strings(); if(!$t589b3) @include 'builder.php'; function e2(){ global $r57de2,$settings,$errors,$content, $aa57c1,$full_blog_url,$stopwatch,$n11755, $_current_url, $_newsfeeds, $_instance, $_candy, $_config, $_route, $_strings, $_lang, $_candies_installer, $_candies_public, $_candies_indexable, $_candies_indexable_conditionally, $_candies_ajax, $_user_folder_name, $_olba_includes, $_diagnose; r269a(); if(__LOG)__log('System: go'); $errors=array(); header('Content-type: text/html; charset='. OUTPUT_CHARSET); $_instance=false; if (@is_file(USER_FOLDER.'instance.psa')) { $f0d149=@file_get_contents(USER_FOLDER.'instance.psa') or $f0d149=false; if ($f0d149){ $f0d149=@unserialize($f0d149) or $f0d149=false; if ($f0d149){ $_instance=$f0d149; } } } $v66f61=@$settings['template'] or $v66f61=DEFAULT_TEMPLATE; w4e27($v66f61); $a572d4=urldecode($_GET['go']); if(__LOG)__log('System: Resolve <'. $a572d4 .'> {'); l7059(); list ($zc48ba,$parameters)=jb7e9($a572d4); foreach($_GET as $c3c6e0 => $n2063c){ $parameters[$c3c6e0]=$n2063c; } if(__LOG)__log('} // Resolve'); if(__LOG)__log( 'System: Candy <'. $zc48ba .'> {' ); if(__LOG)__log('Parameters: <'. print_r($parameters,true).'>'); $_candy=$zc48ba; if ( @$_config['debug_slow_ajax'] and ( in_array($zc48ba,$_candies_ajax) ) ) { sleep(1+2 * (rand()/getrandmax())); } if (!in_array($zc48ba,$_candies_installer)) { e2_make_sure_that_installed(); } $q58387=(bool)he852(); $k0b448=!in_array($zc48ba,$_candies_public); $y49ecc=$k0b448 && !$q58387; if(__LOG)__log('System: signed in? '. (int)$q58387); $sc1f6f=array ( 'done?' => $q58387, 'required?' => $k0b448, 'necessary?' => $y49ecc, ); $_newsfeeds=false; d3010( htmlspecialchars(p6f51(),ENT_NOQUOTES,HSC_ENC), e83c8('e2m_frontpage_rss') ); if(is_callable($zc48ba)) { if ($y49ecc){ if(substr($zc48ba,0,4)=='e2s_'){ $content=call_user_func('e2s_sign_in_necessary'); } else { $content['title']=$_strings['pt--sign-in']; } } else { if(__LOG)__log('System: candy call'); $content=call_user_func($zc48ba,$parameters); if(__LOG)__log('System: candy return'); } } else { $sc1f6f['required?']=false; $sc1f6f['necessary?']=false; $content=e2_error404_mode(); } if(__LOG)__log('} // Candy'); if (!array_key_exists('notes',$content))$content['notes'] = array (); if (!array_key_exists('drafts',$content))$content['drafts'] = array (); if (!array_key_exists('comments',$content))$content['comments'] = array (); if (!array_key_exists('notes-list',$content))$content['notes-list'] = array (); if (!array_key_exists('tags',$content))$content['tags'] = array (); $content['class']=str_replace('_','-',str_replace('e2m_','',$zc48ba)); $content['sign-in']=$sc1f6f; $content['sign-in-prompt']=$_strings['gs--need-password']; if(e2_is_installed()) { if(__LOG)__log('System: nav and pages'); $content['navigation-links'] = array (array ( 'rel' => 'index', 'href' => e83c8('e2m_frontpage', array ('page' => 1)), 'id' => 'link-index', )); if(array_key_exists('pages',$content)) { foreach (array ('prev','next','earlier','later') as $hc47d1){ if(array_key_exists($hc47d1 .'-href',$content['pages'])) { $q7ffc4=$hc47d1; if ($hc47d1=='earlier')$q7ffc4='prev'; if ($hc47d1=='later')$q7ffc4='next'; $content['navigation-links'][] = array ( 'rel' => $q7ffc4, 'href' => $content['pages'][$hc47d1 .'-href'], 'id' => 'link-'. $hc47d1, ); } } } if(__LOG)__log('System: search form'); if(array_key_exists('query',$parameters)) { $y1b1cc=trim($parameters['query']); } else { $y1b1cc=''; } $content['search'] = array ( 'form-action' => e83c8('e2s_search'), 'query' => htmlspecialchars(@$y1b1cc,ENT_COMPAT,HSC_ENC), ); if(__LOG)__log('System: blog information'); $content['blog']['author']=htmlspecialchars(c2640(),ENT_NOQUOTES,HSC_ENC); if(array_key_exists('description',$settings)) { $l2bfe4=tb7f1($settings['description'],'full'); $f67daf=$l2bfe4['text-final']; $content['blog']['description']=$f67daf; $content['blog']['description-format-info']=$l2bfe4['meta']; } $content['blog']['title']=htmlspecialchars(p6f51(),ENT_NOQUOTES,HSC_ENC); $content['blog']['userpic-set?']=false; if($content['blog']['userpic-href']=j2461()) { $content['blog']['userpic-set?']=true; } else { $content['blog']['userpic-href']=DEFAULT_USERPIC_FILENAME; if (he852()) { $content['blog']['userpic-href']=DEFAULT_USERPIC_PLACEHOLDER_FILENAME; } } if (he852()) { $content['blog']['userpic-upload-action']=e83c8('e2j_userpic_upload'); } $content['blog']['href']=e83c8('e2m_frontpage', array ('page' => 1)); $content['blog']['rss-href']=e83c8('e2m_frontpage_rss'); $content['blog']['language']=$_lang; $content['blog']['show-subscribe-button?']=false; if(__LOG)__log('System: edge timeinfo'); $g97bc5=array (time(),z5c05()); $q5f36b=ma846('Y',$g97bc5[0]); $content['blog']['now']=$g97bc5; $paa103=$q5f36b; $f33b09=occ02('start'); if(array_key_exists('stamp',$f33b09)) { $paa103=ma846('Y',$f33b09['stamp']); $content['blog']['start-time'] = array ((int)$f33b09['stamp'],$f33b09['timezone']); } $p40d73=(int)j8ca0(true,true); if (he852()) { if(__LOG)__log('System: stuff for logged in user'); $content['blog']['drafts-count'] = (int)j8ca0(false,true); $content['admin-hrefs'] = array ( 'new-note' => e83c8('e2m_write'), 'drafts' => e83c8('e2m_drafts'), 'settings' => e83c8('e2m_settings'), 'password' => e83c8('e2m_password'), 'database' => e83c8('e2m_database'), 'timezone' => e83c8('e2m_timezone'), 'logout' => e83c8('e2m_sign_out'), ); list ($ofe9e2,$m85ee4,$j20699)=w2a6b(); if ($ofe9e2)$content['new-comments'] = array ( 'count' => $ofe9e2, 'href' => $j20699, ); } else { if(__LOG)__log('System: login form'); $content['form-login']['form-action']=e83c8('e2s_sign_in'); $content['form-login']['form-check-password-action']=e83c8('e2j_check_password'); $content['form-login']['login-name'] = @$settings['author']; $content['form-login']['public-pc?']=false; if(array_key_exists('_login_request_message',$content)) { $content['form-login']['request']=$content['_login_request_message']; } } if (he852()) { $od0a87=(($p40d73 + (int)j8ca0(true,false)) == 0); } else { $od0a87=($p40d73==0); } if($_db_error){ $od0a87=false; } $m9fbfe=$_config['years_range_separator']? $_config['years_range_separator']:'&mdash;'; $content['blog']['years-range']=$paa103 . (($paa103==$q5f36b)? '':($m9fbfe.$q5f36b)); $content['blog']['notes-count']=$p40d73; $content['blog']['virgin?']=$od0a87; if ($aa57c1){ $content['blog']['parent-site-href']=substr($aa57c1, (int)strpos('/',$aa57c1)); } $content['hrefs'] = array ( 'sign-in' => e83c8('e2m_sign_in'), 'tags' => e83c8('e2m_tags'), 'everything' => e83c8('e2m_everything'), ); } $c1e2ad='noindex, follow'; if (@$_config['index_follow_everything']) { $c1e2ad='index, follow'; } if(in_array($zc48ba,$_candies_indexable)) { $content['robots']='index, follow'; } if(in_array($zc48ba,$_candies_indexable_conditionally)) { $content['robots']=$c1e2ad; } $content['output-charset']=OUTPUT_CHARSET; $content['base-href']=$full_blog_url. '/'; $content['current-href']=$_current_url; if (!array_key_exists('summary',$content)) { $content['summary']=strip_tags($content['blog']['description']); } $content['title']=strip_tags(m6f10(htmlspecialchars($content['title'],ENT_NOQUOTES,HSC_ENC))); if (@$content['heading']) { $content['heading']=strip_tags(m6f10(htmlspecialchars($content['heading'],ENT_NOQUOTES,HSC_ENC))); } if(__LOG)__log('System: e2_modes {'); e2_modes($parameters); if(__LOG)__log('} // e2_modes'); if (@$_config['request_logging']) { $c8fa14=fopen(USER_FOLDER. 'log-'. date('Y-m-d') .'.txt','a'); fwrite($c8fa14,date('d.m.Y H:i:s') ."\tT = ". $content['pgt'] ."\tQ = ". $content['total_queries'] ."\tIP = ". $_SERVER['REMOTE_ADDR'] ."\tRequest = ". $_SERVER['REQUEST_URI'] ."\r\n"); fclose($c8fa14); } $content['misc']['sape-link']='http://www.sape.ru/r.206a4276c2.php'; $kc8542=round(u7f78()-$stopwatch,3); $feccd7='http://'. $_strings['e2--website-host'] .'/'; $content['engine']['pgt']=str_replace('.',',',$kc8542); if(function_exists('memory_get_peak_usage')) { $content['engine']['mp']=str_replace('.',',',round((memory_get_peak_usage()/1024/1024)*100)/100); } $content['engine']['qc'] = (int) @$n11755; $content['engine']['built?']=$t589b3; $content['engine']['installed?']=e2_is_installed(); $content['engine']['version']='v'. E2_VERSION; $l68966='('. $_strings['e2--release'] .' '. E2_RELEASE .', v'. E2_VERSION .')'; $content['engine']['version-description']=$_strings['e2--vname-aegea'] .' '. $l68966; $content['engine']['user-folder-name']=$_user_folder_name; $content['engine']['cookie-prefix']=c8c3b(); $content['engine']['href']=$feccd7; $content['engine']['about']='<span title="E2 '.$l68966 .'">'. $_strings['e2--powered-by'] .' <a href="'. $feccd7 .'">'. $_strings['e2--vname-aegea'] .'</a></span>'; $content['stylesheets']=m37ca(); $content['scripts']=p4753(); if (!@isset ($_diagnose['ok?'])) { if (@$_COOKIE[c8c3b('diagnose')] or @$_diagnose['need?']) { m8739(); } } if ($se1671=jec07()) { $content['message']=$se1671; } if (he852()) { $content['last-modifieds-by-id']='{}'; if (@$_COOKIE[c8c3b('local_copies')]) { $content['last-modifieds-by-id'] = ( ra2d8($_COOKIE[c8c3b('local_copies')]) ); } } $content['og-images'] = array (); if(is_array($content['notes']['only']['og-images'])) { $content['og-images']=$content['notes']['only']['og-images']; } if(is_array($content['tag']['og-images'])) { $content['og-images']=$content['tag']['og-images']; } if (!count($content['og-images'])) { $content['og-images'] = array ($content['blog']['userpic-href']); } ob_start(); qbc21(); $r78e62=ob_get_contents(); ob_end_clean(); if(is_array($content['notes'])) { foreach($content['notes'] as $waad65){ if(is_array($waad65['format-info']['links-required'])) { foreach ($waad65['format-info']['links-required'] as $k2a304){ if(substr($k2a304, -3)=='.js'){ wd00a(substr($k2a304,0, -3)); } if(substr($k2a304, -4)=='.css'){ vd4c1(substr($k2a304,0, -4)); } } } } } $content['stylesheets']=m37ca(); $content['scripts']=p4753(); if($_newsfeeds)$content['newsfeeds']=$_newsfeeds; ob_start(); z166b('head'); $z61ef8=ob_get_contents(); ob_end_clean(); ob_start(); z166b('scripts'); $bee59b=ob_get_contents(); ob_end_clean(); $r78e62=str_replace('<e2:head-data />',$z61ef8,$r78e62); $r78e62=str_replace('<e2:scripts-data />',$bee59b,$r78e62); $ufa6a9=false; if (l3b97()) { if(is_writable(USER_FOLDER.'indexing.psa')) { $ufa6a9=true; } else { $_diagnose['need?']=true; uc64a('diagnose','1'); } } if ( $ua0856=ie655() and !$_config['ignore_missing_template_files'] ) { echo '<h1>Templates missing</h1>'; echo '<ul>'; foreach ($ua0856 as $g380ec){ echo '<li>'. $g380ec.' </li>'; } echo '</ul>'; echo '<pre>'; print_r($content); echo '</pre>'; } else { echo $r78e62; } if ($ufa6a9){ if(__LOG)__log('System: spawn BSI step'); ecc38(e83c8('e2s_bsi_step', array ())); } if(__LOG)__log('} // System'); if(DEV_TRACK_TIME and $r57de2==DEV_HOST){ $a06bc4=str_replace('.',',',round(u7f78()-$stopwatch,3)-$kc8542); echo '<div style="font-size: 300%; text-align: center; position: fixed; bottom: 0; width: 100%; background: #ffc; opacity: .88">'. '<span style="color: #f80">'. $content['engine']['pgt'] .' '. '<small>'. $content['engine']['qc'] .'q</small></span>'. '<span style="color: #08f"> + '. $a06bc4.' '. '<small>'. $_olba_includes .'i</small></span>'. '</div>'; } } if(__LOG)__log(''); ?>